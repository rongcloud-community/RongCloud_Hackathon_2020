# Together

### 简介

本作品用于实现 **在线即时** **寻找当地伴侣一起吃喝玩乐**（例如：去到陌生城市时寻找伴侣一起喝咖啡，深夜邀请伴侣一起吃火锅），**让出行不再孤单，为游玩增添惊喜**。

让我们在生活的空闲之余，可以跳出生活中朋友圈，短视频兴趣推荐的局限性，认识到更多"圈外的人"，体验更多未知。



### 使用的融云 `SDK`

融云即时通讯 `SDK`   

`Flutter Plugin`

```yaml
rongcloud_im_plugin: ^4.0.2
```



## 文件夹目录

* SNS文件夹：后端
* Together文件夹：flutter项目源码
* 真机安装包：android真机安装包



## 页面及对应功能

#### 注册页 register_page

- `没有账号?` 跳转到注册页进行注册

- 输入想要注册的账号和密码

- 账号校验规则如下：`字符长度在5-16位，只能是数字、字母和特殊符号_-的组合方式`

- 密码校验规则如下：`字符长度在6-18位，符号无特殊限制`

- 点击注册，发送账号密码到服务端，服务端响应结果

- `响应成功` 注册成功后，自动跳转至登录页，账号密码缓存本地

  ```dart
  void _saveUserInfo(String id, String token) async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    prefs.setString("id", id);
    prefs.setString("token", token);
    prefs.setString("uid", _assount.text);
    prefs.setString("password", _password.text);
  }
  ```

  

<img src="https://i.loli.net/2020/10/14/NKyjsBTRp96Qtob.jpg" alt="login_page.jpg" style="zoom: 25%;" />



#### 登录页 login_page

- `已有账号?` 输入对应的账号和密码，发送到服务端，校验通过即可登录

- `刚注册?` 缓存的账号密码已自动填入，直接点击登录校验通过即可

  

<img src="https://i.loli.net/2020/10/14/K5UMaR6yh1Zq3uT.jpg" alt="register_page.jpg" style="zoom:25%;" />



#### 推荐中心页

<img src="https://i.loli.net/2020/10/14/pXfevDl8Q57EwTd.png" alt="1602644876441.png" style="zoom:25%;" />

* 显示当前 **在线** 用户发起的 伴侣邀请
* 显示当前 **在线 **的 **寻找伴侣发起人** 距离自己的 **位置**，以及对方**发起时间** 
* 点击用户名字、头像，进入对方个人中心，浏览对方发过的动态
* 点击界面右上角纸飞机按钮 **发起伴侣寻找 / 个人动态**
* 点击每个 **寻找伴侣** 动态右下方的 **开启对话**按钮 ，可以直接向对方发起即时通讯
* 下拉可以 **刷新** 当前在线用户



#### 发布动态页

<img src="https://i.loli.net/2020/10/14/Ru2OLfMiX7sSVlh.png" alt="1602590521243.png" style="zoom:25%;" />

* 页面中有文本输入框，可输入动态内容，并且**支持各种表情内容**
* 文本输入框左下方有 “looking for mates” 开关，**开启状态** 表示想要寻找伴侣，希望其他用户在推荐中心看到此条动态。**关闭状态** 表示此动态属于个人动态，仅会在个人中心中看到。
* 点击左上方 **发布** 按钮，即可发布内容到 **推荐中心 / 个人中心**，并且带有当前位置信息，可以让其他用户知道你们的相距距离



#### 消息列表页 conversation_list

- 发过信息的用户都会被存储到本地，渲染在列表页
- 列表展示信息有：头像、昵称、最后一条信息内容/类型和最后发送时间
- 单击后即可进入聊天页，长按可删除会话、清楚未读、设置置顶
- 右上角图标点击后，输入对方账号，服务端校验通过，即可创建聊天面板

<img src="https://i.loli.net/2020/10/14/JnP9eFOEmWQkTy4.jpg" alt="msg_list_page.jpg" style="zoom:25%;" />



#### 聊天页&聊天设置页

- 聊天允许发送文字、表情、图片、语音、视频、文件、还可隐私回复

- 长按消息可以删除、引用消息、多选、撤回消息(仅限本人)

- 点击用户头像即可进入对方个人中心查看

- 右上角图标点击即可进入聊天设置页

- 聊天设置允许设置：

  <img src="https://i.loli.net/2020/10/14/af48CG2MlWRH7xg.png" alt="1602612891925.png" style="zoom:25%;" />

  - 消息免打扰
  - 加入黑名单
  - 搜索消息历史记录



#### 个人信息页面

<img src="https://i.loli.net/2020/10/14/TCEAw37l95zNakZ.jpg" alt="personal_page.jpg" style="zoom:25%;" />

##### 更换头像

<img src="https://i.loli.net/2020/10/14/aKNQCGodbvPUTim.jpg" alt="personal_page_top.jpg" style="zoom:25%;" />

- 点击 **头像右下角按钮** ，会弹出一个选择框，让用户选择 **修改头像** 的方式（照相机或者相册）；
- 选择自己需要的方式后可以进行修改上传新头像（同步到后台数据库），选择完毕后选择框会自动关闭；

##### 用户名和个性签名更改

<img src="https://i.loli.net/2020/10/14/L1Ma5wuRrIYzfnU.jpg" alt="personal_page_signature.jpg" style="zoom:25%;" />

- 点击用户名右方按钮会弹出修改框提示你 **对昵称和个性签名进行更改**
- 在修改过程中过程中你可以只对用户名或者个性签名其中一项修改也可以同时修改两项
- 点击修改按钮会根据你输入的内容进行修改,同时判断文本框是否为空,当文本框为空是是无法修改的
- 修改成功后，数据会同步更新到数据库
- 如果修改框弹出后想放弃修改,可以点击修改框之外的任意位置中止修改.

功能思路：通过弹出框的方式让用户输入新密码,用户点击修改后发起post把新数据发送到后台重新渲然(通过用户id找到数据库对应的数据)

##### 个人动态

<img src="https://i.loli.net/2020/10/14/DVvIAr3UczdgXRH.jpg" alt="personal_page_top-body.jpg" style="zoom:25%;" />

- 个人动态会同步你在发现页面里面发表的所有动态,同时会时时更新
- 个人动态列表会展示你发布动态的时间和内容
- 个人动态限两行显示当超出时会隐藏,点击文字就查看全部内容
- 如果想删除动态,可以点击每条动态的右下角的删除按钮,这时会弹出提示框,向你确定是否删除,如果确定,就会删除个人动态同时删除后台对应数据,当你点击取消时,会关闭提示框

功能思路:通过post请求获取用户发送后保存在数据的数据,然后通过模板进行循环渲染  删除:通过delete请求把要删除动态的id和用户id发送到后台,从后台把对应数据删除 

#### 设置页面

<img src="https://i.loli.net/2020/10/14/FvYCxN8npsyLRHz.png" alt="1602612963834.png" style="zoom:33%;" />



##### 修改密码

![image-20201013175955104.png](https://i.loli.net/2020/10/14/md4WFNizy8HehsJ.png)

- 点击修改密码会弹出修改框,提示你输入要修改的新密码和确认新密码
- 点击修改按钮后会进行校验判断你输入是格式是否正确,以及你两次密码输入是是否一样,只有通过校验后才可以修改密码
- 密码修改成功后,后台数据会同步更新
- 当想放弃密码修改时,可以点击弹出框之外的任意区域,可以对弹出框进行关闭

功能思路:先对用户输入的内容进行校验,确保两次输入密码一致和密码格式正确然后通过post请求,把新密码发送到数据库进行更新(通过用户id找到对应用户进行密码更新)

##### 消息通知

- 消息通知的按钮在右侧,可以通过按钮实现对软件在后台运行时，好友发送**消息的推送和不推送**
- 同时每次点击按钮时，都会在**本地记录按钮的状态**,当你再次打开设置页面的时候,按钮位置会同步你上次点击按钮后的位置
- 按钮上面的on和off会提示您消息处于推送或者不推送状态

##### 关于

- 点击关于会弹出关于软件的介绍和使用的技术

##### 退出登录

- 点击退出登录,软件会退回到登录页面



## Together后台服务

### 前言

后台由node+express+mysql编写

图片上传使用了阿里的OSS

所以如果要运行项目,你需要注册一个阿里云账号,并且使用阿里云的oss

### 项目结构

```text
├─Config 配置文件
│ ├─dbconfig.js 数据库配置文件
│ ├─OSSconfig.js 阿里云OSS配置文集
│ └─rongSdkConfig.js 融云SDK配置文件
├─Controllers 控制器
│ ├─centerCtrl.js 广场控制器
│ ├─deleteCtrl.js 删除控制器
│ ├─indexCtrl.js 登录控制器
│ ├─OSSCtrl.js OSS控制器
│ └─updateCtrl.js 更新控制器
├─Models
│ ├─ArticleDelete.js 删除模型
│ ├─userCenter.js 广场模型
│ ├─userRegister.js 注册模型
│ └─userUpdate.js 更新模型
├─node_modules
├─public
│ ├─uploads 图片临时上传目录
├─Routers 路由
│ ├─centerRouter.js 广场路由
│ ├─deleteRouter.js 删除路由
│ ├─indexRouter.js 登录路由
│ └─updateRouter.js 更新路由
├─app.js 主程序
├─package.json
└─yarn.lock
```

### 准备

> node版本需 >= 14.9.0
>
> mysql版本需 >= 5.5
>
> 由于数据库需要存入emoji，需要在mysql.ini里面添加如下配置:
>
> ```text
> [client]
> 
> default-character-set = utf8mb4
> 
> [mysql]
> 
> default-character-set = utf8mb4
> 
> [mysqld]
> 
> character-set-client-handshake = FALSE
> 
> character-set-server = utf8mb4
> 
> collation-server = utf8mb4_unicode_ci
> 
> init_connect='SET NAMES utf8mb4'
> ```

### 配置

项目运行之前请到Config里面配置相关的配置项以正确✔运行程序

数据库文件在sql里面,导入即可使用

### 部署

程序使用yarn配置,需要安装yarn

```shell
npm install yarn -g
```

安装依赖

```shell
yarn add
```

运行项目:

```shell
yarn start
```

注:  线上推荐使用pm2部署

### 请求

#### 用户路由

##### 用户登录

请求地址: `/login`

请求方式: `POST`

| 字段名      | 必须 | 默认值 | 说明     |
| ----------- | ---- | ------ | -------- |
| `uid`       | true |        | 用户id   |
| `passoword` | true |        | 用户密码 |

响应:

| 字段      | 说明                                      |
| --------- | ----------------------------------------- |
| `code`    | 200为登录成功 400为参数不完整或者密码错误 |
| `data`    | 用户id和token                             |
| `message` | 提示信息                                  |

##### 用户注册

请求地址:`/register`

请求方式: `POST`

| 字段名        | 必须  | 默认值     | 说明     |
| ------------- | ----- | ---------- | -------- |
| `uid`         | true  |            | 用户id   |
| `passoword`   | true  |            | 用户密码 |
| `uname`       | false | 系统生成   | 用户昵称 |
| `portraitUri` | false | 系统生成   | 用户头像 |
| `gender`      | false | 保密       | 用户性别 |
| `bio`         | false | 系统默认值 | 用户简介 |

响应:

| 字段      | 说明                      |
| --------- | ------------------------- |
| `code`    | 200为成功 400为用户已存在 |
| `data`    | 注册成功返回token和用户id |
| `message` | 提示信息                  |

#### 广场路由

##### 添加广场文章

请求地址: `/center/add`

请求方式: `POST`

| 字段名    | 必须 | 默认值       | 说明           |
| --------- | ---- | ------------ | -------------- |
| uid       | true |              | 用户id         |
| content   | true |              | 文章内容       |
| findMates | true | '0'          | 是否发布到广场 |
| lng       | true | 系统自动获取 | 经度           |
| lat       | true | 系统自动获取 | 纬度           |

响应:

| 字段      | 说明                      |
| --------- | ------------------------- |
| `code`    | 200为成功 400请联系管理员 |
| `message` | 提示信息                  |

##### 获取广场文章(不包括自己)

请求地址: `/center/getCenters`

请求方式: `GET`

| 字段名 | 必须 | 默认值 | 说明   |
| ------ | ---- | ------ | ------ |
| uid    | true |        | 用户id |

响应:

| 字段      | 说明                            |
| --------- | ------------------------------- |
| `code`    | 200为成功 400为参数不完整       |
| `data`    | 用户的信息,如果用户不存在为null |
| `message` | 提示信息                        |

##### 获取自己发表的文章

请求地址: `/center/getMeArticle`

请求方式: `GET`

| 字段名 | 必须 | 默认值 | 说明   |
| ------ | ---- | ------ | ------ |
| `uid`  | true |        | 用户id |

响应:

| 字段      | 说明                            |
| --------- | ------------------------------- |
| `code`    | 200为成功 400为参数不完整       |
| `data`    | 用户的信息,如果用户不存在为null |
| `message` | 提示信息                        |

##### 获取用户信息

请求地址: `/center/getUserInfo`

请求方式: `GET`

| 字段名 | 必须 | 默认值 | 说明   |
| ------ | ---- | ------ | ------ |
| `uid`  | true |        | 用户id |

响应:

| 字段      | 说明                            |
| --------- | ------------------------------- |
| `code`    | 200为成功 400为参数不完整       |
| `data`    | 用户的信息,如果用户不存在为null |
| `message` | 提示信息                        |

#### 更新路由

##### 更新用户昵称

请求地址: `/update/updateName`

请求方式: `POST`

| 字段名  | 必须 | 默认值 | 说明         |
| ------- | ---- | ------ | ------------ |
| `uid`   | true |        | 用户id       |
| `uname` | true |        | 新的用户昵称 |

响应:

| 字段      | 说明                      |
| --------- | ------------------------- |
| `code`    | 200为成功 400为参数不完整 |
| `message` | 提示信息                  |

##### 更新用户简介

请求地址:`/update/updateBio`

请求方式: `POST`

| 字段名 | 必须 | 默认值 | 说明         |
| ------ | ---- | ------ | ------------ |
| `uid`  | true |        | 用户id       |
| `bio`  | true |        | 新的用户简介 |

响应:

| 字段      | 说明                      |
| --------- | ------------------------- |
| `code`    | 200为成功 400为参数不完整 |
| `message` | 提示信息                  |

##### 更新密码

请求地址: `/update/updatePasswd`

请求方式: `POST`

| 字段名     | 必须 | 默认值 | 说明         |
| ---------- | ---- | ------ | ------------ |
| `uid`      | true |        | 用户id       |
| `password` | true |        | 用户的新密码 |

响应:

| 字段      | 说明                      |
| --------- | ------------------------- |
| `code`    | 200为成功 400为参数不完整 |
| `message` | 提示信息                  |

##### 更新用户头像

请求地址; `/update/updateAvatar`

请求方式: `POST`

| 字段名   | 必须 | 默认值 | 说明           |
| -------- | ---- | ------ | -------------- |
| `uid`    | true |        | 用户id         |
| `avatar` | true |        | 用户头像问文件 |

响应:

| 字段      | 说明                      |
| --------- | ------------------------- |
| `code`    | 200为成功 400为参数不完整 |
| `url`     | 头像的地址                |
| `message` | 提示信息                  |



## 项目运行

1. 需要环境：Dart 2.92，Flutter 1.20.4

2. 打开  项目

3. 先执行：下载第三方包

   ```
   flutter packages get
   ```

4. 打开lib中的 mian.dart 文件，选择虚拟机（建议选择真机调试）

5. 再执行：运行项目

   ```
   flutter run
   ```

   

## 账号

在登录时，点击注册新用户即可



## 编译好的真机安装包

只有android版本

#### 注意事项：

安装app时，<font color=red>请选择将所有权限都开启</font>，以便更好的体验



## 联系方式

微信：yxd377531875