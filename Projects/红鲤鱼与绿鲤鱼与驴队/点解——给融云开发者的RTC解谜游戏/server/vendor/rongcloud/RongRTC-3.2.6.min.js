/**
 * RongRTC.js v3.2.6
 * CodeVersion: 40ffd655008b7e36415979d1e4340fd27ecadf84
 * Release Date: Fri Sep 18 2020 21:26:34 GMT+0800 (GMT+08:00)
 * Copyright (c) 2020 RongCloud, Inc.
 */(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.RongRTC=t()})(this,function(){'use strict';function e(e){return{disable:function(t){var r=Ie(t,["id","stream.tag"]),a=r.isIllegal,n=r.name;if(a){var o=Ae(n);return w.Defer.reject(o)}return e.exec({event:V.VIDEO_DISABLE,type:"stream",args:[t]})},enable:function(t){var r=Ie(t,["id","stream.tag"]),a=r.isIllegal,n=r.name;if(a){var o=Ae(n);return w.Defer.reject(o)}return e.exec({event:V.VIDEO_ENABLE,type:"stream",args:[t]})}}}function t(e){return{mute:function(t){var r=Ie(t,["id","stream.tag"]),a=r.isIllegal,n=r.name;if(a){var o=Ae(n);return w.Defer.reject(o)}return e.exec({event:V.AUDIO_MUTE,type:"stream",args:[t]})},unmute:function(t){var r=Ie(t,["id","stream.tag"]),a=r.isIllegal,n=r.name;if(a){var o=Ae(n);return w.Defer.reject(o)}return e.exec({event:V.AUDIO_UNMUTE,type:"stream",args:[t]})}}}function r(e,t,r){var a=new w.Prosumer,n=new qe,o=void 0,s=function(){o&&o.destroy(),o=Ne(r)?new pt(e,t):new Mt(e,t)};s(),e.on(We.CHANGE_ROLE,function(e,t){var r=t.newRole,a=t.oldRole;// 当由观众转化为主播时
xe(r,a)&&s()}),e.on(We.ERROR,function(){o&&o.destroy()}),n.on(We.CONSUME,function(){a.consume(function(e,t){var r=e.event,a=e.args,n=e.resolve,s=e.reject,i,d,c,p,m,l,g,u,E,S,T,_;switch(r){case V.STREAM_PUBLISH:return(i=o).publish.apply(i,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.STREAM_PUBLISH_DEFAULT:return(d=o).publishDefault.apply(d,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.STREAM_UNPUBLISH:return(c=o).unpublish.apply(c,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.STREAM_SUBSCRIBE:// 此处使用 callback 返回是因为, http 请求成功后即可返回. 若等到 promise 执行(onaddstream), 可能会延迟较大
return(p=o).subscribe.apply(p,R(a).concat([function(){t()}])).then(function(e){n(e)}).catch(function(e){t(),s(e)});case V.STREAM_UNSUBSCRIBE:return(m=o).unsubscribe.apply(m,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.STREAM_RESIZE:return(l=o).resize.apply(l,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.STREAM_GET:return(g=o).get.apply(g,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.AUDIO_MUTE:return(u=o).mute.apply(u,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.AUDIO_UNMUTE:return(E=o).unmute.apply(E,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.VIDEO_DISABLE:return(S=o).disable.apply(S,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.VIDEO_ENABLE:return(T=o).enable.apply(T,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});case V.LIVE_CONFIG:return(_=o).setMixConfig.apply(_,R(a)).then(function(e){t(),n(e)}).catch(function(e){t(),s(e)});default:je.warn(X.STREAM_HANDLER,{event:r,msg:"unkown event"});}})});return{dispatch:function(e,t){return w.deferred(function(r,o){a.produce({event:e,args:t,resolve:r,reject:o}),n.emit(We.CONSUME)})}}}function a(e,t){var r=function(r){je.log(X.ROOM_HANDLER,{msg:"join:before",room:r}),Fe.info(Se.L_JR_T,{roomId:r.id,userId:r.user.id});var a=q.Inner;return e.isJoined()?(je.log(X.ROOM_HANDLER,{msg:"join:after",extra:"repeate join room"}),Fe.warn(Se.L_JR_E,{desc:"repeate join room",roomId:r.id,userId:r.user.id}),w.Defer.reject(a.ROOM_REPEAT_JOIN)):e.isIMReady()?w.deferred(function(a,n){var o=t.mode,s=t.liveType;w.extend(r,{mode:o,broadcastType:s}),e.joinRoom(r).then(function(t){je.log(X.ROOM_HANDLER,{msg:"join:after",users:t}),t=w.toArray(t),t=w.map(t,function(e){var t=E(e,2),r=t[0],a=t[1],n={},o=a&&a.uris?a.uris:[];return o.forEach(function(e){var t=e.mediaType,r=e.tag,a=e.state;// 普通音视频流
/RongCloudRTC/.test(r)&&(t===J.AUDIO?n.audio=!!a:t===J.VIDEO&&(n.video=!!a))}),{id:r,state:n}}),e.emit(We.SEND_REPORT,{type:le.R1,name:V.ROOM_JOIN,content:{}}),Fe.info(Se.L_JR_R,{remoteUids:t}),a({users:t})}).catch(function(e){je.log(X.ROOM_HANDLER,{msg:"join:after:error",room:r,error:e}),Fe.error(Se.L_JR_E,{code:e,desc:"join:after:error",roomId:r.id,userId:r.user.id}),n(e)})}):(je.log(X.ROOM_HANDLER,{msg:"im:connected",extra:"IM not connected"}),Fe.warn(Se.L_JR_E,{desc:"IM not connected",roomId:r.id,userId:r.user.id}),w.Defer.reject(a.IM_NOT_CONNECTED))},a=function(){var r=e.getRoomId(),a=e.getUser();je.log(X.ROOM_HANDLER,{msg:"leave:before",roomId:r,user:a});var n=e.getRTCToken(),o=w.tplEngine(Xe.EXIT,{roomId:r}),s=De(e,t);w.extend(e,{isJoinRoom:!1});var i=function(t,n){Fe.info(Se.L_LR_T,{roomId:r,uid:a.id}),e.leaveRoom().then(function(){je.log(X.ROOM_HANDLER,{msg:"leave:after",roomId:r,user:a}),Fe.info(Se.L_LR_R,{roomId:r,uid:a.id}),t()},function(e){je.log(X.ROOM_HANDLER,{msg:"leave:im:error",roomId:r,error:e,user:a}),Fe.warn(Se.L_LR_E,{msg:"leave:im:error",roomId:r,error:e,uid:a.id}),n(e)})};return w.deferred(function(e,t){Fe.info(Se.L_MSLR_T,{roomId:r,mediaUrl:o}),ot.post({path:o,headers:s,body:{token:n}}).then(function(){Fe.warn(Se.L_MSLR_R,{roomId:r}),i(e,t)},function(n){je.log(X.ROOM_HANDLER,{msg:"leave:ms:error",roomId:r,error:n,user:a}),Fe.warn(Se.L_MSLR_E,{msg:"leave:ms:error",roomId:r,error:n,uid:a.id}),i(e,t)})})},n=function(){return e.getRoom()},o=function(){// let sessionId = im.getSessionId();
// return utils.Defer.resolve(sessionId);
return e.getSessionId()},s=function(){return e.getUsers()};return{dispatch:function(e,t){switch(e){case V.ROOM_JOIN:return r.apply(void 0,R(t));case V.ROOM_LEAVE:return a.apply(void 0,R(t));case V.ROOM_GET:return n.apply(void 0,R(t));case V.ROOM_GET_SESSONID:return o.apply(void 0,R(t));case V.ROOM_GET_STATS:return s.apply(void 0,R(t));default:je.warn(X.ROOM_HANDLER,{event:e,msg:"unkown event"});}}}}function n(e){var t=function(e){return w.isEqual(e,$.ROOM)?"Room":"User"},r=function(e,r){return r=t(r),w.tplEngine("{operate}{type}Data",{operate:e,type:r})},a=function(t,a,n,o){var s=r("set",t);return e[s](a,n,!1,o)},n=function(t,a){var n=r("get",t);return e[n](a,!1)},o=function(t,a,n){var o=r("remove",t);return e[o](a,!1,n)};return{dispatch:function(e,t){switch(e){case V.STORAGE_SET:return a.apply(void 0,R(t));case V.STORAGE_GET:return n.apply(void 0,R(t));case V.STORAGE_REMOVE:return o.apply(void 0,R(t));default:je.warn(X.STORAGE_HANDLER,{event:e,msg:"unkown event"});}}}}function o(e){var t=function(t){return e.sendMessage(t)};return{dispatch:function(e,r){switch(e){case V.MESSAGE_SEND:return t.apply(void 0,R(r));default:je.warn(X.MESSAGE,{event:e,msg:"unkown event"});}}}}function s(){var e=function(){return navigator.mediaDevices.enumerateDevices()};return{dispatch:function(t,r){switch(t){case V.DEVICE_GET:return e.apply(void 0,R(r));default:je.warn(X.DEVICE,{event:t,msg:"unkown event"});}}}}function i(e,t){var r=0,a=t.stat||{},n=a.frequency||2000,o=t.mode===ne.RTC,s=t.liveRole===se.AUDIENCE,i={TOTAL_PACAKS_LOST:"total_packs_lost",IS_FIRST:"is_first",PACKAGE_SENT:"package_sent",PACKAGE_RECEIVED:"package_received",PACKAGE_SENT_LOST:"package_sent_lost",PACKAGE_RECEIVED_LOST:"package_received_lost",PACKAGE_SENT_ENUM:{AUDIO:"package_sent_audio",VIDEO:"package_sent_video"},PACKAGE_RECEIVED_ENUM:{AUDIO:"package_received_audio",VIDEO:"package_received_video"},PACKAGE_SENT_LOST_ENUM:{AUDIO:"package_sent_lost_audio",VIDEO:"package_sent_lost_video"},PACKAGE_RECEIVED_LOST_ENUM:{AUDIO:"package_received_lost_audio",VIDEO:"package_received_lost_video"},BYTES_SENT:"bytes_sent",BYTES_RECEIVED:"bytes_received"},d=w.Cache(),c=w.Cache(),p=w.Cache(),m={get:function(e){return p.get(e)},set:function(e){w.isArray(e)||(e=[e]);var t={1:"video",0:"audio"};w.forEach(e,function(e){var r=e.uri,a=e.msid,n=e.mediaType;r=w.parse(r);var o=r,s=o.ssrc,i=t[n],d=w.tplEngine("{msid}_{kind}",{msid:a,kind:i});p.set(s,d)})},remove:function(e){p.remove(e)}};e.on(We.SET_URIS,function(e,t){e||m.set(t)}),e.on(We.TRACK_MODIFY,function(e,t){if(!e){var r=t.id,a=t.isEnable;c.set(r,a)}});/* 
      data = {
        content: ''
      }
      or
      data = [{
        content: ''
      }]
    */var l=function(t){if(!ke()&&e.isConnected()){if(!o&&s)return;//直播模式观众端不加入房间，无法上报数据
e.setRTCState(t),je.log(X.STAT,t)}},g=function(e){return w.tplEngine(me.R1,e)},u=function(e){return w.tplEngine(me.R2,e)},E=function(e){return w.tplEngine(me.R3_ITEM,e)},R=function(e){return w.tplEngine(me.R3,e)},S=function(e){var t={},r=!0,a=!1,n=void 0;try{for(var o=me.R3_KEYS[Symbol.iterator](),s,i;!(r=(s=o.next()).done);r=!0)i=s.value,t[i]=e[i]}catch(e){a=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(a)throw n}}return t},T=function(e){return w.tplEngine(me.R4_ITEM,e)},_=function(e){return w.tplEngine(me.R4,e)},h=function(e){var t={},r=!0,a=!1,n=void 0;try{for(var o=me.R4_KEYS[Symbol.iterator](),s,i;!(r=(s=o.next()).done);r=!0)i=s.value,t[i]=e[i]}catch(e){a=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(a)throw n}}return t},y=function(t){var r=function(e){var t=e.googFrameWidthSent,r=e.googFrameHeightSent,a=e.googFrameHeightReceived,n=e.googFrameWidthReceived,o=w.tplEngine("{domain}{path}",{height:r,width:t});o=w.isInclude(o,"height")?"-1":o;var s=w.tplEngine("{domain}{path}",{height:a,width:n});return s=w.isInclude(s,"height")?"-1":s,{send:o,receive:s}},a=function(e){var t=e.bytesSent,r=e.bytesReceived,a=e.googTrackId,o=t?t:r,s=d.get(a);// 发送、接收总码率为空，直接返回，下次有合法值再行计算
if(d.set(a,o),w.isUndefined(s))return"-1";var i=function(e,t){return 8*(e-t)/1024/(n/1e3)}(o,s);return i},o=function(e){var t={},n=e.audioOutputLevel||e.audioInputLevel||"-1",o=e.googFrameRateInput||e.googFrameRateOutput||"-1",s=e.id,p=r(e),l=e.googTrackId,g=ue.DISABLE,u=c.get(l);(w.isUndefined(u)||u)&&(g=ue.ENABLE);var E=w.isInclude(s,"send"),R=p.receive;E&&(R=p.send);var S=a(e),T="-1",_="-1",h=function(e){var t=e.packetsSent,r=e.packetsReceived,a=e.packetsLost,n=e.mediaType,o=function(e,t,r,a){var n=Math.abs,o=n(e-t),s=n(r-a);if(0==o)return 100;var i=s/(o+s);return"NaN"===i.toString()?0:(i=1<i?1:i,i.toFixed(2))},s=n.toUpperCase(),c=E?"sender":"receiver",p={sender:function(){var e=d.get(i.PACKAGE_SENT_ENUM[s]);d.set(i.PACKAGE_SENT_ENUM[s],t);var r=d.get(i.PACKAGE_SENT_LOST_ENUM[s]);return d.set(i.PACKAGE_SENT_LOST_ENUM[s],a),o(t,e,a,r)},receiver:function(){var e=d.get(i.PACKAGE_RECEIVED_ENUM[s]);d.set(i.PACKAGE_RECEIVED_ENUM[s],r);var t=d.get(i.PACKAGE_RECEIVED_LOST_ENUM[s]);return d.set(i.PACKAGE_RECEIVED_LOST_ENUM[s],a),o(r,e,a,t)}}[c];return p()}(e),y=0,f=0;E?(T=S,f=h):(y=h,_=S);w.forEach(["googCodecName","packetsLost","googJitterReceived","googNacksReceived","googPlisReceived","googRtt","googFirsReceived","codecImplementationName","googRenderDelayMs","googJitterSent","googNacksSent","googPlisSent","googFirsSent","mediaType"],function(r){t[r]=e[r]||"-1"});var C=e.googTrackId,v=e.ssrc;return C=m.get(v)||"-1",w.extend(t,{googTrackId:C,audioLevel:n,samplingRate:"-1",frameRate:o,transferRate:"-1",resolution:R,trackState:g,trackSent:T,trackReceived:_,packLostSentRate:f,packLostReceivedRate:y,isSender:E}),t},s=function(e,r){var a=w.filter(t,function(t){var r=t.type;return w.isEqual(r,e)});return r?a:a[0]},p=s("ssrc",!0),l=s("VideoBwe"),g=s("localcandidate"),u=s("googCandidatePair");p=w.map(p,function(e){var t=o(e);return t}),u=function(e){e=e||{};var t=e,r=t.bytesReceived,a=t.bytesSent,o=t.googLocalAddress,s=d.get(i.BYTES_SENT),c=d.get(i.BYTES_RECEIVED),p="-1",m="-1";return s&&(p=8*(a-s)/1024/(n/1e3)),c&&(m=8*(r-c)/1024/(n/1e3)),d.set(i.BYTES_SENT,a),d.set(i.BYTES_RECEIVED,r),{totalSend:p,totalReceive:m,localAddress:o}}(u);var y=u,f=y.totalSend,C=y.totalReceive,v=y.localAddress,I=0;if(w.forEach(p,function(e){var t=e.packetsLost;t=+t,w.isEqual(t,"-1")||(I+=t)}),w.isUndefined(g))return{};var A=g.networkType,D=g.stunKeepaliveRttTotal,O=l.googAvailableReceiveBandwidth,L=l.googAvailableSendBandwidth,M={networkType:A,rtt:D,receiveBand:O,localAddress:v,sendBand:L,packetsLost:I,deviceId:e.getUserId()},b=[],k=[],U=[],P=[];w.forEach(p,function(e){var t=e.isSender,r=e.trackSent;if(!t){var a=T(e);U.push(a),P.push(h(e))}else if("0.00"!=r){var n=E(e);b.push(n),k.push(S(e))}});var N={},x,B;if(!w.isEmpty(b)){var V={totalRate:f,tracks:b.join("\n")};w.extend(V,M),x=R(V);var G={totalRate:f,tracks:k};w.extend(G,M),N.sender=G}if(!w.isEmpty(U)){var j={totalRate:C,tracks:U.join("\n")};w.extend(j,M),B=_(j);N.received={totalRate:C,tracks:P,rtt:D}}return w.isUndefined(d.get(i.IS_FIRST))?(d.set(i.IS_FIRST,!0),{}):{data:{R3:x,R4:B},reports:N}},f=function(e){w.forEach(e,function(e){e&&l({report:e})})},C=function(){r&&clearInterval(r)},v=function(e){try{for(var t in e){var r=e[t]||{};r.tracks&&(r.tracks=w.uniq(r.tracks,function(e){return{key:e.googTrackId,value:e}}),r.tracks=w.filter(r.tracks,function(e){var t=e.googTrackId;return t&&!w.isEqual(t,"-1");// 过滤没有 googTrackId 的值
}),e[t].tracks=r.tracks)}}catch(t){// do nothing
}return e},I=function(t){r=setInterval(function(){t.getStats(function(t){var r=y(t);o&&(r.reports=v(r.reports)),f(r.data),r.reports&&e.emit(B.MONITOR_STATS,r.reports)})},n)},A=ct.getInstance();A&&I(A),e.on(We.LEFT,function(){C()}),e.on(We.PEERCONN_CREATED,function(e,t){if(e)throw e;ke()||I(t)}),e.on(We.PEERCONN_DESTROYED,function(e){if(e)throw e;C()});var D=function(e){var t="",r="";return e===V.STREAM_PUBLISH?(t="publish",r="begin"):e===V.STREAM_UNPUBLISH?(t="publish",r="end"):e===V.STREAM_SUBSCRIBE?(t="subscribe",r="begin"):e===V.STREAM_UNSUBSCRIBE?(t="subscribe",r="end"):void 0,{type:t,state:r}};e.on(We.SEND_REPORT,function(t,r){if(w.isUndefined(t)){var a=r.type,n=r.name,o=r.content.trackIds,s="",i=w.getBrowser();switch(a){case le.R1:s=g({rtcVersion:Pe(),imVersion:e.getIMVersion(),platform:"Web",pcName:navigator.platform,pcVersion:"-1",browserName:i.name,browserVersion:i.version,deviceId:ve()});break;case le.R2:{var d=D(n),c=d.type,p=d.state;s=u({type:c,state:p,deviceId:ve(),trackIds:o.join("\t")})}}w.isEmpty(s)||l({report:s})}})}/* 
      版本更新须知: 原版 adapter.js 不支持 es6 引入，将原始文件 factory 定义 Adapter 方法，通过模块引用初始化
  */function d(){var e=Math.min;return function(){function s(d,e,r){function t(o,i){if(!e[o]){if(!d[o]){var m="function"==typeof require&&require;if(!i&&m)return m(o,!0);if(n)return n(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var a=e[o]={exports:{}};d[o][0].call(a.exports,function(e){var r=d[o][1][e];return t(r||e)},a,a.exports,s,d,e,r)}return e[o].exports}for(var n="function"==typeof require&&require,a=0;a<r.length;a++)t(r[a]);return t}return s}()({1:[function(e,t){var r=e("./adapter_factory.js"),a=(0,r.adapterFactory)({window:window});t.exports=a},{"./adapter_factory.js":2}],2:[function(e,t,r){function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}// Shimming starts here.
/*
         *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
         *
         *  Use of this source code is governed by a BSD-style license
         *  that can be found in the LICENSE file in the root of the source
         *  tree.
         */Object.defineProperty(r,"__esModule",{value:!0}),r.adapterFactory=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.window,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},a=o.log,n=o.detectBrowser(t),s={browserDetails:n,commonShim:E,extractVersion:o.extractVersion,disableLog:o.disableLog,disableWarnings:o.disableWarnings};// Shim browser if found.
switch(n.browser){case"chrome":if(!i||!i.shimPeerConnection||!r.shimChrome)return a("Chrome shim is not included in this adapter release."),s;a("adapter.js shimming chrome."),s.browserShim=i,i.shimGetUserMedia(t),i.shimMediaStream(t),i.shimPeerConnection(t),i.shimOnTrack(t),i.shimAddTrackRemoveTrack(t),i.shimGetSendersWithDtmf(t),i.shimSenderReceiverGetStats(t),i.fixNegotiationNeeded(t),E.shimRTCIceCandidate(t),E.shimConnectionState(t),E.shimMaxMessageSize(t),E.shimSendThrowTypeError(t);break;case"firefox":if(!m||!m.shimPeerConnection||!r.shimFirefox)return a("Firefox shim is not included in this adapter release."),s;a("adapter.js shimming firefox."),s.browserShim=m,m.shimGetUserMedia(t),m.shimPeerConnection(t),m.shimOnTrack(t),m.shimRemoveStream(t),m.shimSenderGetStats(t),m.shimReceiverGetStats(t),m.shimRTCDataChannel(t),E.shimRTCIceCandidate(t),E.shimConnectionState(t),E.shimMaxMessageSize(t),E.shimSendThrowTypeError(t);break;case"edge":if(!c||!c.shimPeerConnection||!r.shimEdge)return a("MS edge shim is not included in this adapter release."),s;a("adapter.js shimming edge."),s.browserShim=c,c.shimGetUserMedia(t),c.shimGetDisplayMedia(t),c.shimPeerConnection(t),c.shimReplaceTrack(t),E.shimMaxMessageSize(t),E.shimSendThrowTypeError(t);break;case"safari":if(!g||!r.shimSafari)return a("Safari shim is not included in this adapter release."),s;a("adapter.js shimming safari."),s.browserShim=g,g.shimRTCIceServerUrls(t),g.shimCreateOfferLegacy(t),g.shimCallbacksAPI(t),g.shimLocalStreamsAPI(t),g.shimRemoteStreamsAPI(t),g.shimTrackEventTransceiver(t),g.shimGetUserMedia(t),E.shimRTCIceCandidate(t),E.shimMaxMessageSize(t),E.shimSendThrowTypeError(t);break;default:a("Unsupported browser!");}return s}// Browser shims.
;var n=e("./utils"),o=a(n),s=e("./chrome/chrome_shim"),i=a(s),d=e("./edge/edge_shim"),c=a(d),p=e("./firefox/firefox_shim"),m=a(p),l=e("./safari/safari_shim"),g=a(l),u=e("./common_shim"),E=a(u)},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(e,t,r){/* iterates the stats graph recursively. */function a(e,t,r){!t||r.has(t.id)||(r.set(t.id,t),Object.keys(t).forEach(function(n){n.endsWith("Id")?a(e,e.get(t[n]),r):n.endsWith("Ids")&&t[n].forEach(function(t){a(e,e.get(t),r)})}))}/* filter getStats for a sender/receiver track. */function n(e,t,r){var n=r?"outbound-rtp":"inbound-rtp",o=new Map;if(null===t)return o;var s=[];return e.forEach(function(e){"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)}),s.forEach(function(t){e.forEach(function(r){r.type===n&&r.trackId===t.id&&a(e,r,o)})}),o}function o(t){if("object"===("undefined"==typeof t?"undefined":d(t))&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){var a=this;return this._ontrackpoly||(this._ontrackpoly=function(r){r.stream.addEventListener("addtrack",function(e){var n=t.RTCPeerConnection.prototype.getReceivers?a.getReceivers().find(function(t){return t.track&&t.track.id===e.track.id}):{track:e.track};var o=new Event("track");o.track=e.track,o.receiver=n,o.transceiver={receiver:n},o.streams=[r.stream],a.dispatchEvent(o)}),r.stream.getTracks().forEach(function(e){var n=t.RTCPeerConnection.prototype.getReceivers?a.getReceivers().find(function(t){return t.track&&t.track.id===e.id}):{track:e};var o=new Event("track");o.track=e,o.receiver=n,o.transceiver={receiver:n},o.streams=[r.stream],a.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),r.apply(this,arguments)}}else// even if RTCRtpTransceiver is in window, it is only used and
// emitted in unified-plan. Unfortunately this means we need
// to unconditionally wrap the event.
g.wrapPeerConnectionEvent(t,"track",function(t){return t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t})}function s(e){// Overrides addTrack/removeTrack, depends on shimAddTrackRemoveTrack.
if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};// augment addTrack when getSenders is not available.
if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice();// return a copy of the internal state.
};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e){var a=r.apply(this,arguments);return a||(a=t(this,e),this._senders.push(a)),a};var a=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){a.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(function(e){r._senders.push(t(r,e))})};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],o.apply(this,[e]),e.getTracks().forEach(function(e){var r=t._senders.find(function(t){return t.track===e});r&&t._senders.splice(t._senders.indexOf(r),1)})}}else if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var s=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=s.apply(this,[]);return t.forEach(function(t){return t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function i(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){// shim sender stats.
if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach(function(t){return t._pc=e}),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return(/* Note: this will include stats of all senders that
                   *   send a track with the same id as sender.track as
                   *   it is not possible to identify the RTCRtpSender.
                   */n(t,e.track,!0))})}}// shim receiver stats.
if(!("getStats"in e.RTCRtpReceiver.prototype)){var a=e.RTCPeerConnection.prototype.getReceivers;a&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=a.apply(this,[]);return t.forEach(function(t){return t._pc=e}),t}),g.wrapPeerConnectionEvent(e,"track",function(t){return t.receiver._pc=t.srcElement,t}),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return n(t,e.track,!1)})}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){// shim RTCPeerConnection.getStats(track).
var o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],r=void 0,a=void 0,n=void 0;return(this.getSenders().forEach(function(e){e.track===t&&(r?n=!0:r=e)}),this.getReceivers().forEach(function(e){return e.track===t&&(a?n=!0:a=e),e.track===t}),n||r&&a)?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():a?a.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return o.apply(this,arguments)}}}}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var d="function"==typeof Symbol&&"symbol"===p(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":p(e)},c=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return c.shimGetUserMedia}});var m=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return m.shimGetDisplayMedia}}),r.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},r.shimOnTrack=o,r.shimGetSendersWithDtmf=s,r.shimSenderReceiverGetStats=i,r.shimAddTrackRemoveTrackWithNative=function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(t){return e._shimmedLocalStreams[t][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var a=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(a)&&this._shimmedLocalStreams[r.id].push(a):this._shimmedLocalStreams[r.id]=[r,a],a};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(function(e){var r=t.getSenders().find(function(t){return t.track===e});if(r)throw new DOMException("Track already exists.","InvalidAccessError")});var a=this.getSenders();r.apply(this,arguments);var n=this.getSenders().filter(function(e){return-1===a.indexOf(e)});this._shimmedLocalStreams[e.id]=[e].concat(n)};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],a.apply(this,arguments)};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(function(r){var a=t._shimmedLocalStreams[r].indexOf(e);-1!==a&&t._shimmedLocalStreams[r].splice(a,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]}),n.apply(this,arguments)}},r.shimAddTrackRemoveTrack=function(e){// replace the internal stream id with the external one and
// vice versa.
function t(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var a=e._reverseStreams[t],n=e._streams[a.id];r=r.replace(new RegExp(n.id,"g"),a.id)}),new RTCSessionDescription({type:t.type,sdp:r})}function r(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var a=e._reverseStreams[t],n=e._streams[a.id];r=r.replace(new RegExp(a.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:r})}if(e.RTCPeerConnection){var a=g.detectBrowser(e);// shim addTrack and removeTrack.
if(e.RTCPeerConnection.prototype.addTrack&&65<=a.version)return this.shimAddTrackRemoveTrackWithNative(e);// also shim pc.getLocalStreams when addTrack is shimmed
// to return the original streams.
var n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=n.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;// Add identity mapping for consistency with addTrack.
// Unless this is being used with a stream from addTrack.
if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(function(e){var t=r.getSenders().find(function(t){return t.track===e});if(t)throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){var a=new e.MediaStream(t.getTracks());this._streams[t.id]=a,this._reverseStreams[a.id]=t,t=a}o.apply(this,[t])};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(r,a){var n=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var o=[].slice.call(arguments,1);if(1!==o.length||!o[0].getTracks().find(function(e){return e===r}))// this is not fully correct but all we can manage without
// [[associated MediaStreams]] internal slot.
throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var s=this.getSenders().find(function(e){return e.track===r});if(s)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var i=this._streams[a.id];if(i)i.addTrack(r),Promise.resolve().then(function(){n.dispatchEvent(new Event("negotiationneeded"))});else{var d=new e.MediaStream([r]);this._streams[a.id]=d,this._reverseStreams[d.id]=a,this.addStream(d)}return this.getSenders().find(function(e){return e.track===r})},["createOffer","createAnswer"].forEach(function(r){var a=e.RTCPeerConnection.prototype[r];e.RTCPeerConnection.prototype[r]=function(){var e=this,r=arguments,n=arguments.length&&"function"==typeof arguments[0];return n?a.apply(this,[function(a){var n=t(e,a);r[0].apply(null,[n])},function(e){r[1]&&r[1].apply(null,e)},arguments[2]]):a.apply(this,arguments).then(function(r){return t(e,r)})}});var i=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=r(this,arguments[0]),i.apply(this,arguments)):i.apply(this,arguments)};// TODO: mangle getStats: https://w3c.github.io/webrtc-stats/#dom-rtcmediastreamstats-streamidentifier
var d=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=d.get.apply(this);return""===e.type?e:t(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");// We can not yet check for sender instanceof RTCRtpSender
// since we shim RTPSender. So we check if sender._pc is set.
if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var r=e._pc===this;if(!r)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");// Search for the native stream the senders track belongs to.
this._streams=this._streams||{};var a;Object.keys(this._streams).forEach(function(r){var n=t._streams[r].getTracks().find(function(t){return e.track===t});n&&(a=t._streams[r])}),a&&(1===a.getTracks().length?this.removeStream(this._reverseStreams[a.id]):a.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}},r.shimPeerConnection=function(e){if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!!e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,a){var n=this,o=arguments;// If selector is a function then we are in the old style stats so just
// pass back the original getStats format to avoid breaking old users.
if(0<arguments.length&&"function"==typeof e)return t.apply(this,arguments);// When spec-style getStats is supported, return those when called with
// either no arguments or the selector argument is null.
if(0===t.length&&(0===arguments.length||"function"!=typeof arguments[0]))return t.apply(this,[]);var s=function(e){var t={},r=e.result();return r.forEach(function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){r[t]=e.stat(t)}),t[r.id]=r}),t},i=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};// shim getStats with maplike support
if(2<=arguments.length){var d=function(e){o[1](i(s(e)))};return t.apply(this,[d,arguments[0]])}// promise-support
return new Promise(function(e,r){t.apply(n,[function(t){e(i(s(t)))},r])}).then(r,a)},["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}});// support for addIceCandidate(null or undefined)
var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},r.fixNegotiationNeeded=function(e){g.wrapPeerConnectionEvent(e,"negotiationneeded",function(t){var e=t.target;return"stable"===e.signalingState?t:void 0})};var l=e("../utils.js"),g=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(l)},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){function a(e,t){return e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices?void 0:e.navigator.mediaDevices?"function"==typeof t?void(e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then(function(t){var a=r.video&&r.video.width,n=r.video&&r.video.height,o=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},a&&(r.video.mandatory.maxWidth=a),n&&(r.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(r)})}):void console.error("shimGetDisplayMedia: getSourceId argument is not a function"):void 0;// getSourceId is a function that returns a promise resolving with
// the sourceId of the screen/window/tab to be shared.
}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=a},{}],5:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"===p(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":p(e)};r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices){var r=o.detectBrowser(e),n=function(e){if("object"!==("undefined"==typeof e?"undefined":a(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var o="object"===a(e[n])?e[n]:{ideal:e[n]};void 0!==o.exact&&"number"==typeof o.exact&&(o.min=o.max=o.exact);var r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==o.ideal){t.optional=t.optional||[];var s={};"number"==typeof o.ideal?(s[r("min",n)]=o.ideal,t.optional.push(s),s={},s[r("max",n)]=o.ideal,t.optional.push(s)):(s[r("",n)]=o.ideal,t.optional.push(s))}void 0!==o.exact&&"number"!=typeof o.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",n)]=o.exact):["min","max"].forEach(function(e){void 0!==o[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,n)]=o[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,o){if(61<=r.version)return o(e);if(e=JSON.parse(JSON.stringify(e)),e&&"object"===a(e.audio)){var i=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};e=JSON.parse(JSON.stringify(e)),i(e.audio,"autoGainControl","googAutoGainControl"),i(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"===a(e.video)){// Shim facingMode for mobile & surface pro.
var d=e.video.facingMode;d=d&&("object"===("undefined"==typeof d?"undefined":a(d))?d:{ideal:d});var c=66>r.version;if(d&&("user"===d.exact||"environment"===d.exact||"user"===d.ideal||"environment"===d.ideal)&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!c)){delete e.video.facingMode;var p;if("environment"===d.exact||"environment"===d.ideal?p=["back","rear"]:("user"===d.exact||"user"===d.ideal)&&(p=["front"]),p)// Look for matches in label, or use last cam for back (typical).
return t.mediaDevices.enumerateDevices().then(function(t){t=t.filter(function(e){return"videoinput"===e.kind});var r=t.find(function(e){return p.some(function(t){return e.label.toLowerCase().includes(t)})});return!r&&t.length&&p.includes("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=d.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=n(e.video),s("chrome: "+JSON.stringify(e)),o(e)})}e.video=n(e.video)}return s("chrome: "+JSON.stringify(e)),o(e)},d=function(t){return 64<=r.version?t:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},c=function(e,r,a){i(e,function(e){t.webkitGetUserMedia(e,r,function(t){a&&a(d(t))})})};t.getUserMedia=c.bind(t);// Even though Chrome 45 has navigator.mediaDevices and a getUserMedia
// function which returns a Promise, it does not accept spec-style
// constraints.
var p=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e,function(e){return p(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(t){return Promise.reject(d(t))})})}}};var n=e("../utils.js"),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(n),s=o.log},{"../utils.js":15}],6:[function(t,r,a){function n(t){// foundation is arbitrarily chosen as an indicator for full support for
// https://w3c.github.io/webrtc-pc/#rtcicecandidate-interface
if(!(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)){var r=t.RTCIceCandidate;t.RTCIceCandidate=function(e){if("object"===("undefined"==typeof e?"undefined":d(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&(e=JSON.parse(JSON.stringify(e)),e.candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){// Augment the native candidate with the parsed fields.
var t=new r(e),a=m.default.parseCandidate(e.candidate),n=Object.assign(t,a);return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new r(e)},t.RTCIceCandidate.prototype=r.prototype,g.wrapPeerConnectionEvent(t,"icecandidate",function(r){return r.candidate&&Object.defineProperty(r,"candidate",{value:new t.RTCIceCandidate(r.candidate),writable:"false"}),r})}}function o(t){if(!t.RTCSctpTransport&&t.RTCPeerConnection){var r=g.detectBrowser(t);"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get:function(){return"undefined"==typeof this._sctp?null:this._sctp}});var a=function(e){var t=m.default.splitSections(e.sdp);return t.shift(),t.some(function(e){var t=m.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},n=function(e){// TODO: Is there a better solution for detecting Firefox?
var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||2>t.length)return-1;var r=parseInt(t[1],10);// Test for NaN (yes, this is ugly)
return r===r?r:-1},o=function(e){// Every implementation we know can send at least 64 KiB.
// Note: Although Chrome is technically able to send up to 256 KiB, the
//       data does not reach the other peer reliably.
//       See: https://bugs.chromium.org/p/webrtc/issues/detail?id=8419
var t=65536;return"firefox"===r.browser&&(57>r.version?-1===e?t=16384:t=2147483637:60>r.version?t=57===r.version?65535:65536:t=2147483637),t},s=function(e,t){// Note: 65536 bytes is the default value from the SDP spec. Also,
//       every implementation we know supports receiving 65536 bytes.
var a=65536;// FF 57 has a slightly incorrect default remote max message size, so
// we need to adjust it here to avoid a failure when sending.
// See: https://bugzilla.mozilla.org/show_bug.cgi?id=1425697
"firefox"===r.browser&&57===r.version&&(a=65535);var n=m.default.matchPrefix(e.sdp,"a=max-message-size:");return 0<n.length?a=parseInt(n[0].substr(19),10):"firefox"===r.browser&&-1!==t&&(a=2147483637),a},i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){var t=Math.max,r=Number.POSITIVE_INFINITY;if(this._sctp=null,a(arguments[0])){// Check if the remote is FF.
var d=n(arguments[0]),c=o(d),p=s(arguments[0],d),m=void 0;// Get the maximum message size the local peer is capable of sending
m=0===c&&0===p?r:0===c||0===p?t(c,p):e(c,p);// Create a dummy RTCSctpTransport object and the 'maxMessageSize'
// attribute.
var l={};Object.defineProperty(l,"maxMessageSize",{get:function(){return m}}),this._sctp=l}return i.apply(this,arguments)}}}function s(e){// Note: Although Firefox >= 57 has a native implementation, the maximum
//       message size can be reset for all data channels at a later stage.
//       See: https://bugzilla.mozilla.org/show_bug.cgi?id=1426831
function t(e,t){var r=e.send;e.send=function(){var a=arguments[0],n=a.length||a.size||a.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=r.apply(this,arguments);return t(e,this),e},g.wrapPeerConnectionEvent(e,"datachannel",function(r){return t(r.channel,r.target),r})}}/* shims RTCConnectionState by pretending it is the same as iceConnectionState.
         * See https://bugs.chromium.org/p/webrtc/issues/detail?id=6145#c12
         * for why this is a valid hack in Chrome. In Firefox it is slightly incorrect
         * since DTLS failures would be hidden. See
         * https://bugzilla.mozilla.org/show_bug.cgi?id=1265827
         * for the Firefox tracking bug.
         */function i(e){if(e.RTCPeerConnection&&!("connectionState"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(e){var r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(t){var e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;var r=new Event("connectionstatechange",t);e.dispatchEvent(r)}return t},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}}Object.defineProperty(a,"__esModule",{value:!0});var d="function"==typeof Symbol&&"symbol"===p(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":p(e)};a.shimRTCIceCandidate=n,a.shimMaxMessageSize=o,a.shimSendThrowTypeError=s,a.shimConnectionState=i;var c=t("sdp"),m=function(e){return e&&e.__esModule?e:{default:e}}(c),l=t("./utils"),g=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(l)},{"./utils":15,sdp:17}],7:[function(e,t,r){function a(e){var t=d.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),15025>t.version))// this adds an additional event listener to MediaStrackTrack that signals
// when a tracks enabled property was changed. Workaround for a bug in
// addStream, see below. No longer required in 15025+
{var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}// ORTC defines the DTMF sender a bit different.
// https://github.com/w3c/ortc/issues/714
e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var a=(0,m.default)(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,c.filterIceServers)(e.iceServers,t.version),d.log("ICE servers after filtering:",e.iceServers)),new a(e)},e.RTCPeerConnection.prototype=a.prototype}function n(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var o=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return o.shimGetUserMedia}});var s=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return s.shimGetDisplayMedia}}),r.shimPeerConnection=a,r.shimReplaceTrack=n;var i=e("../utils"),d=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(i),c=e("./filtericeservers"),p=e("rtcpeerconnection-shim"),m=function(e){return e&&e.__esModule?e:{default:e}}(p)},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(e,t,r){// Edge does not like
// 1) stun: filtered after 14393 unless ?transport=udp is present
// 2) turn: that does not have all of turn:host:port?transport=udp
// 3) turn: with ipv6 addresses
// 4) turn: occurring muliple times
Object.defineProperty(r,"__esModule",{value:!0}),r.filterIceServers=function(e){var t=!1;return e=JSON.parse(JSON.stringify(e)),e.filter(function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&n.deprecated("RTCIceServer.url","RTCIceServer.urls");var a="string"==typeof r;return a&&(r=[r]),r=r.filter(function(e){// filter STUN unconditionally.
if(0===e.indexOf("stun:"))return!1;var r=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return r&&!t?(t=!0,!0):r&&!t}),delete e.url,e.urls=a?r[0]:r,!!r.length}})};var a=e("../utils"),n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(a)},{"../utils":15}],9:[function(e,t,r){function a(e){!("getDisplayMedia"in e.navigator)||!e.navigator.mediaDevices||e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator.mediaDevices))}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=a},{}],10:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetUserMedia=function(e){var t=e&&e.navigator,r=function(t){return{name:{PermissionDeniedError:"NotAllowedError"}[t.name]||t.name,message:t.message,constraint:t.constraint,toString:function(){return this.name}}},a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return a(e).catch(function(t){return Promise.reject(r(t))})}}},{}],11:[function(e,t,r){function a(e){"object"===("undefined"==typeof e?"undefined":i(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}function n(e){if("object"===("undefined"==typeof e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach(function(t){return t._pc=e}),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}}function o(e){if("object"===("undefined"==typeof e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(this,[]);return r.forEach(function(t){return t._pc=e}),r}),l.wrapPeerConnectionEvent(e,"track",function(t){return t.receiver._pc=t.srcElement,t}),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}}function s(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;l.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(r){r.track&&e.getTracks().includes(r.track)&&t.removeTrack(r)})})}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i="function"==typeof Symbol&&"symbol"===p(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":p(e)},d=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return d.shimGetUserMedia}});var c=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return c.shimGetDisplayMedia}}),r.shimOnTrack=a,r.shimPeerConnection=function(e){var t=l.detectBrowser(e);if("object"===("undefined"==typeof e?"undefined":i(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}});// support for addIceCandidate(null or undefined)
var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var a={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,o){return n.apply(this,[e||null]).then(function(n){if(53>t.version&&!r)// Shim only promise getStats with spec-hyphens in type names
// Leave callback version alone; misc old uses of forEach before Map
try{n.forEach(function(e){e.type=a[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;// Avoid TypeError: "type" is read-only, in old versions. 34-43ish
n.forEach(function(e,t){n.set(t,Object.assign({},e,{type:a[e.type]||e.type}))})}return n}).then(r,o)}}// probably media.peerconnection.enabled=false in about:config
},r.shimSenderGetStats=n,r.shimReceiverGetStats=o,r.shimRemoveStream=s,r.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)};var m=e("../utils"),l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(m)},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(e,t,r){function a(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||!e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!(r&&r.video)){var a=new DOMException("getDisplayMedia without video constraints is undefined");return a.name="NotFoundError",a.code=8,Promise.reject(a)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=a},{}],13:[function(e,t,r){function a(e){var t=s.detectBrowser(e),r=e&&e.navigator,a=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,a){s.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,a)},!(55<t.version&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var o=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},i=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"===("undefined"==typeof e?"undefined":n(e))&&"object"===n(e.audio)&&(e=JSON.parse(JSON.stringify(e)),o(e.audio,"autoGainControl","mozAutoGainControl"),o(e.audio,"noiseSuppression","mozNoiseSuppression")),i(e)},a&&a.prototype.getSettings){var d=a.prototype.getSettings;a.prototype.getSettings=function(){var e=d.apply(this,arguments);return o(e,"mozAutoGainControl","autoGainControl"),o(e,"mozNoiseSuppression","noiseSuppression"),e}}if(a&&a.prototype.applyConstraints){var p=a.prototype.applyConstraints;a.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===("undefined"==typeof e?"undefined":n(e))&&(e=JSON.parse(JSON.stringify(e)),o(e,"autoGainControl","mozAutoGainControl"),o(e,"noiseSuppression","mozNoiseSuppression")),p.apply(this,[e])}}}}Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"===p(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":p(e)};r.shimGetUserMedia=a;var o=e("../utils"),s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(o)},{"../utils":15}],14:[function(e,t,r){function a(e){if("object"===("undefined"==typeof e?"undefined":i(e))&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getTracks().forEach(function(a){return t.call(r,a,e)})},e.RTCPeerConnection.prototype.addTrack=function(e,r){return r&&(this._localStreams?!this._localStreams.includes(r)&&this._localStreams.push(r):this._localStreams=[r]),t.call(this,e,r)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var r=this._localStreams.indexOf(e);if(-1!==r){this._localStreams.splice(r,1);var a=e.getTracks();this.getSenders().forEach(function(e){a.includes(e.track)&&t.removeTrack(e)})}})}}function n(e){if("object"===("undefined"==typeof e?"undefined":i(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(function(e){t._remoteStreams||(t._remoteStreams=[]),t._remoteStreams.push(e);var r=new Event("addstream");r.stream=e,t.dispatchEvent(r)})})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(0<=e._remoteStreams.indexOf(t))){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}})}),t.apply(e,arguments)}}}function o(e){// migrate from non-spec RTCIceServer.url to RTCIceServer.urls
var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var a=[],n=0,o;n<e.iceServers.length;n++)o=e.iceServers[n],!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(c.deprecated("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,a.push(o)):a.push(e.iceServers[n]);e.iceServers=a}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})}function s(e){"object"===("undefined"==typeof e?"undefined":i(e))&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&// can't check 'transceiver' in window.RTCTrackEvent.prototype, as it is
// defined for some reason even when window.RTCTransceiver is not.
!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}Object.defineProperty(r,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"===p(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":p(e)};r.shimLocalStreamsAPI=a,r.shimRemoteStreamsAPI=n,r.shimCallbacksAPI=function(e){if("object"===("undefined"==typeof e?"undefined":i(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,a=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){var a=2<=arguments.length?arguments[2]:arguments[0],n=r.apply(this,[a]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){var r=2<=arguments.length?arguments[2]:arguments[0],n=a.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n};var d=function(e,t,r){var a=n.apply(this,[e]);return r?(a.then(t,r),Promise.resolve()):a};t.setLocalDescription=d,d=function(e,t,r){var a=o.apply(this,[e]);return r?(a.then(t,r),Promise.resolve()):a},t.setRemoteDescription=d,d=function(e,t,r){var a=s.apply(this,[e]);return r?(a.then(t,r),Promise.resolve()):a},t.addIceCandidate=d}},r.shimGetUserMedia=function(e){var t=e&&e.navigator;!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,a){t.mediaDevices.getUserMedia(e).then(r,a)}.bind(t))},r.shimRTCIceServerUrls=o,r.shimTrackEventTransceiver=s,r.shimCreateOfferLegacy=function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){"undefined"!=typeof e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=this.getTransceivers().find(function(e){return e.sender.track&&"audio"===e.sender.track.kind});!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0===e.offerToReceiveAudio&&!r&&this.addTransceiver("audio"),"undefined"!=typeof e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var a=this.getTransceivers().find(function(e){return e.sender.track&&"video"===e.sender.track.kind});!1===e.offerToReceiveVideo&&a?"sendrecv"===a.direction?a.setDirection?a.setDirection("sendonly"):a.direction="sendonly":"recvonly"===a.direction&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive"):!0===e.offerToReceiveVideo&&!a&&this.addTransceiver("video")}return t.apply(this,arguments)}};var d=e("../utils"),c=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(d)},{"../utils":15}],15:[function(e,t,r){/**
         * Extract browser version out of the provided user agent string.
         *
         * @param {!string} uastring userAgent string.
         * @param {!string} expr Regular expression used as match criteria.
         * @param {!number} pos position in the version string to be returned.
         * @return {!number} browser version.
         */function a(e,t,r){var a=e.match(t);return a&&a.length>=r&&parseInt(a[r],10)}// Wraps the peerconnection event eventNameToWrap in a function
// which returns the modified event object (or false to prevent
// the event).
function n(){if("object"===("undefined"==typeof window?"undefined":s(window))){if(i)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}/**
         * Shows a deprecation warning suggesting the modern and spec-compatible API.
         */function o(e,t){d&&console.warn(e+" is deprecated, please use "+t+" instead.")}/**
         * Browser detector.
         *
         * @return {object} result containing browser and version
         *     properties.
         */Object.defineProperty(r,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"===p(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":p(e)};r.extractVersion=a,r.wrapPeerConnectionEvent=function(e,t,r){if(e.RTCPeerConnection){var a=e.RTCPeerConnection.prototype,n=a.addEventListener;a.addEventListener=function(e,a){if(e!==t)return n.apply(this,arguments);var o=function(t){var e=r(t);e&&a(e)};return this._eventMap=this._eventMap||{},this._eventMap[a]=o,n.apply(this,[e,o])};var o=a.removeEventListener;a.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return o.apply(this,arguments);var a=this._eventMap[r];return delete this._eventMap[r],o.apply(this,[e,a])},Object.defineProperty(a,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},r.disableLog=function(e){return"boolean"==typeof e?(i=e,e?"adapter.js logging disabled":"adapter.js logging enabled"):new Error("Argument type: "+("undefined"==typeof e?"undefined":s(e))+". Please use a boolean.")}/**
         * Disable or enable deprecation warnings
         * @param {!boolean} bool set to true to disable warnings.
         */,r.disableWarnings=function(e){return"boolean"==typeof e?(d=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled")):new Error("Argument type: "+("undefined"==typeof e?"undefined":s(e))+". Please use a boolean.")},r.log=n,r.deprecated=o,r.detectBrowser=function(e){var t=e.navigator,r={browser:null,version:null};// Returned result object.
// Fail early if it's not a browser
if("undefined"==typeof e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=a(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)r.browser="chrome",r.version=a(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=a(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(e.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))r.browser="safari",r.version=a(t.userAgent,/AppleWebKit\/(\d+)\./,1);else return r.browser="Not a supported browser.",r;return r};var i=!0,d=!0},{}],16:[function(t,r){function a(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type}function n(e,t,r,a,n){var o=p.writeRtpDescription(e.kind,t);// Map ICE parameters (ufrag, pwd) to SDP.
if(o+=p.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=p.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":n||"active"),o+="a=mid:"+e.mid+"\r\n",o+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var s=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=s;// spec.
var i="msid:"+(a?a.id:"-")+" "+s+"\r\n";o+="a="+i,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+i,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+i,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}// FIXME: this should be written by writeRtpDescription.
return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+p.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+p.localCName+"\r\n"),o}// Edge does not like
// 1) stun: filtered after 14393 unless ?transport=udp is present
// 2) turn: that does not have all of turn:host:port?transport=udp
// 3) turn: with ipv6 addresses
// 4) turn: occurring muliple times
function o(e,t){var r=!1;return e=JSON.parse(JSON.stringify(e)),e.filter(function(e){if(e&&(e.urls||e.url)){var a=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var n="string"==typeof a;return n&&(a=[a]),a=a.filter(function(e){var a=0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!r;return a?(r=!0,!0):0===e.indexOf("stun:")&&14393<=t&&-1===e.indexOf("?transport=udp")}),delete e.url,e.urls=n?a[0]:a,!!a.length}})}// Determines the intersection of local and remote capabilities.
function s(t,r){var a={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},o=function(e,t,r,a){var o=n(e.parameters.apt,r),s=n(t.parameters.apt,a);return o&&s&&o.name.toLowerCase()===s.name.toLowerCase()};// FIXME: fecMechanisms
return t.codecs.forEach(function(n){for(var s=0,d;s<r.codecs.length;s++)if(d=r.codecs[s],n.name.toLowerCase()===d.name.toLowerCase()&&n.clockRate===d.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&d.parameters.apt&&!o(n,d,t.codecs,r.codecs))// for RTX we need to find the local rtx that has a apt
// which points to the same local codec as the remote one.
continue;d=JSON.parse(JSON.stringify(d)),d.numChannels=e(n.numChannels,d.numChannels),a.codecs.push(d),d.rtcpFeedback=d.rtcpFeedback.filter(function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});// FIXME: also need to determine .parameters
//  see https://github.com/openpeer/ortc/issues/569
break}}),t.headerExtensions.forEach(function(e){for(var t=0,n;t<r.headerExtensions.length;t++)if(n=r.headerExtensions[t],e.uri===n.uri){a.headerExtensions.push(n);break}}),a}// is action=setLocalDescription with type allowed in signalingState
function i(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function d(e,t){// Edge's internal representation adds some fields therefore
// not all fieldѕ are taken into account.
var r=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return r||e.addRemoteCandidate(t),!r}function c(t,r){var a=new Error(r);return a.name=t,a.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[t],a}var p=t("sdp");r.exports=function(e,t){// https://w3c.github.io/mediacapture-main/#mediastream
// Helper function to add the track to the stream and
// dispatch the event ourselves.
function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function m(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}function l(t,r,a,n){var o=new Event("track");o.track=r,o.receiver=a,o.transceiver={receiver:a},o.streams=n,e.setTimeout(function(){t._dispatchEvent("track",o)})}var g=function(r){var a=this,n=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){a[e]=n[e].bind(n)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");else r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require");switch(r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all";}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced";}if(r.iceServers=o(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var s=r.iceCandidatePoolSize;0<s;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=p.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(g.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(g.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),g.prototype.onicecandidate=null,g.prototype.onaddstream=null,g.prototype.ontrack=null,g.prototype.onremovestream=null,g.prototype.onsignalingstatechange=null,g.prototype.oniceconnectionstatechange=null,g.prototype.onconnectionstatechange=null,g.prototype.onicegatheringstatechange=null,g.prototype.onnegotiationneeded=null,g.prototype.ondatachannel=null,g.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},g.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},g.prototype.getConfiguration=function(){return this._config},g.prototype.getLocalStreams=function(){return this.localStreams},g.prototype.getRemoteStreams=function(){return this.remoteStreams},g.prototype._createTransceiver=function(e,t){var r=0<this.transceivers.length,a={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)a.iceTransport=this.transceivers[0].iceTransport,a.dtlsTransport=this.transceivers[0].dtlsTransport;else{var n=this._createIceAndDtlsTransports();a.iceTransport=n.iceTransport,a.dtlsTransport=n.dtlsTransport}return t||this.transceivers.push(a),a},g.prototype.addTrack=function(t,r){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var a=this.transceivers.find(function(e){return e.track===t});if(a)throw c("InvalidAccessError","Track already exists.");for(var n=0,o;n<this.transceivers.length;n++)this.transceivers[n].track||this.transceivers[n].kind!==t.kind||(o=this.transceivers[n]);return o||(o=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),o.track=t,o.stream=r,o.rtpSender=new e.RTCRtpSender(t,o.dtlsTransport),o.rtpSender},g.prototype.addStream=function(e){var r=this;if(15025<=t)e.getTracks().forEach(function(t){r.addTrack(t,e)});else{// Clone is necessary for local demos mostly, attaching directly
// to two different senders does not work (build 10547).
// Fixed in 15025 (or earlier)
var a=e.clone();e.getTracks().forEach(function(e,t){var r=a.getTracks()[t];e.addEventListener("enabled",function(e){r.enabled=e.enabled})}),a.getTracks().forEach(function(e){r.addTrack(e,a)})}},g.prototype.removeTrack=function(r){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(r instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var a=this.transceivers.find(function(e){return e.rtpSender===r});if(!a)throw c("InvalidAccessError","Sender was not created by this connection.");var n=a.stream;a.rtpSender.stop(),a.rtpSender=null,a.track=null,a.stream=null;// remove the stream from the set of local streams
var o=this.transceivers.map(function(e){return e.stream});-1===o.indexOf(n)&&-1<this.localStreams.indexOf(n)&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},g.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var r=t.getSenders().find(function(t){return t.track===e});r&&t.removeTrack(r)})},g.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},g.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},g.prototype._createIceGatherer=function(t,r){var a=this;if(r&&0<t)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var n=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(n,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;// polyfill since RTCIceGatherer.state is not implemented in
// Edge 10547 yet.
n.state=r?"completed":"gathering",null!==a.transceivers[t].bufferedCandidateEvents&&a.transceivers[t].bufferedCandidateEvents.push(e)},n.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),n},g.prototype._gather=function(t,r){var a=this,n=this.transceivers[r].iceGatherer;if(!n.onlocalcandidate){var o=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,n.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),n.onlocalcandidate=function(e){if(!(a.usingBundle&&0<r))// if we know that we use bundle we can drop candidates with
// ѕdpMLineIndex > 0. If we don't do this then our state gets
// confused since we dispose the extra ice gatherer.
{var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:r};var s=e.candidate,i=!s||0===Object.keys(s).length;// Edge emits an empty object for RTCIceCandidateComplete‥
if(i)("new"===n.state||"gathering"===n.state)&&(n.state="completed");else{"new"===n.state&&(n.state="gathering"),s.component=1,s.ufrag=n.getLocalParameters().usernameFragment;var d=p.writeCandidate(s);o.candidate=Object.assign(o.candidate,p.parseCandidate(d)),o.candidate.candidate=d,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}// update local description.
var c=p.getMediaSections(a._localDescription.sdp);c[o.candidate.sdpMLineIndex]+=i?"a=end-of-candidates\r\n":"a="+o.candidate.candidate+"\r\n",a._localDescription.sdp=p.getDescription(a._localDescription.sdp)+c.join("");var m=a.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==a.iceGatheringState&&(a.iceGatheringState="gathering",a._emitGatheringStateChange()),i||a._dispatchEvent("icecandidate",o),m&&(a._dispatchEvent("icecandidate",new Event("icecandidate")),a.iceGatheringState="complete",a._emitGatheringStateChange())}},e.setTimeout(function(){o.forEach(function(t){n.onlocalcandidate(t)})},0)}},g.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var a=new e.RTCDtlsTransport(r);return a.ondtlsstatechange=function(){t._updateConnectionState()},a.onerror=function(){Object.defineProperty(a,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:a}},g.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var a=this.transceivers[e].dtlsTransport;a&&(delete a.ondtlsstatechange,delete a.onerror,delete this.transceivers[e].dtlsTransport)},g.prototype._transceive=function(e,r,a){var n=s(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(n.encodings=e.sendEncodingParameters,n.rtcp={cname:p.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(n.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(n)),a&&e.rtpReceiver&&0<n.codecs.length&&("video"===e.kind&&e.recvEncodingParameters&&15019>t&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),n.encodings=e.recvEncodingParameters.length?e.recvEncodingParameters:[{}],n.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(n.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(n.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(n))},g.prototype.setLocalDescription=function(e){var t=this;// Note: pranswer is not supported.
if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError","Unsupported type \""+e.type+"\""));if(!i("setLocalDescription",e.type,t.signalingState)||t._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+t.signalingState));var r,a;if("offer"===e.type)r=p.splitSections(e.sdp),a=r.shift(),r.forEach(function(e,r){var a=p.parseRtpParameters(e);t.transceivers[r].localCapabilities=a}),t.transceivers.forEach(function(e,r){t._gather(e.mid,r)});else if("answer"===e.type){r=p.splitSections(t._remoteDescription.sdp),a=r.shift();var n=0<p.matchPrefix(a,"a=ice-lite").length;r.forEach(function(e,r){var o=t.transceivers[r],i=o.iceGatherer,d=o.iceTransport,c=o.dtlsTransport,m=o.localCapabilities,l=o.remoteCapabilities,g=p.isRejected(e)&&0===p.matchPrefix(e,"a=bundle-only").length;if(!g&&!o.rejected){var u=p.getIceParameters(e,a),E=p.getDtlsParameters(e,a);n&&(E.role="server"),t.usingBundle&&0!==r||(t._gather(o.mid,r),"new"===d.state&&d.start(i,u,n?"controlling":"controlled"),"new"===c.state&&c.start(E));// Calculate intersection of capabilities.
var R=s(m,l);// Start the RTCRtpSender. The RTCRtpReceiver for this
// transceiver has already been started in setRemoteDescription.
t._transceive(o,0<R.codecs.length,!1)}})}return t._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?t._updateSignalingState("have-local-offer"):t._updateSignalingState("stable"),Promise.resolve()},g.prototype.setRemoteDescription=function(a){var n=this;// Note: pranswer is not supported.
if(-1===["offer","answer"].indexOf(a.type))return Promise.reject(c("TypeError","Unsupported type \""+a.type+"\""));if(!i("setRemoteDescription",a.type,n.signalingState)||n._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+a.type+" in state "+n.signalingState));var o={};n.remoteStreams.forEach(function(e){o[e.id]=e});var g=[],u=p.splitSections(a.sdp),E=u.shift(),R=0<p.matchPrefix(E,"a=ice-lite").length,S=0<p.matchPrefix(E,"a=group:BUNDLE ").length;n.usingBundle=S;var T=p.matchPrefix(E,"a=ice-options:")[0];return n.canTrickleIceCandidates=!!T&&0<=T.substr(14).split(" ").indexOf("trickle"),u.forEach(function(i,c){var l=p.splitLines(i),u=p.getKind(i),T=p.isRejected(i)&&0===p.matchPrefix(i,"a=bundle-only").length,_=l[0].substr(2).split(" ")[2],h=p.getDirection(i,E),y=p.parseMsid(i),f=p.getMid(i)||p.generateIdentifier();// Reject datachannels which are not implemented yet.
if(T||"application"===u&&("DTLS/SCTP"===_||"UDP/DTLS/SCTP"===_))return void(n.transceivers[c]={mid:f,kind:u,protocol:_,rejected:!0});!T&&n.transceivers[c]&&n.transceivers[c].rejected&&(n.transceivers[c]=n._createTransceiver(u,!0));var C=p.parseRtpParameters(i),v,I,A,D,O,L,M,b,k,U,P;T||(U=p.getIceParameters(i,E),P=p.getDtlsParameters(i,E),P.role="client"),M=p.parseRtpEncodingParameters(i);var N=p.parseRtcpParameters(i),x=0<p.matchPrefix(i,"a=end-of-candidates",E).length,w=p.matchPrefix(i,"a=candidate:").map(function(e){return p.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===a.type||"answer"===a.type)&&!T&&S&&0<c&&n.transceivers[c]&&(n._disposeIceAndDtlsTransports(c),n.transceivers[c].iceGatherer=n.transceivers[0].iceGatherer,n.transceivers[c].iceTransport=n.transceivers[0].iceTransport,n.transceivers[c].dtlsTransport=n.transceivers[0].dtlsTransport,n.transceivers[c].rtpSender&&n.transceivers[c].rtpSender.setTransport(n.transceivers[0].dtlsTransport),n.transceivers[c].rtpReceiver&&n.transceivers[c].rtpReceiver.setTransport(n.transceivers[0].dtlsTransport)),"offer"===a.type&&!T){v=n.transceivers[c]||n._createTransceiver(u),v.mid=f,v.iceGatherer||(v.iceGatherer=n._createIceGatherer(c,S)),w.length&&"new"===v.iceTransport.state&&(x&&(!S||0===c)?v.iceTransport.setRemoteCandidates(w):w.forEach(function(e){d(v.iceTransport,e)})),b=e.RTCRtpReceiver.getCapabilities(u),15019>t&&(b.codecs=b.codecs.filter(function(e){return"rtx"!==e.name})),L=v.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];// TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams
var B=!1;if("sendrecv"!==h&&"sendonly"!==h)v.rtpReceiver&&v.rtpReceiver.track&&(v.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===v.rtpReceiver.track.id});t&&m(t,e)}),v.associatedRemoteMediaStreams=[]);else if(B=!v.rtpReceiver,O=v.rtpReceiver||new e.RTCRtpReceiver(v.dtlsTransport,u),B){var V;// FIXME: does not work with Plan B.
if(k=O.track,y&&"-"===y.stream);else y?(o[y.stream]||(o[y.stream]=new e.MediaStream,Object.defineProperty(o[y.stream],"id",{get:function(){return y.stream}})),Object.defineProperty(k,"id",{get:function(){return y.track}}),V=o[y.stream]):(o.default||(o.default=new e.MediaStream),V=o.default);V&&(r(k,V),v.associatedRemoteMediaStreams.push(V)),g.push([k,O,V])}v.localCapabilities=b,v.remoteCapabilities=C,v.rtpReceiver=O,v.rtcpParameters=N,v.sendEncodingParameters=L,v.recvEncodingParameters=M,n._transceive(n.transceivers[c],!1,B)}else if("answer"===a.type&&!T){v=n.transceivers[c],I=v.iceGatherer,A=v.iceTransport,D=v.dtlsTransport,O=v.rtpReceiver,L=v.sendEncodingParameters,b=v.localCapabilities,n.transceivers[c].recvEncodingParameters=M,n.transceivers[c].remoteCapabilities=C,n.transceivers[c].rtcpParameters=N,w.length&&"new"===A.state&&((R||x)&&(!S||0===c)?A.setRemoteCandidates(w):w.forEach(function(e){d(v.iceTransport,e)})),S&&0!==c||("new"===A.state&&A.start(I,U,"controlling"),"new"===D.state&&D.start(P));// If the offer contained RTX but the answer did not,
// remove RTX from sendEncodingParameters.
var G=s(v.localCapabilities,v.remoteCapabilities),j=G.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length;!j&&v.sendEncodingParameters[0].rtx&&delete v.sendEncodingParameters[0].rtx,n._transceive(v,"sendrecv"===h||"recvonly"===h,"sendrecv"===h||"sendonly"===h),O&&("sendrecv"===h||"sendonly"===h)?(k=O.track,y?(!o[y.stream]&&(o[y.stream]=new e.MediaStream),r(k,o[y.stream]),g.push([k,O,o[y.stream]])):(!o.default&&(o.default=new e.MediaStream),r(k,o.default),g.push([k,O,o.default]))):delete v.rtpReceiver}}),void 0===n._dtlsRole&&(n._dtlsRole="offer"===a.type?"active":"passive"),n._remoteDescription={type:a.type,sdp:a.sdp},"offer"===a.type?n._updateSignalingState("have-remote-offer"):n._updateSignalingState("stable"),Object.keys(o).forEach(function(t){var r=o[t];if(r.getTracks().length){if(-1===n.remoteStreams.indexOf(r)){n.remoteStreams.push(r);var a=new Event("addstream");a.stream=r,e.setTimeout(function(){n._dispatchEvent("addstream",a)})}g.forEach(function(e){var t=e[0],a=e[1];r.id!==e[2].id||l(n,t,a,[r])})}}),g.forEach(function(e){e[2]||l(n,e[0],e[1],[])}),e.setTimeout(function(){n&&n.transceivers&&n.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&0<e.iceTransport.getRemoteCandidates().length&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},g.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},g.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},g.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"!==this.signalingState||!0===this.needNegotiation||(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},g.prototype._updateIceConnectionState=function(){var e={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0},t;if(this.transceivers.forEach(function(t){t.iceTransport&&!t.rejected&&e[t.iceTransport.state]++}),t="new",0<e.failed?t="failed":0<e.checking?t="checking":0<e.disconnected?t="disconnected":0<e.new?t="new":0<e.connected?t="connected":0<e.completed&&(t="completed"),t!==this.iceConnectionState){this.iceConnectionState=t;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},g.prototype._updateConnectionState=function(){var e={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0},t;if(this.transceivers.forEach(function(t){t.iceTransport&&t.dtlsTransport&&!t.rejected&&(e[t.iceTransport.state]++,e[t.dtlsTransport.state]++)}),e.connected+=e.completed,t="new",0<e.failed?t="failed":0<e.connecting?t="connecting":0<e.disconnected?t="disconnected":0<e.new?t="new":0<e.connected&&(t="connected"),t!==this.connectionState){this.connectionState=t;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},g.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var a=r.transceivers.filter(function(e){return"audio"===e.kind}).length,o=r.transceivers.filter(function(e){return"video"===e.kind}).length,s=arguments[0];if(s){// Reject Chrome legacy constraints.
if(s.mandatory||s.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==s.offerToReceiveAudio&&(!0===s.offerToReceiveAudio?a=1:!1===s.offerToReceiveAudio?a=0:a=s.offerToReceiveAudio),void 0!==s.offerToReceiveVideo&&(!0===s.offerToReceiveVideo?o=1:!1===s.offerToReceiveVideo?o=0:o=s.offerToReceiveVideo)}// Create M-lines for recvonly streams.
for(r.transceivers.forEach(function(e){"audio"===e.kind?(a--,0>a&&(e.wantReceive=!1)):"video"===e.kind&&(o--,0>o&&(e.wantReceive=!1))});0<a||0<o;)0<a&&(r._createTransceiver("audio"),a--),0<o&&(r._createTransceiver("video"),o--);var i=p.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach(function(a,n){// For each track, create an ice gatherer, ice transport,
// dtls transport, potentially rtpsender and rtpreceiver.
var o=a.track,s=a.kind,i=a.mid||p.generateIdentifier();a.mid=i,a.iceGatherer||(a.iceGatherer=r._createIceGatherer(n,r.usingBundle));var d=e.RTCRtpSender.getCapabilities(s);// filter RTX until additional stuff needed for RTX is implemented
// in adapter.js
15019>t&&(d.codecs=d.codecs.filter(function(e){return"rtx"!==e.name})),d.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),a.remoteCapabilities&&a.remoteCapabilities.codecs&&a.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),d.headerExtensions.forEach(function(e){var t=a.remoteCapabilities&&a.remoteCapabilities.headerExtensions||[];t.forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});// generate an ssrc now, to be used later in rtpSender.send
var c=a.sendEncodingParameters||[{ssrc:1001*(2*n+1)}];o&&15019<=t&&"video"===s&&!c[0].rtx&&(c[0].rtx={ssrc:c[0].ssrc+1}),a.wantReceive&&(a.rtpReceiver=new e.RTCRtpReceiver(a.dtlsTransport,s)),a.localCapabilities=d,a.sendEncodingParameters=c}),"max-compat"!==r._config.bundlePolicy&&(i+="a=group:BUNDLE "+r.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),i+="a=ice-options:trickle\r\n",r.transceivers.forEach(function(e,t){i+=n(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),i+="a=rtcp-rsize\r\n",e.iceGatherer&&"new"!==r.iceGatheringState&&(0===t||!r.usingBundle)&&(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,i+="a="+p.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(i+="a=end-of-candidates\r\n"))});var d=new e.RTCSessionDescription({type:"offer",sdp:i});return Promise.resolve(d)},g.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var a=p.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(a+="a=group:BUNDLE "+r.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),a+="a=ice-options:trickle\r\n";var o=p.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach(function(e,i){if(!(i+1>o)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?a+="m=application 0 DTLS/SCTP 5000\r\n":a+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?a+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(a+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(a+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");// FIXME: look at direction.
if(e.stream){var d;"audio"===e.kind?d=e.stream.getAudioTracks()[0]:"video"===e.kind&&(d=e.stream.getVideoTracks()[0]),d&&15019<=t&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1})}// Calculate intersection of capabilities.
var c=s(e.localCapabilities,e.remoteCapabilities),p=c.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length;!p&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,a+=n(e,c,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(a+="a=rtcp-rsize\r\n")}});var i=new e.RTCSessionDescription({type:"answer",sdp:a});return Promise.resolve(i)},g.prototype.addIceCandidate=function(e){var t=this,r;return e&&!(void 0!==e.sdpMLineIndex||e.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(a,n){if(!t._remoteDescription)return n(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(!e||""===e.candidate)for(var o=0;o<t.transceivers.length&&(t.transceivers[o].rejected||(t.transceivers[o].iceTransport.addRemoteCandidate({}),r=p.getMediaSections(t._remoteDescription.sdp),r[o]+="a=end-of-candidates\r\n",t._remoteDescription.sdp=p.getDescription(t._remoteDescription.sdp)+r.join(""),!t.usingBundle));o++);else{var s=e.sdpMLineIndex;if(e.sdpMid)for(var m=0;m<t.transceivers.length;m++)if(t.transceivers[m].mid===e.sdpMid){s=m;break}var l=t.transceivers[s];if(l){if(l.rejected)return a();var g=0<Object.keys(e.candidate).length?p.parseCandidate(e.candidate):{};// Ignore Chrome's invalid candidates since Edge does not like them.
if("tcp"===g.protocol&&(0===g.port||9===g.port))return a();// Ignore RTCP candidates, we assume RTCP-MUX.
if(g.component&&1!==g.component)return a();// when using bundle, avoid adding candidates to the wrong
// ice transport. And avoid adding candidates added in the SDP.
if((0===s||0<s&&l.iceTransport!==t.transceivers[0].iceTransport)&&!d(l.iceTransport,g))return n(c("OperationError","Can not add ICE candidate"));// update the remoteDescription.
var u=e.candidate.trim();0===u.indexOf("a=")&&(u=u.substr(2)),r=p.getMediaSections(t._remoteDescription.sdp),r[s]+="a="+(g.type?u:"end-of-candidates")+"\r\n",t._remoteDescription.sdp=p.getDescription(t._remoteDescription.sdp)+r.join("")}else return n(c("OperationError","Can not add ICE candidate"))}a()});// TODO: needs to go into ops queue.
},g.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)}),!r)throw c("InvalidAccessError","Invalid selector.");return r.getStats()}var a=[];return this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){e[t]&&a.push(e[t].getStats())})}),Promise.all(a).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(r){e[r].type=a(e[r]),t.set(r,e[r])}),t})}}});// legacy callback shims. Should be moved to adapter.js some days.
var u=["createOffer","createAnswer"];return u.forEach(function(e){var t=g.prototype[e];g.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),u=["setLocalDescription","setRemoteDescription","addIceCandidate"],u.forEach(function(e){var t=g.prototype[e];g.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=g.prototype[e];g.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),g}},{sdp:17}],17:[function(e,t){// SDP helpers.
var r={};// Generate an alphanumeric identifier for cname or mids.
// TODO: use UUIDs instead? https://gist.github.com/jed/982883
r.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},r.localCName=r.generateIdentifier(),r.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},r.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(0<t?"m="+e:e).trim()+"\r\n"})},r.getDescription=function(e){var t=r.splitSections(e);return t&&t[0]},r.getMediaSections=function(e){var t=r.splitSections(e);return t.shift(),t},r.matchPrefix=function(e,t){return r.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},r.parseCandidate=function(e){var t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");// Parse both variants.
for(var r={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],// address is an alias for ip.
port:parseInt(t[5],10),// skip parts[6] == 'typ'
type:t[7]},a=8;a<t.length;a+=2)switch(t[a]){case"raddr":r.relatedAddress=t[a+1];break;case"rport":r.relatedPort=parseInt(t[a+1],10);break;case"tcptype":r.tcpType=t[a+1];break;case"ufrag":r.ufrag=t[a+1],r.usernameFragment=t[a+1];break;default:r[t[a]]=t[a+1];}return r},r.writeCandidate=function(e){var t=[e.foundation,e.component,e.protocol.toUpperCase(),e.priority,e.address||e.ip,e.port],r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},r.parseIceOptions=function(e){return e.substr(14).split(" ")},r.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)// was: id
};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},r.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1===r?"":"/"+r)+"\r\n"},r.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:0<t[0].indexOf("/")?t[0].split("/")[1]:"sendrecv",uri:t[1]}},r.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},r.parseFmtp=function(e){for(var t={},r=e.substr(e.indexOf(" ")+1).split(";"),a=0,n;a<r.length;a++)n=r[a].trim().split("="),t[n[0].trim()]=n[1];return t},r.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var a=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?a.push(t+"="+e.parameters[t]):a.push(t)}),t+="a=fmtp:"+r+" "+a.join(";")+"\r\n"}return t},r.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},r.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},r.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},a=e.indexOf(":",t);return-1<a?(r.attribute=e.substr(t+1,a-t-1),r.value=e.substr(a+1)):r.attribute=e.substr(t+1),r},r.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},r.getMid=function(e){var t=r.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},r.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),// algorithm is case-sensitive in Edge.
value:t[1]}},r.getDtlsParameters=function(e,t){var a=r.matchPrefix(e+t,"a=fingerprint:");// Note: a=setup line is ignored since we use the 'auto' role.
// Note2: 'algorithm' is not case sensitive except in Edge.
return{role:"auto",fingerprints:a.map(r.parseFingerprint)}},r.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),r},r.getIceParameters=function(e,t){var a=r.splitLines(e);// Search in session part, too.
a=a.concat(r.splitLines(t));var n={usernameFragment:a.filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:a.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)};return n},r.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},r.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},a=r.splitLines(e),n=a[0].split(" "),o=3;o<n.length;o++){// find all codecs from mline[3..]
var s=n[o],d=r.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(d){var c=r.parseRtpMap(d),p=r.matchPrefix(e,"a=fmtp:"+s+" ");// parse FEC mechanisms from rtpmap lines.
switch(c.parameters=p.length?r.parseFmtp(p[0]):{},c.rtcpFeedback=r.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(r.parseRtcpFb),t.codecs.push(c),c.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(c.name.toUpperCase());break;default:}}}// FIXME: parse rtcp.
return r.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(r.parseExtmap(e))}),t},r.writeRtpDescription=function(e,t){var a="";// Build the mline.
a+="m="+e+" ",a+=0<t.codecs.length?"9":"0",a+=" UDP/TLS/RTP/SAVPF ",a+=t.codecs.map(function(e){return void 0===e.preferredPayloadType?e.payloadType:e.preferredPayloadType}).join(" ")+"\r\n",a+="c=IN IP4 0.0.0.0\r\n",a+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){a+=r.writeRtpMap(e),a+=r.writeFmtp(e),a+=r.writeRtcpFb(e)});var n=0;// FIXME: write fecMechanisms.
return t.codecs.forEach(function(e){e.maxptime>n&&(n=e.maxptime)}),0<n&&(a+="a=maxptime:"+n+"\r\n"),a+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){a+=r.writeExtmap(e)}),a},r.parseRtpEncodingParameters=function(e){var t=[],a=r.parseRtpParameters(e),n=-1!==a.fecMechanisms.indexOf("RED"),o=-1!==a.fecMechanisms.indexOf("ULPFEC"),s=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),i=0<s.length&&s[0].ssrc,d=r.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.substr(17).split(" ");return t.map(function(e){return parseInt(e,10)})}),c;0<d.length&&1<d[0].length&&d[0][0]===i&&(c=d[0][1]),a.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var r={ssrc:i,codecPayloadType:parseInt(e.parameters.apt,10)};i&&c&&(r.rtx={ssrc:c}),t.push(r),n&&(r=JSON.parse(JSON.stringify(r)),r.fec={ssrc:i,mechanism:o?"red+ulpfec":"red"},t.push(r))}}),0===t.length&&i&&t.push({ssrc:i});// we support both b=AS and b=TIAS but interpret AS as TIAS.
var p=r.matchPrefix(e,"b=");return p.length&&(p=0===p[0].indexOf("b=TIAS:")?parseInt(p[0].substr(7),10):0===p[0].indexOf("b=AS:")?.95*(1e3*parseInt(p[0].substr(5),10))-16000:void 0,t.forEach(function(e){e.maxBitrate=p})),t},r.parseRtcpParameters=function(e){var t={},a=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];// Gets the first SSRC. Note tha with RTX there might be multiple
// SSRCs.
a&&(t.cname=a.value,t.ssrc=a.ssrc);// Edge uses the compound attribute instead of reducedSize
// compound is !reducedSize
var n=r.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=0<n.length,t.compound=0===n.length;// parses the rtcp-mux attrіbute.
// Note that Edge does not support unmuxed RTCP.
var o=r.matchPrefix(e,"a=rtcp-mux");return t.mux=0<o.length,t},r.parseMsid=function(e){var t=r.matchPrefix(e,"a=msid:"),a;if(1===t.length)return a=t[0].substr(7).split(" "),{stream:a[0],track:a[1]};var n=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});if(0<n.length)return a=n[0].value.split(" "),{stream:a[0],track:a[1]}},r.generateSessionId=function(){return Math.random().toString().substr(2,21)},r.writeSessionBoilerplate=function(e,t,a){var n=void 0===t?2:t,o;o=e?e:r.generateSessionId();// FIXME: sess-id should be an NTP timestamp.
return"v=0\r\no="+(a||"thisisadapterortc")+" "+o+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},r.writeMediaSection=function(e,t,a,n){var o=r.writeRtpDescription(e.kind,t);// Map ICE parameters (ufrag, pwd) to SDP.
if(o+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===a?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",o+=e.direction?"a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){// spec.
var s="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+s,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}// FIXME: this should be written by writeRtpDescription.
return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),o},r.getDirection=function(e,t){// Look for sendrecv, sendonly, recvonly, inactive, default to sendrecv.
for(var a=r.splitLines(e),n=0;n<a.length;n++)switch(a[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return a[n].substr(2);default:// FIXME: What should happen here?
}return t?r.getDirection(t):"sendrecv"},r.getKind=function(e){var t=r.splitLines(e),a=t[0].split(" ");return a[0].substr(2)},r.isRejected=function(e){return"0"===e.split(" ",2)[1]},r.parseMLine=function(e){var t=r.splitLines(e),a=t[0].substr(2).split(" ");return{kind:a[0],port:parseInt(a[1],10),protocol:a[2],fmt:a.slice(3).join(" ")}},r.parseOLine=function(e){var t=r.matchPrefix(e,"o=")[0],a=t.substr(2).split(" ");return{username:a[0],sessionId:a[1],sessionVersion:parseInt(a[2],10),netType:a[3],addressType:a[4],address:a[5]}},r.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=r.splitLines(e),a=0;a<t.length;a++)if(2>t[a].length||"="!==t[a].charAt(1))return!1;// TODO: check the modifier a bit more.
return!0},"object"===("undefined"==typeof t?"undefined":p(t))&&(t.exports=r)},{}]},{},[1])(1)}function c(e){var t=null,r=0,a=w.Cache(),n=w.Cache(),o=function(e,t){var r=e.getTracks(),n=t.id,o=t.stream.tag;w.forEach(r,function(e){var t=e.id;a.set(t,{id:n,stream:{tag:o}})})},s=function(e){var t=Math.floor;e=e||0;var r=t(e/1e3);return r>=re.length&&(r=0),re[r]},i=function(t){var r=t.googTrackId,o=t.mediaType;if(w.isEqual(o,"audio")){// 不区分 Input、Output 最终对应用层按 user 暴露
var i=t.audioOutputLevel||t.audioInputLevel;i=s(i);var d=n.get(r);if(!w.isEqual(d,i)){var c=a.get(r);w.isObject(c)&&(w.extend(c.stream,{audioLevel:i}),n.set(r,i),e.emit(B.REPORT_SPOKE,c))}}},d=function(e){w.forEach(e,function(e){var t=e.type;w.isInclude(t,"ssrc")&&i(e)})},c=function(){r&&clearInterval(r)},p=ct.getInstance();p&&(t=p),e.on(We.PEERCONN_CREATED,function(e,r){if(e)throw e;t=r}),e.on(We.PEERCONN_DESTROYED,function(e){if(e)throw e;c()}),e.on(We.LEFT,function(){a.clear(),n.clear(),c()}),e.on(We.PUBLISHED_STREAM,function(e,t){if(e)throw e;var r=t.mediaStream,a=t.user;o(r,a)});var m=function(e){var a={frequency:1000};if(w.isObject(e)&&w.extend(a,e),!ke())return r&&c(),r=setInterval(function(){return t?void t.getStats(function(e){d(e)}):c()},a.frequency),w.Defer.resolve()},l=function(){return c(),w.Defer.resolve()};return{dispatch:function(e,t){return e===V.REPORT_START?m.apply(void 0,R(t)):e===V.REPORT_STOP?l.apply(void 0,R(t)):void 0}}}var p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},l=function(){function e(e,t){for(var r=0,a;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),g=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},u=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&("object"==typeof t||"function"==typeof t)?t:e},E=function(){function e(e,t){var r=[],a=!0,n=!1,o=void 0;try{for(var s=e[Symbol.iterator](),i;!(a=(i=s.next()).done)&&(r.push(i.value),!(t&&r.length===t));a=!0);}catch(e){n=!0,o=e}finally{try{!a&&s["return"]&&s["return"]()}finally{if(n)throw o}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),R=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},S=function(){},T=function(e){return"[object Object]"===Object.prototype.toString.call(e)},_=function(e){return"[object Array]"===Object.prototype.toString.call(e)},h=function(e){return"[object Function]"===Object.prototype.toString.call(e)},y=function(e){return"[object String]"===Object.prototype.toString.call(e)},f=function(e){return"[object Undefined]"===Object.prototype.toString.call(e)},C=function(e){return"[object Number]"===Object.prototype.toString.call(e)},v=function(e){return JSON.stringify(e)},I=function(e){return JSON.parse(e)},A=function(e,t,r){r=r||{},t=t||S;var a=r,n=a.isReverse,o=function(){for(var r in e)t(e[r],r,e)},s=function(){if(n)for(var r=e.length-1;0<=r;r--)t(e[r],r);else for(var a=0,o=e.length;a<o;a++)t(e[a],a)};T(e)&&o(),_(e)&&s()},D=function(e,t){for(var r in t){var a=t[r];f(a)||(e[r]=a)}return e},O=Promise,L=function(e){return new O(e)},M=function(e,t){return e===t},b=function(e,t){return e.filter(t)},k=function(e){return JSON.parse(JSON.stringify(e))},U=console,P=function(e){var t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","g","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","G","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","+","/"],r=t.length+1,a=+e,n=[];do{var o=a%r;a=(a-o)/r,n.unshift(t[o])}while(a);return n.join("")},N=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),r="x"==e?t:8|3&t;return r.toString(16)})},x=function(){function e(e){// do not depend on value cause of '和0
return Object.prototype.hasOwnProperty.call(localStorage,e)||Object.prototype.hasOwnProperty.call(sessionStorage,e)}return{get:function(t){var r="rong-rtc-"+t;if(!e(r))return null;var a=localStorage.getItem(r)||sessionStorage.getItem(r);return a=JSON.parse(a),null!==a&&Object.prototype.hasOwnProperty.call(a,"type")&&Object.prototype.hasOwnProperty.call(a,"data")?a.data:null},set:function(e,t,r){var a;a=r?sessionStorage:localStorage,a.setItem("rong-rtc-"+e,JSON.stringify({data:t,type:"undefined"==typeof t?"undefined":p(t)}))},remove:function(e){var t="rong-rtc-"+e;localStorage.removeItem(t),sessionStorage.removeItem(t)}}}(),w={Prosumer:function(){var e=[],t=!1;this.produce=function(t){e.push(t)},this.consume=function(r,a){if(!t){t=!0;var n=function n(){var o=e.shift();return f(o)?(t=!1,void(a&&a())):void r(o,n)};n()}},this.isExeuting=function(){return t}}/* 
   prosumer.consume(function(data, next){
    //dosomething
    next();
   });
  */,Log:U,Observer:function(){var e=[];this.add=function(t,r){if(h(t)){if(r)return e=[t];e.push(t)}},this.remove=function(t){e=b(e,function(e){return e!==t})},this.emit=function(t){A(e,function(e){e(t)})}},Timer:function(e){e=e||{};var t={timeout:0,// interval | timeout
type:"interval"};D(t,e);var r=[],a=t.timeout,n=t.type,o={resume:{interval:function(e,t){return t&&e(),setInterval(e,a)},timeout:function(e,t){return t&&e(),setTimeout(e,a)}},pause:{interval:function(e){return clearInterval(e)},timeout:function(e){return clearTimeout(e)}}};this.resume=function(e,t){e=e||S;var a=o.resume,s=a[n](e,t);r.push(s)},this.pause=function(){var e=o.pause;A(r,function(t){e[n](t)})}},isUndefined:f,isBoolean:function(e){return"[object Boolean]"===Object.prototype.toString.call(e)},isString:y,isObject:T,isArray:_,isFunction:h,stringify:v,parse:I,rename:function(e,t){var r=T(e);r&&(e=[e]),e=I(v(e));var a=function(e,r,a){delete a[r],r=t[r],a[r]=e};return A(e,function(e){A(e,function(e,r,n){var o=(r in t);(o?a:S)(e,r,n)})}),T?e[0]:e},extend:D,clone:k,deferred:L,Defer:O,forEach:A,tplEngine:function(e,t,r){_(t)||(t=[t]);for(var a=[],n=function(t){return e.replace(r||/\\?\{([^}]+)\}/g,function(e,r){return"\\"===e.charAt(0)?e.slice(1):void 0===t[r]?"{"+r+"}":t[r]})},o=0,s=t.length;o<s;o++)a.push(n(t[o]));return a.join("")},isContain:function(e,t){return-1<e.indexOf(t)},noop:S,Cache:function(e){T(e)||(e={});var t=function(t,r){e[t]=r},r=function(t){return e[t]},a=function(t){delete e[t]},n=function(){var t=[];for(var r in e)t.push(r);return t};return{set:t,get:r,remove:a,getKeys:n,clear:function(){e={}}}},request:function(e,t){return L(function(r,a){t=t||{};var n=new XMLHttpRequest,o=t.method||"GET";n.open(o,e,!0);var s=t.headers||{};A(s,function(e,t){n.setRequestHeader(t,e)});var i=t.body||{},d=function(){return /^(200|202)$/.test(n.status)},c=t.timeout;c&&(n.timeout=c),n.onreadystatechange=function(){if(M(n.readyState,4)){var e=n.responseText;e=e||"{}";var t=JSON.parse(e);if(d())r(t);else{var o=n.status;D(t,{status:o}),a(t)}}},n.onerror=function(e){a(e)},n.send(i)})},map:function(e,t){return e.map(t)},filter:b,uniq:function(e,t){var r=[],a={};return e.forEach(function(e){var r=t(e);a[r.key]=r.value}),A(a,function(e){r.push(e)}),r},some:function(e,t){return e.some(t)},isEqual:M,isEmpty:function(e){var t=!0;return T(e)&&A(e,function(){t=!1}),(y(e)||_(e))&&(t=0===e.length),C(e)&&(t=0===e),t},toJSON:function(e){return JSON.stringify(e)},isInclude:function(e,t){return-1<e.indexOf(t)},isNull:function(e){return"[object Null]"===Object.prototype.toString.call(e)},isNumber:C,toArray:function(e){var t=[];return A(e,function(e,r){t.push([r,e])}),t},isPromise:function(e){var t=!1;try{t="[object Promise]"===Object.prototype.toString.call(e)||e&&e.then&&e.catch&&e.finally}catch(r){t=!1}return t},Index:function(){var e=0;this.add=function(){e+=1},this.get=function(){return e},this.reset=function(){e=0}},getBrowser:function(){var e=navigator.userAgent,t="",r="";return /(Msie|Firefox|Opera|Chrome|Netscape)\D+(\d[\d.]*)/.test(e)&&(t=RegExp.$1,r=RegExp.$2),/Version\D+(\d[\d.]*).*Safari/.test(e)&&(t="Safari",r=RegExp.$1),{name:t,version:r}},getUUID:N,getUUID22:function(){var e=N();return e=e.replace(/-/g,"")+"0",e=parseInt(e,16),e=P(e),22<e.length&&(e=e.slice(0,22)),e},Storage:x,handleObjKeys:function e(t,r){t=t||{};var a={};return A(t,function(t,n){var o=r?r(n):n;a[o]=T(t)?e(t,r):t}),a},lineToHump:function(e){return e.replace(/_(\w)/g,function(e,t){return t.toUpperCase()})},humpToLine:function(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase()},clearEselessFields:function e(t){t=t||{};var r=k(t);return A(r,function(t,a){f(t)?delete r[a]:T(t)&&(t=e(t))}),r},getKeys:function(e){var t=[];for(var r in e)t.push(r);return t},merge:function(e,t,r){r=r||{};var a=r.isReverse,n=[];return A(e,function(e){n.push(e)}),A(t,function(e){var t=n.indexOf(e);-1<t&&n.splice(t,1),a?n.unshift(e):n.push(e)},r),n},assert:function(e,t){for(var r=arguments.length,a=Array(2<r?r-2:0),n=2;n<r;n++)a[n-2]=arguments[n];/* eslint-disable no-console */if(console.assert){var o;(o=console).assert.apply(o,[e,t].concat(a))}/* eslint-enable no-console */return!!e}},B={ROOM_USER_JOINED:"room_user_joined",ROOM_USER_LEFT:"room_user_left",ROOM_USER_KICK:"room_user_kick",STREAM_PUBLISHED:"stream_published",STREAM_UNPUBLISHED:"stream_unpublished",STREAM_DISABLED:"stream_disabled",STREAM_ENABLED:"stream_enabled",STREAM_MUTED:"stream_muted",STREAM_UNMUTED:"stream_unmuted",RTC_ERROR:"rtc_error",RTC_MOUNTED:"rtc_mounted",RTC_UNMOUNTED:"rtc_unmounted",MESSAGE_RECEIVED:"message_received",REPORT_SPOKE:"report_spoke",MONITOR_STATS:"monitor_stats"},V={ROOM_JOIN:"room_join",ROOM_LEAVE:"room_leave",ROOM_GET:"room_get",ROOM_GET_SESSONID:"room_getsessionid",// 获取房间人员设备状态数据
ROOM_GET_STATS:"room_getstats",STREAM_PUBLISH:"stream_publish",STREAM_PUBLISH_DEFAULT:"stream_publish_default",STREAM_UNPUBLISH:"stream_UNPUBLISH",STREAM_SUBSCRIBE:"stream_subscribe",STREAM_UNSUBSCRIBE:"stream_unsubscribe",STREAM_RESIZE:"stream_resize",STREAM_GET:"stream_get",LIVE_CONFIG:"live_config",AUDIO_MUTE:"audio_mute",AUDIO_UNMUTE:"audio_unmute",VIDEO_DISABLE:"video_disable",VIDEO_ENABLE:"video_enable",STORAGE_SET:"strorage_set",STORAGE_GET:"strorage_get",STORAGE_REMOVE:"strorage_remove",MESSAGE_SEND:"message_send",DEVICE_GET:"device_get",REPORT_START:"report_start",REPORT_STOP:"report_stop",MONITOR_SET_FREQUENCY:"monitor_set_frequency"},G=[{name:B.ROOM_USER_JOINED,type:"joined"},{name:B.ROOM_USER_LEFT,type:"left"},{name:B.ROOM_USER_KICK,type:"kick"}],j=[{name:B.STREAM_PUBLISHED,type:"published"},{name:B.STREAM_UNPUBLISHED,type:"unpublished"},{name:B.STREAM_DISABLED,type:"disabled"},{name:B.STREAM_ENABLED,type:"enabled"},{name:B.STREAM_MUTED,type:"muted"},{name:B.STREAM_UNMUTED,type:"unmuted"}],F=[{name:B.MESSAGE_RECEIVED,type:"received"}],H=[{name:B.REPORT_SPOKE,type:"spoke"}],K=[{name:B.MONITOR_STATS,type:"stats"}],q=function(){var e={Inner:{},Outer:{}};return w.forEach([{code:1e4,name:"INSTANCE_IS_DESTROYED",msg:"RongRTC instance has been destroyed"},{code:5e4,name:"IM_NOT_CONNECTED",msg:"IM not connected"},{code:50001,name:"ROOM_ID_IS_ILLEGAL",msg:"The roomId is illegal and can contain only upper and lower case letters, Arabic numerals, +, =, -, _ and cannot exceed 64 characters in length"},{code:50002,name:"ROOM_REPEAT_JOIN",msg:"Not rejoin the room"},{code:50003,//50004,
name:"RTC_NOT_JOIN_ROOM",msg:"Please join the room first"},{code:50004,//50059,
name:"NO_AUDIO_AND_VIDEO_SERVICE",msg:"No audio and video services have been activated"},{code:50010,name:"",msg:"Http request timeout"},{code:50011,name:"",msg:"http response error"},// {
//   code: 50012,
//   name: '',
//   msg: 'Network unavailable'
// },
{code:50012,//50052,
name:"NETWORK_UNAVAILABLE",msg:"Network unavailable"},{code:50020,name:"",msg:"Resources has been published"},{code:50021,name:"SET_OFFER_ERROR",msg:"Set offer error"},{code:50022,name:"SET_ANSWER_ERROR",msg:"Set answer error"},{code:50023,name:"PUBLISH_STREAM_EXCEED_LIMIT",msg:"The maximum number of published resources has been reached"},{code:50024,name:"STREAM_NOT_EXIST",msg:"Stream not exist. Please check user.id\u3001stream.type or stream.tag"},{code:50030,name:"SUBSCRIBE_STREAM_NOT_EXIST",msg:"Subscribe to non-existent resource"},{code:50030,name:"STREAM_TRACK_NOT_EXIST",msg:"Track not exist. Please check user.id\u3001stream.type or stream.tag"},{code:50031,name:"STREAM_SUBSCRIBED",msg:"Resources has been subscribed"},{code:50032,name:"UNSUBSCRIBE_STREAM_NOT_EXIST",msg:"Unsubscribe to non-existent resource"},{code:53001,//50051
name:"SOCKET_UNAVAILABLE",msg:"IM socket unavailable"},{code:53002,//50053
name:"IM_SDK_VER_NOT_MATCH",msg:"IM SDK version is too low, minimum version 2.4.0, please check: https://www.rongcloud.cn/docs/web_rtclib.html"},{code:53003,//50054,
name:"STREAM_DESKTOPID_ILLEGAL",msg:"Failed to get screen shared stream, illegal desktopStreamId"},{code:53004,//50055,
name:"PARAMTER_ILLEGAL",msg:"Please check the parameters, the {name} parameter is mandatory"},{code:53005,//50056,
name:"ENGINE_ERROR",msg:"RTC engine error"},{code:53006,//50057,
name:"MEDIA_SERVER_ERROR",msg:"Network is abnormal or Media Server is unavailable"},{code:53007,//50058, 未引用需要排查是否有透传如没有可去掉
name:"MEDIA_SERVER_RESPONSE_EMPTY",msg:"Media Server response body is empty"},{code:53008,//50060,
name:"WRONG_ROLE_SETTING",msg:"The set role is invalid"},{code:53009,//50061,
name:"WRONG_AUDIENCE_EVENT",msg:"This method cannot be called by the audience"},{code:53010,//50062,
name:"SET_LIVE_CONFIG_MODE_ERROR",msg:"This method can only be called in live mode"},{code:53011,//50063,
name:"SET_LIVE_CONFIG_ROLE_ERROR",msg:"This method can only be called by the anchor"},{code:53012,//50064,
name:"MUST_PUBLISHED_BEFORE_SETMIXCONFIG",msg:"Must be published before setMixConfig"},{code:53013,//50065,
name:"ROOM_USER_KICK",msg:"You have been removed from the room\uFF01"},{code:53014,//50066,
name:"ROOM_USER_BLOCK",msg:"You are not allowed to join the room\uFF01"},{code:40001,name:"NOT_IN_ROOM",msg:"Not in the room"},{code:40002,name:"INTERNAL_ERROR",msg:"IM Server internal error"},{code:40003,name:"HAS_NO_ROOM",msg:"IM Server room info not exist"},{code:40004,name:"INVALID_USERID",msg:"UserId illegal"},{code:40005,name:"REPEAT_JOIN_ROOM",msg:"Not rejoin the room"}],function(t){var r=t.name,a=t.code,n=t.msg,o={code:a,msg:n};e.Inner[r]=o,e[a]=o,e.Outer[r]=a}),e}(),J={NODE:-1,AUDIO:0,VIDEO:1,AUDIO_AND_VIDEO:2},Y={MAX:1,MIN:2},W={ENABLE:1,DISBALE:0},z={JOINED:0,LEFT:1,OFFLINE:2},X={ICE:"ice",LIFECYCLE:"lifecycle",ROOM:"room",STREAM:"stream",STREAM_HANDLER:"stream_handler",LIVE_HANDLER:"live_handler",ROOM_HANDLER:"room_handler",STORAGE_HANDLER:"storage_handler",IM:"im",MESSAGE:"message",DEVICE:"device",STAT:"stat"},Z={INFO:"I",DEBUG:"D",VERBOSE:"V",WARN:"W",ERROR:"E"},Q={REQUEST:1,RESPONSE:2},$={ROOM:1,USER:2},ee={height:480,width:640,frameRate:15},te="tiny",re=[0,1,2,3,4,4,5,5,5,5,6,6,6,6,6,7,7,7,7,8,8,8,9,9,9,9,9,9,9,9,9,9,9],ae=10000,ne={RTC:0,// 普通音视频
LIVE:2// 直播
},oe={AUDIO_AND_VIDEO:0,AUDIO:1},se={/**
     * 主播
     */ANCHOR:1,/**
     * 观众
     */AUDIENCE:2},ie={/**
     * 自定义布局
     */CUSTOMIZE:1,/**
     * 悬浮布局
     */SUSPENSION:2,/**
     * 自适应布局
     */ADAPTATION:3},de={CROP:1,// 裁剪
WHOLE:2// 填充
},ce={version:1// mode: LIVE_LAYOUT_MODE.SUSPENSION
},pe="",me={R1:"R1\t{rtcVersion}\t{imVersion}\t{platform}\t{pcName}\t{pcVersion}\t{browserName}\t{browserVersion}\t{deviceId}",R2:"R2\t{type}\t{state}\t{deviceId}\r{trackIds}",R3_ITEM:"{googTrackId}\t{googCodecName}\t{audioLevel}\t{samplingRate}\t{trackSent}\t{packLostSentRate}\t{frameRate}\t{resolution}\t{googRenderDelayMs}\t{googJitterSent}\t{googNacksSent}\t{googPlisSent}\t{googRtt}\t{googFirsSent}\t{codecImplementationName}\t{trackState}",R3:"R3\t{totalRate}\t-1\t-1\t-1\t{networkType}\t{rtt}\t{localAddress}\t{receiveBand}\t{sendBand}\t{packetsLost}\t{deviceId}\r{tracks}",R3_KEYS:["mediaType","googTrackId","googCodecName","audioLevel","samplingRate","trackSent","packLostSentRate","frameRate","resolution","googRenderDelayMs","googJitterSent","googNacksSent","googPlisSent","googRtt","googFirsSent","codecImplementationName","trackState","googFirsReceived","googPlisReceived","googNacksReceived"],R4_ITEM:"{googTrackId}\t{googCodecName}\t{audioLevel}\t{samplingRate}\t{trackReceived}\t{packLostReceivedRate}\t{frameRate}\t{resolution}\t{googRenderDelayMs}\t{googJitterReceived}\t{googNacksReceived}\t{googPlisReceived}\t{googRtt}\t{googFirsReceived}\t{codecImplementationName}\t{trackState}",R4:"R4\t{totalRate}\t-1\t-1\t-1\t{networkType}\t{rtt}\t{localAddress}\t{receiveBand}\t{sendBand}\t{packetsLost}\t{deviceId}\r{tracks}",R4_KEYS:["mediaType","googTrackId","googCodecName","audioLevel","samplingRate","trackReceived","packLostReceivedRate","frameRate","resolution","googRenderDelayMs","googJitterReceived","googNacksReceived","googPlisReceived","googRtt","googFirsReceived","codecImplementationName","trackState","googNacksSent","googFirsSent"]},le={R1:"r1",R2:"r2",R3:"r3",R4:"r4"},ge="3.2.5",ue={DISABLE:0,ENABLE:1},Ee={UUID:"uuid"},Re={HTTP:"http://",HTTPS:"https://"},Se={/* 加入房间相关 */A_JR_T:"A-joinRoom-T",A_JR_R:"A-joinRoom-R",A_JR_E:"A-joinRoom-E",L_JR_T:"L-joinRoom-T",L_JR_R:"L-joinRoom-R",L_JR_E:"L-joinRoom-E",P_JRAGD_T:"P-joinRoomAndGetData-T",P_JRAGD_R:"P-joinRoomAndGetData-R",P_JRAGD_E:"P-joinRoomAndGetData-E",/* 断线后重新加入房间 Todo */L_REJR_T:"L-rejoinRoom-T",L_REJR_R:"L-rejoinRoom-R",L_REJR_E:"L-rejoinRoom-E",/* 退出房间相关 */A_LR_T:"A-leaveRoom-T",A_LR_R:"A-leaveRoom-R",A_LR_E:"A-leaveRoom-E",L_LR_T:"L-leaveRoom-T",L_LR_R:"L-leaveRoom-R",L_LR_E:"L-leaveRoom-E",L_MSLR_T:"L-mediaLeaveRoom-T",L_MSLR_R:"L-mediaLeaveRoom-R",L_MSLR_E:"L-mediaLeaveRoom-E",/* 发布资源相关 */A_PAVS_T:"A-publishAVStream-T",A_PAVS_R:"A-publishAVStream-R",A_PAVS_E:"A-publishAVStream-E",/* 取消发布资源相关 */A_UPAVS_T:"A-unpublishAVStream-T",A_UPAVS_R:"A-unpublishAVStream-R",A_UPAVS_E:"A-unpublishAVStream-E",/* MediaServer Exchange 接口 */L_MSE_T:"L-MSExchange-T",L_MSE_R:"L-MSExchange-R",L_MSE_E:"L-MSExchange-E",/* 订阅资源相关 */A_SAVS_T:"A-subscribeAVStream-T",A_SAVS_R:"A-subscribeAVStream-R",A_SAVS_E:"A-subscribeAVStream-E",/* 取消订阅资源相关 */A_USAVS_T:"A-unsubscribeAVStream-T",A_USAVS_R:"A-unsubscribeAVStream-R",A_USAVS_E:"A-unsubscribeAVStream-E",/* MediaServer Subscribe 接口 */L_MSS_T:"L-MSSub-T",L_MSS_R:"L-MSSub-R",L_MSS_E:"L-MSSub-E",/* 获取 RTC Token */L_GRT_T:"L-getRtcToken-T",L_GRT_R:"L-getRtcToken-R",L_GRT_E:"L-getRtcToken-E",/* 订阅直播流 */A_SLS_T:"A-subscribeLiveStream-T",A_SLS_R:"A-subscribeLiveStream-R",A_SLS_E:"A-subscribeLiveStream-E",L_MSSL_T:"L-MSSubLive-T",L_MSSL_R:"L-MSSubLive-R",L_MSSL_E:"L-MSSubLive-E",/* 取消订阅直播流 */A_USLS_T:"A-unsubscribeLiveStream-T",A_USLS_R:"A-unsubscribeLiveStream-R",A_USLS_E:"A-unsubscribeLiveStream-E",L_MLL_T:"L-mediaLiveLeave-T",L_MLL_R:"L-mediaLiveLeave-R",L_MLL_E:"L-mediaLiveLeave-E",/* 设置MCU合流布局 */A_SMC_T:"A-setMixConfig-T",A_SMC_R:"A-setMixConfig-R",A_SMC_E:"A-setMixConfig-E",/* 中间状态值 */A_RTCC_S:"A-RTCConfig-S",A_UJ_S:"A-userJoined-S",A_UL_S:"A-userLeft-S"},Te="://",_e={"176_132":"RESOLUTION_176_132","256_144":"RESOLUTION_256_144","320_180":"RESOLUTION_320_180","240_240":"RESOLUTION_240_240","320_240":"RESOLUTION_320_240","480_360":"RESOLUTION_480_360","640_360":"RESOLUTION_640_360","480_480":"RESOLUTION_480_480","640_480":"RESOLUTION_640_480","720_480":"RESOLUTION_720_480","1280_720":"RESOLUTION_1280_720","1920_1080":"RESOLUTION_1920_1080"},he={RESOLUTION_176_132:{width:176,height:132,maxBitRate:150,minBitRate:80},RESOLUTION_256_144:{width:256,height:144,maxBitRate:240,minBitRate:120},RESOLUTION_320_180:{width:320,height:180,maxBitRate:280,minBitRate:120},RESOLUTION_240_240:{width:240,height:240,maxBitRate:280,minBitRate:120},RESOLUTION_320_240:{width:320,height:240,maxBitRate:400,minBitRate:120},RESOLUTION_480_360:{width:480,height:360,maxBitRate:650,minBitRate:150},RESOLUTION_640_360:{width:640,height:360,maxBitRate:800,minBitRate:180},RESOLUTION_480_480:{width:480,height:480,maxBitRate:800,minBitRate:180},RESOLUTION_640_480:{width:640,height:480,maxBitRate:900,minBitRate:200},RESOLUTION_720_480:{width:720,height:480,maxBitRate:1e3,minBitRate:200},RESOLUTION_1280_720:{width:1280,height:720,maxBitRate:2200,minBitRate:250},RESOLUTION_1920_1080:{width:1920,height:1080,maxBitRate:4e3,minBitRate:400}},ye={10:1,15:1,24:1.5,30:1.5},fe={10:10,15:15,24:24,30:30},Ce=w.Storage,ve=function(){var e=Ee.UUID,t=Ce.get(e);return t||(t=w.getUUID22(),Ce.set(e,t)),t},Ie=function(e,t){var r=!1,a="",n=function(){return{isIllegal:r,name:a}};if(w.isArray(t)||(t=[t]),!w.isObject(e))throw new Error("check(data, rules): data must be an object");return w.forEach(t,function(t){var n=-1<t.indexOf(".");if(!n&&(r=w.isUndefined(e[t]),r))return a=t;if(n){var o=t.split("."),s=E(o,2),i=s[0],d=s[1],c=e[i];if(r=w.isUndefined(c),r)return a=i;w.isArray(c)||(c=[c]),w.forEach(c,function(e){var t=e[d];if(r=w.isUndefined(t),r)return a=d})}}),n()},Ae=function(e){var t=q.Inner.PARAMTER_ILLEGAL,r=t.msg;return r=w.tplEngine(r,{name:e}),w.extend(t,{msg:r})},De=function(e,t,r){r=r||{};var a=e.getRoomId(),n=e.getRTCToken(),o=e.getClientSessionId(),s=e.getUserId(),i=e.getAppInfo(),d=i.appKey,c=w.getBrowser(),p=w.tplEngine("web|{name}|{version}",c),m={"App-Key":d,RoomId:a,Token:n,ClientType:p,ClientVersion:ge,"Client-Session-Id":o},l=ne.LIVE;return t.setUserId&&(m.UserId=s),t.mode===l&&(m.RoomType=l),m=w.extend(m,r),m},Oe=function(e,t){var r=e.getAppInfo(),a=r.appKey,n=w.getBrowser(),o=w.tplEngine("web|{name}|{version}",n),s=ne.LIVE,i=e.getUserId(),d={"App-Key":a,RoomType:s,ClientType:o,ClientVersion:ge,UserId:i,RoomId:i};return t&&(d.Token=t),d},Le=function(e,t){e=e||{},e.video=e.video||{},e.audio=e.audio||{},e.tinyVideo=e.tinyVideo||{};var r=w.handleObjKeys(e.customLayout,w.humpToLine),a=w.extend(ce,{host_user_id:e.hostUserId,host_stream_id:e.hostStreamId,mode:e.layoutMode||ie.SUSPENSION,output:{video:{normal:e.video,tiny:e.tinyVideo,exparams:{renderMode:e.video.renderMode}},audio:e.audio},input:r});// 驼峰转化为下划线
return 0<t.length&&(a.output.cdn=t.map(function(e){return{pushurl:e}})),w.clearEselessFields(a)},Me=function(e,t){var r=e.id,a=e.uris;w.isString(a)&&(a=w.parse(a));var n=[e];a&&(n=w.uniq(a,function(e){var t=e.tag,r=e.mediaType,n=e.state,o=e.streamId||e.msid,s=w.filter(a,function(e){var t=e.streamId||e.msid;return w.isEqual(t,o)});return{key:[o].join("_"),value:{tag:t,uris:s,mediaType:r,state:n}}})),w.forEach(n,function(e){t({id:r,stream:e})})},be=function(e,t){var r=e.stream,a=r.mediaType,n=r.state,o=w.tplEngine("{type}_{state}",{type:a,state:n}),s=function(){var e={},t=w.tplEngine("{type}_{state}",{type:J.VIDEO,state:W.DISBALE});// 禁用视频
return e[t]=B.STREAM_DISABLED,t=w.tplEngine("{type}_{state}",{type:J.VIDEO,state:W.ENABLE}),e[t]=B.STREAM_ENABLED,t=w.tplEngine("{type}_{state}",{type:J.AUDIO,state:W.DISBALE}),e[t]=B.STREAM_MUTED,t=w.tplEngine("{type}_{state}",{type:J.AUDIO,state:W.ENABLE}),e[t]=B.STREAM_UNMUTED,e}(),i=s[o];return t(i,e)},ke=function(){return /^((?!chrome|android).)*safari/i.test(navigator.userAgent)},Ue=function(e){return w.isUndefined(e)||w.isEmpty(e)},Pe=function(){return ge},Ne=function(e){var t=e.option.mode,r=e.getLiveRole();return t===ne.LIVE&&r===se.AUDIENCE},xe=function(e,t){return t===se.AUDIENCE&&e===se.ANCHOR},we=function(e){var t=e.id,r=e.stream;w.isArray(r)||(r=[r]);var a=function(e){var t=[{kind:"video",type:J.VIDEO},{kind:"audio",type:J.AUDIO}];return w.isEqual(e,J.AUDIO_AND_VIDEO)?t:w.filter(t,function(t){return w.isEqual(t.type,e)})},n=[];return w.forEach(r,function(e){var r=e.tag,o=e.type,s=a(o);w.forEach(s,function(e){var a=e.kind,o=w.tplEngine("{id}_{tag}_{kind}",{id:t,tag:r,kind:a});n.push(o)})}),n},Be=function(e){var t=location.protocol;return w.tplEngine("{protocol}//{configUrl}",{protocol:t,configUrl:e})},Ve=function(e){e=e||"";var t=Te,r=w.isContain(e,t),a="";if(!w.isEqual(location.protocol,"https:"))r||(a=Re.HTTP);else if(a=Re.HTTPS,r){var n=e.indexOf(t)+t.length;e=e.substring(n)}return w.tplEngine("{protocol}{domain}",{protocol:a,domain:e})},Ge=function(e){if(w.isEqual(location.protocol,"http:"))return!0;var t=Te,r=w.isContain(e,t);if(r){var a=e.substring(0,e.indexOf(t)+t.length);return a===Re.HTTPS}return!0},je=function(){var e=new w.Observer,t=function(t,r,a){var n=new Date().getTime();e.emit({level:t,tag:r,meta:a,time:n,platform:"web"})};return{warn:function(e,r){return t(Z.WARN,e,r)},error:function(e,r){return t(Z.ERROR,e,r)},info:function(e,r){return t(Z.INFO,e,r)},log:function(e,r){return t(Z.VERBOSE,e,r)},watch:function(t,r){e.add(t,r)}}}(),Fe=function(){var e=void 0,t=void 0,r=!1,a=function(t,r,a){e.writeLog({level:t,tag:r,content:a,type:"RTC"})},n=function(e,n){return r&&a(t.F,e,n)},o=function(e,n){return r&&a(t.E,e,n)},s=function(e,n){return r&&a(t.W,e,n)},i=function(e,n){return r&&a(t.I,e,n)},d=function(e,n){return r&&a(t.D,e,n)};return{init:function(a){a.Logger&&a.LoggerLevel&&(r=!0,e=a.Logger,t=a.LoggerLevel)},fatal:n,error:o,warn:s,info:i,debug:d}}(),He=function(){function e(t){m(this,e);var r=this,a=(t||"").id,n=a.length,o=r.getClient();// TODO: 语法错误
if(!/[A-Za-z0-9+=_-]+$/.test(a)||n>64){var s=q.Inner;return o.emit(B.RTC_ERROR,s.ROOM_ID_IS_ILLEGAL)}w.forEach(G,function(e){var r=e,a=r.name,n=r.type;o.on(a,function(r,a){e=t[n]||w.noop,e(a,r),je.log(X.ROOM,{event:n,user:a}),"joined"===n?Fe.info(Se.A_UJ_S,a):"left"===n?Fe.info(Se.A_UL_S,a):void 0})}),w.extend(r,{option:t,client:o,room:{id:a}})}return l(e,[{key:"join",value:function(e){Fe.info(Se.A_JR_T,{user:e});var t=Ie(e,["id"]),r=t.isIllegal,a=t.name;if(r){var n=Ae(a);return Fe.warn(Se.A_JR_E,{desc:n}),w.Defer.reject(n)}var o=this.room,s=this.client;return w.extend(o,{user:e}),Fe.info(Se.A_JR_R,{user:e}),s.exec({event:V.ROOM_JOIN,type:"room",args:[o]})}},{key:"leave",value:function(){var e=this.room,t=this.client;return Fe.info(Se.A_LR_T,{roomId:e.id,uid:e.user.id}),t.emit("leave-by-self"),t.exec({event:V.ROOM_LEAVE,type:"room",args:[e]})}},{key:"get",value:function(){var e=this.room,t=this.client;return t.exec({event:V.ROOM_GET,type:"room",args:[e]})}},{key:"getSessionId",value:function(){var e=this.room,t=this.client;return t.exec({event:V.ROOM_GET_SESSONID,type:"room",args:[e]})}},{key:"getStats",value:function(){var e=this.room,t=this.client;return t.exec({event:V.ROOM_GET_STATS,type:"room",args:[e]}).then(function(e){var t={};for(var r in e){var a=JSON.parse(e[r].uris||"[]");t[r]=a.map(function(e){return{mediaType:e.mediaType,state:e.state,tag:e.tag}})}return Promise.resolve(t)})}}]),e}(),Ke=function(){function r(a){m(this,r);var n=this,o=n.getClient();w.forEach(j,function(e){var t=e,r=t.name,n=t.type;o.on(r,function(t,r){e=a[n]||w.noop,e(r,t),je.log(X.STREAM,{event:n,user:r})})});// 备份用户 setMixConfig 配置
var s={},i=[];// cdn 推流地址缓存
o.on("leave-by-self",function(){i.length=0,s={}}),o.extendOption(a),w.extend(n,{option:a,client:o,video:new e(o),audio:new t(o),tmpConf:s,publishUrls:i})}return l(r,[{key:"publish",value:function(e){Fe.info(Se.A_PAVS_T,{user:e});var t=Ie(e,["id","stream.tag","stream.mediaStream","stream.type"]),r=t.isIllegal,a=t.name;if(r){var n=Ae(a);return Fe.warn(Se.A_PAVS_E,{desc:n}),w.Defer.reject(n)}var o=this.client;return o.exec({event:V.STREAM_PUBLISH,type:"stream",args:[e]})}},{key:"unpublish",value:function(e){Fe.info(Se.A_UPAVS_T,{user:e});var t=Ie(e,["id","stream.tag","stream.type"]),r=t.isIllegal,a=t.name;if(r){var n=Ae(a);return Fe.warn(Se.A_UPAVS_E,{desc:n}),w.Defer.reject(n)}var o=this.client;return o.exec({event:V.STREAM_UNPUBLISH,type:"stream",args:[e]})}},{key:"subscribe",value:function(e){var t=this.client,r=t.rongRTC,a=void 0,n=void 0,o=void 0;Ne(r)?(a=Ie(e,["liveUrl"]),n=Se.A_SLS_T,o=Se.A_SLS_E):(a=Ie(e,["id","stream.tag","stream.type"]),n=Se.A_SAVS_T,o=Se.A_SAVS_E),Fe.info(n,{user:e});var s=a,i=s.isIllegal,d=s.name;if(i){var c=Ae(d);return Fe.warn(o,{desc:c}),w.Defer.reject(c)}return t.exec({event:V.STREAM_SUBSCRIBE,type:"stream",args:[e]})}},{key:"unsubscribe",value:function(e){var t=this.client,r=t.rongRTC,a=void 0,n=void 0,o=void 0;Ne(r)?(a=Ie(e,[]),n=Se.A_USLS_T,o=Se.A_USLS_E):(a=Ie(e,["id","stream.tag","stream.type"]),n=Se.A_USAVS_T,o=Se.A_USAVS_E),Fe.info(n,{user:e});var s=a,i=s.isIllegal,d=s.name;if(i){var c=Ae(d);return Fe.warn(o,{desc:c}),w.Defer.reject(c)}return t.exec({event:V.STREAM_UNSUBSCRIBE,type:"stream",args:[e]})}},{key:"resize",value:function(e){var t=Ie(e,["id","stream.tag"]),r=t.isIllegal,a=t.name;if(r){var n=Ae(a);return w.Defer.reject(n)}var o=this.client;return o.exec({event:V.STREAM_RESIZE,type:"stream",args:[e]})}/**
       * 添加 CDN 推流地址，如：rmtp://
       * @param  {...string} urls 
       */},{key:"addPublishStreamUrl",value:function(){for(var e=this,t=arguments.length,r=Array(t),a=0;a<t;a++)r[a]=arguments[a];0===r.length||(r.forEach(function(t){!/^rtmp:\/\//.test(t)||e.publishUrls.includes(t)||e.publishUrls.push(t)}),this.setMixConfig(this.tmpConf))}/**
       * 删除 CDN 推流地址
       * @param  {...string} urls 待删除的推流地址
       */},{key:"removePublishStreamUrl",value:function(){for(var e=this,t=arguments.length,r=Array(t),a=0;a<t;a++)r[a]=arguments[a];0===r.length||(r.forEach(function(t){var r=e.publishUrls.indexOf(t);0<=r&&e.publishUrls.splice(r,1)}),this.setMixConfig(this.tmpConf))}/**
       * 设置直播混流配置，仅直播模式此方法有效
       * @param {Object} config
       * @example 
       * stream.setMixConfig({
       *  layoutMode: RongRTC.LayoutMode.SUSPENSION,
       *  video: {}
       * })
       */},{key:"setMixConfig",value:function(e){var t=this.client,r=t.rongRTC,a=r.option.mode,n=r.getLiveRole(),o=a===ne.LIVE,s=n===se.ANCHOR;// 主播
if(!o)// 非直播模式
return w.Defer.reject(q.Inner.SET_LIVE_CONFIG_MODE_ERROR);if(!s)// 非主播
return w.Defer.reject(q.Inner.SET_LIVE_CONFIG_ROLE_ERROR);var i=Ie(e,["layoutMode"]),d=i.isIllegal,c=i.name;if(d){var p=Ae(c);return w.Defer.reject(p)}if(e.layoutMode===ie.CUSTOMIZE){var m=["userId","streamId","x","y","width","height"];// 断言验证
w.assert(e.customLayout,"\u81EA\u5B9A\u4E49\u5E03\u5C40\u9700\u8981\u63D0\u4F9B\u660E\u786E\u7684 customLayout \u5B9A\u4E49")&&w.assert(e.customLayout.video instanceof Array,"customLayout.video \u5FC5\u987B\u662F\u6570\u7EC4")&&w.assert(e.customLayout.video.every(function(e){return!Ie(e,m).isIllegal}),"customLayout.video \u4E2D\u7684\u6BCF\u4E2A\u5143\u7D20\u4E2D\u5FC5\u987B\u5305\u542B "+m.join("\u3001")+" \u5C5E\u6027")}// 因 CDN 推流使用全量配置，此处对用户配置临时存储，方便后续设置 CDN 推流时继续使用
return this.tmpConf=e,t.exec({event:V.LIVE_CONFIG,type:"stream",args:[e,this.publishUrls]})}},{key:"get",value:function(e){var t=this.client;return t.exec({event:V.STREAM_GET,type:"stream",args:[e]})}},{key:"publishDefault",value:function(e){var t=this.client;return t.exec({event:V.STREAM_PUBLISH_DEFAULT,type:"stream",args:[e]})}}]),r}(),qe=function(){function e(){m(this,e),this.events={},this.onceEvents={}}return l(e,[{key:"on",value:function(e,t){var r=this.events[e]||[];r.push(t),this.events[e]=r}},{key:"off",value:function(e,t){if(t){var r=this.events[e]||[];w.forEach(r,function(e,a){w.isEqual(e,t)&&r.splice(a,1)},{isReverse:!0})}else delete this.events[e]}},{key:"emit",value:function(e,t,r){var a=this.events[e];w.forEach(a,function(e){e(r,t)});var n=this.onceEvents[e]||w.noop;n(r,t),delete this.onceEvents[e]}},{key:"once",value:function(e,t){this.onceEvents[e]=t}},{key:"teardown",value:function(){for(var e in this.events)this.off(e);for(var t in this.onceEvents)delete this.onceEvents[t]}}]),e}(),Je={ADDED:"p_stream_added",REMOVED:"p_stream_removed",RECEIVED:"p_stream_received",CHANGED:"p_ice_changed",TRACK_RECEIVED:"p_track_received",SIGNAL_STATE_CHANGE:"p_signaling_state_change"},Ye={FAILED:"failed",DISCONNECTED:"disconnected",CLOSED:"closed"},We={JOINED:"common_joined",LEFT:"common_left",ERROR:"common_error",CONSUME:"common_consume",REQUEST_CONSUME:"common_request_consume",CONNECTED:"common_connected",PEERCONN_CREATED:"common_peerconn_created",PEERCONN_DESTROYED:"common_peerconn_destroyed",PUBLISHED_STREAM:"common_published_stream",SEND_REPORT:"common_send_report",TRACK_MODIFY:"common_track_modify",SET_URIS:"common_set_uris",CHANGE_ROLE:"common_change_role"},ze=function(){function e(t){m(this,e),t=t||{};var r={url:"https://cdn.ronghub.com/detecting",timeout:1500,max:30};w.extend(r,t),w.extend(this,{option:r})}return l(e,[{key:"detect",value:function(e){var t=this,r=t.detecting,a=t.option;if(!r){w.extend(t,{detecting:!0});var n=a.url,o=a.timeout,s=a.max,i=1,d=function(){return i+=1,i},c=!1,p=function r(){i=d(),w.request(n).then(function(){return e(!0)},function(a){var n=a.status;return w.isEqual(n,404)?(w.extend(t,{detecting:!1}),c=!0,e(c)):w.isEqual(s,i)?e(c):void setTimeout(function(){r()},o)})};p()}}}]),e}(),Xe={PUBLISH:"/exchange",UNPUBLISH:"/exchange",RESIZE:"/exchange",SUBSCRIBE:"/exchange",ONLY_SUBSCRIBE:"/subscribe",UNSUBSCRIBE:"/subscribe",LIVE_SUBSCRIBE:"/broadcast/subscribe",// 直播模式, 订阅接口
LIVE_CONFIG:"/server/mcu/config",// 直播模式, 自定义更改配置接口
LIVE_EXIT:"/broadcast/exit",// 直播模式, 退出接口
EXIT:"/exit"},Ze={urls:[],errorUrls:[],clusterIdUrl:"",timeout:ae},Qe=new w.Prosumer,$e=new qe,et=function(e){Ze.errorUrls.push(e)},tt=function(){Ze.errorUrls.length=0},rt=function(){var e=Ze.errorUrls,t=Ze.urls,r=Ze.clusterIdUrl;if(r&&!w.isInclude(e,r)){// 优先使用 clusterIdUrl
var a=/(http|https):\/\/([\w.]+\/?)\S*/.test(r);return a?r:"https://"+r;// 不带协议时，默认使用 https
}var n=w.filter(w.clone(t),function(t){var r=w.isInclude(e,t);return!r}),o=w.isEmpty(n);return o?null:n[0]},at=function(e){w.isEmpty(e)||!w.isArray(e)||(// 反向合并. 比如已有 [4、5、6], 传入 [1、2、3], 结果 [1、2、3、4、5、6]
e=w.map(e,function(e){return Ve(e);// 校验格式
}),Ze.urls=w.merge(Ze.urls,e,{isReverse:!0}))},nt=function e(t){// TODO: 错误，options 中有地址信息
var r=t.urls&&0<t.urls.length?t.urls[0]:rt();if(w.isEmpty(r))return tt(),w.Defer.reject(q.Inner.NO_AUDIO_AND_VIDEO_SERVICE);var a=t.path,n=t.body,o=w.tplEngine("{domain}{path}",{domain:r,path:a}),s=w.extend(t.headers||{},{"Content-Type":"application/json;charset=UTF-8","Request-Id":Date.now().toString()});return w.assert(!!s.Token,"\u4E0E MediaServer \u4EA4\u4E92\u5FC5\u987B\u643A\u5E26 Token \u4FE1\u606F"),w.request(o,{method:"POST",timeout:Ze.timeout,body:JSON.stringify(n),headers:s}).then(function(e){var t=w.isEqual(e.resultCode,1e4);return t?e:w.Defer.reject(e)},function(a){var n=a.status;return w.isInclude([403],n)?w.Defer.reject(a):(et(r),e(t));// 重新请求
})};$e.on(We.REQUEST_CONSUME,function(){Qe.consume(function(e,t){var r=e.option,a=e.resolve,n=e.reject;nt(r).then(function(e){a(e),t()},function(e){n(e),t()})})});var ot={setOption:function(e){e=e||{};var t=e.urls;w.isEmpty(t)||(at(t),delete e.urls),w.extend(Ze,e)},getOption:function(){return Ze},post:function(e){return w.deferred(function(t,r){Qe.produce({option:e,resolve:t,reject:r}),$e.emit(We.REQUEST_CONSUME)})},addUrls:at,addUrl:function(e){at([e])},isUrlsExisted:function(e){w.isArray(e)||(e=[e]);var t=!0;return w.forEach(e,function(e){var r=Ve(e);w.isInclude(Ze.urls,r)||(t=!1)}),t},addClusterIdUrl:function(e){Ze.clusterIdUrl=e}},st=void 0,it=function(e){st=e},dt=function(e){return e.replace(/\s+\r\n/g,"\r\n")},ct=function(e){function t(e){m(this,t);var r=u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));it(r);var a=r;a.bandWidthCount=0;var n=new RTCPeerConnection({sdpSemantics:"plan-b",// Chrome 49 Test
iceServers:[]});w.extend(a,{option:e});return w.forEach({onaddstream:function(e){var t=e.stream;a.emit(Je.ADDED,t)},onremovestream:function(e){var t=e.stream;a.emit(Je.REMOVED,t)},ontrack:function(e){var t=e.streams;a.emit(Je.TRACK_RECEIVED,t)},ondatachannel:function(e){a.emit(Je.RECEIVED,e)},oniceconnectionstatechange:function(){var e=n.iceConnectionState;w.extend(a,{state:e}),a.emit(Je.CHANGED,e),je.log(X.ICE,{state:e})},onsignalingstatechange:function(){var e=n.getRemoteStreams();a.emit(Je.SIGNAL_STATE_CHANGE,e)}},function(e,t){n[t]=e}),w.extend(a,{pc:n}),r}return g(t,e),l(t,[{key:"addStream",value:function(e){var t=this,r=t.pc,a=e.stream;return w.isArray(a)||(a=[a]),w.forEach(a,function(e){var t=e.mediaStream;r.addStream(t)}),t.createOffer(e)}},{key:"removeStream",value:function(e){var t=this,r=t.pc,a=e.stream;return w.isArray(a)||(a=[a]),w.forEach(a,function(e){var t=e.mediaStream;r.removeStream(t)}),t.createOffer(e)}},{key:"setOffer",value:function(e){var t=this,r=t.pc;return e.sdp=dt(e.sdp),r.setLocalDescription(e)}},{key:"setAnwser",value:function(e){var t=this,r=t.pc;return e=t.setBitrate(e),e.sdp=dt(e.sdp),r.setRemoteDescription(new RTCSessionDescription(e))}},{key:"setAnwserOnly",value:function(e){// 直播重复订阅仅设置，不修改 sdp, 防止 offer answer 不匹配
var t=this,r=t.pc;return e.sdp=dt(e.sdp),r.setRemoteDescription(new RTCSessionDescription(e))}},{key:"setRemoteAnwser",value:function(e){var t=this,r=t.pc;return e.sdp=dt(e.sdp),r.setRemoteDescription(new RTCSessionDescription(e)).then(function(){return r.createAnswer().then(function(e){return r.setLocalDescription(e)})})}},{key:"setBitrate",value:function(e){var t=this,r=t.option.bitrate,a=e.sdp,n="\n",o=a.split(n),s=function(e){for(var t=null,r=0,a;r<o.length;r++)if(a=o[r],w.isInclude(a,e)){t=r;break}return t},i=s("a=mid:video");if(w.isNull(i))return e;o[i]=[o[i],"b=AS:"+r.max].join(n);var d=s("m=video");if(w.isNull(d))return e;var c=o[d],p=c.split(" "),m=p[3],l=s("a=fmtp:"+m);if(w.isNull(l))return e;t.bandWidthCount++,r=JSON.parse(JSON.stringify(r)),0==t.bandWidthCount%2&&++r.min;var g=";x-google-min-bitrate="+r.min+";x-google-max-bitrate="+r.max;return w.isNumber(r.start)&&(g+=";x-google-start-bitrate="+r.start),o[l]=[o[l].replace(/[\r\n]+$/,""),g].join(""),a=o.join(n),w.extend(e,{sdp:a}),e}},{key:"close",value:function(){var e=this,t=e.pc;e.bandWidthCount=0,t.close(),e.pc=null,delete e.pc}},{key:"isClosed",value:function(){var e=this;return!e.pc}},{key:"getOption",value:function(){return{iceRestart:!0,offerToReceiveAudio:!0,offerToReceiveVideo:!0}}},{key:"isNegotiate",value:function(){var e=this.state;return w.isEqual(e,Ye.FAILED)||w.isEqual(e,Ye.DISCONNECTED)||w.isEqual(e,Ye.CLOSED)}},{key:"createOffer",value:function(e){var t=this,r=t.pc,a=e.stream;w.isArray(a)||(a=[a]);var n=t.getOption();return w.deferred(function(o,s){r.createOffer(function(r){w.forEach(a,function(a){var n=a.mediaStream,o=a.size,s=t.getStreamId(e,o),i=n.id,d=r,c=d.sdp;c=c.replace(new RegExp(i,"g"),s),w.extend(r,{sdp:c})}),r=t.renameCodec(r),w.extend(t,{desc:r}),o(r)},function(e){s(e)},n)})}},{key:"getOffer",value:function(e){var t=this,r=t.pc,a=t.getOption();return r.createOffer(a).then(function(r){// desc = context.setBitrate(desc);
return r=t.renameCodec(r),e&&e(r),r})}},{key:"renameCodec",value:function(e){var t=e.sdp,r="\r\n",a=function(e){var r=t.match(/m=video\s+[\w\s/]+/),a=r[0],n=a.split(" ");return n.length=e,n},n=a(3),o=t.indexOf("m=video"),s=t.indexOf("a=ssrc-group");// sdp = sdp.replace(new RegExp('a=group:BUNDLE 0 1', 'g'), 'a=group:BUNDLE audio video')
w.isEqual(s,-1)&&(s=t.length);var i=t.substring(o,s),d=i.split(r),c={};w.forEach([{name:"H264/90000",code:98,rtx:99,value:"a=rtpmap:98 H264/90000\r\na=rtcp-fb:98 goog-remb\r\na=rtcp-fb:98 transport-cc\r\na=rtcp-fb:98 ccm fir\r\na=rtcp-fb:98 nack\r\na=rtcp-fb:98 nack pli\r\na=fmtp:98 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\na=rtpmap:99 rtx/90000\r\na=fmtp:99 apt=98"},{name:"VP8/90000",code:96,rtx:97,value:"a=rtpmap:96 VP8/90000\r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack\r\na=rtcp-fb:96 nack pli\r\na=rtcp-fb:96 goog-remb\r\na=rtcp-fb:96 transport-cc\r\na=rtpmap:97 rtx/90000\r\na=fmtp:97 apt=96"},{name:"red/90000",rtx:101,code:100,value:"a=rtpmap:100 red/90000\r\na=rtpmap:101 rtx/90000\r\na=fmtp:101 apt=100"},{name:"ulpfec/90000",code:127,value:"a=rtpmap:127 ulpfec/90000"},{name:"flexfec-03/90000",code:125,value:"a=rtpmap:125 flexfec-03/90000\r\na=rtcp-fb:125 transport-cc\r\na=rtcp-fb:125 goog-remb\r\na=fmtp:125 repair-window=10000000"}],function(e){var t=e.name;w.forEach(d,function(r){w.isInclude(r,t)&&(c[t]=e)})});var p="";w.forEach(c,function(e){var t=e.code,a=e.value,o=e.rtx;p+=a+r,n.push(t),o&&n.push(o)}),i=i.split(r),i.shift(),i=i.join(r);var m=i.indexOf("a=rtpmap"),l=t.substring(0,o),g=i.substring(0,m),u=t.substring(s,t.length);return t=l+n.join(" ")+"\r\n"+g+p+u,w.extend(e,{sdp:t}),e}/* 
        let ratio = {
          msid: {
            // 1大流    2小流 
            simulcast: 1,
            resolution: "0x0"
          }
        }
      */},{key:"getStreamRatio",value:function(e){var t={};return w.forEach(e,function(e){var r=e.id,a=e.mediaStream,n=t[r]||[],o=a.getVideoTracks()[0],s=Y.MAX;if(!w.isUndefined(o)){var i=o.getConstraints(),d=i.height,c=i.width,p=o.id;d=d||0,c=c||0,w.isInclude(r,te)&&(s=Y.MIN);var m=w.tplEngine("{width}x{height}",{height:d,width:c});n.push({simulcast:s,resolution:m,videoTrackId:p}),t[r]=n}}),t}},{key:"getStreamId",value:function(e,t){var r="{userId}_{tag}",a=e.id,n=e.stream;w.isArray(n)||(n=[n]);var o=n,s=E(o,1),i=s[0].tag;return w.isEqual(t,Y.MIN)&&(r="{userId}_{tag}_{suffix}"),Ue(i)?a:w.tplEngine(r,{userId:a,tag:i,suffix:te})}},{key:"getTagByStreamId",value:function(e){var t=e.split("_");return t[t.length-1]}},{key:"getStreamSymbolById",value:function(e){var t=e.split("_");if(w.isEqual(t.length,1))return t.push(pe),t;var r=t.pop(),a=t.join("_");return[a,r]}},{key:"getStats",value:function(e){var t=this,r=t.pc;return r.getStats(function(t){var r=[];t.result().forEach(function(e){var t={};e.names().forEach(function(r){t[r]=e.stat(r)}),w.extend(t,e),r.push(t)}),e(r)})}}]),t}(qe);ct.getInstance=function(){return st};var pt=function(){function e(t,r){m(this,e);var a=this,n=r.detect;w.extend(a,{option:r,im:t,rtcToken:null,clientId:ve()}),a.network=new ze(n),a.SubPromiseCache={},a.SubLiveUrlsCache=null,a.SubStreamCache=null,a.setPC()}return l(e,[{key:"getRTCToken",value:function(){var e=this.im,t=this.rtcToken;return t?w.Defer.resolve(t):e.getRTCTokenAsyn(e.getUserId())}},{key:"setPC",value:function(){var e=this;// 如果已创建 peerconnection, 则不再处理
if(!e.pc||e.pc.isClosed()){e.pc=new ct(e.option),e.im.emit(We.PEERCONN_CREATED,e.pc);var t=e.pc,r=e.im,a=e.network;t.on(Je.ADDED,function(t,a){if(t)throw t;e.SubPromiseCache.resolve({mediaStream:a}),e.SubStreamCache=a;var n=a.id,o=n.lastIndexOf("_");n=n.substring(o+1,n.length);// let type;      
var s={id:r.getUserId(),stream:{mediaStream:a,type:0,tag:n}},i=we(s);r.emit(We.SEND_REPORT,{type:le.R2,name:V.STREAM_PUBLISH,content:{trackIds:i}})}),t.on(Je.TRACK_RECEIVED,function(t,r){if(t)throw t;w.forEach(r,function(t){e.SubPromiseCache.resolve({mediaStream:t})})}),t.on(Je.SIGNAL_STATE_CHANGE,function(t,r){if(t)throw t;w.forEach(r,function(t){e.SubPromiseCache.resolve({mediaStream:t})})}),t.on(Je.CHANGED,function(){t.isNegotiate()&&a.detect(function(t){if(t)e.reconnect();else{var a=q.Inner;r.emit(We.ERROR,a.NETWORK_UNAVAILABLE)}})})}}},{key:"subscribe",value:function(e,t){var r=this,a=r.pc,n=r.im,o=e.liveUrl,s=e.type,i=e.size;// if (self.isSubscribed()) {
//   return utils.Defer.reject(ErrorType.Inner.STREAM_SUBSCRIBED);
//   // 如果已经订阅过，用户再次订阅视为切换流
// }
return w.deferred(function(d,c){return r.getRTCToken().then(function(p){var m=p.rtcToken;r.SubPromiseCache={resolve:d,reject:c},a.getOffer().then(function(d){var c=Xe.LIVE_SUBSCRIBE,p=Oe(n,m),l={path:c,body:{liveUrl:o,sdp:d,mediaType:s,simulcast:i},headers:p};je.log(X.LIVE_HANDLER,{msg:"subscribe:request",room:e,option:l}),Fe.info(Se.L_MSSL_T,{room:e,option:l}),ot.post(l).then(function(s){var i=s.sdp,c=s.clusterId;c&&ot.addClusterIdUrl(c),a.setOffer(d).then(function(){r.isSubscribed()?a.setAnwserOnly(i):a.setAnwser(i)}),w.extend(n,{room:{id:s.roomId}}),n.emit(We.SEND_REPORT,{type:le.R1,name:V.STREAM_SUBSCRIBE,content:{}}),je.log(X.LIVE_HANDLER,{msg:"subscribe:response:stream:arriving",room:e,response:s}),Fe.info(Se.L_MSSL_R,{room:e,response:s}),r.setSubLiveUrl(o),t&&t()},function(t){je.log(X.LIVE_HANDLER,{msg:"subscribe:response:error",room:e,error:t}),Fe.info(Se.L_MSSL_E,{room:e,error:t}),r.SubPromiseCache.reject(t)})})},function(e){return je.log(X.LIVE_HANDLER,{msg:"getrtctoken:error",error:e}),e})})}},{key:"unsubscribe",value:function(){var e=this,t=e.pc,r=e.im,a=e.getSubLiveUrl();return e.getRTCToken().then(function(n){var o=n.rtcToken;return t.getOffer().then(function(t){var n=Xe.LIVE_EXIT,s=Oe(r,o),i={path:n,body:{sdp:t,liveUrl:a},headers:s};je.log(X.LIVE_HANDLER,{msg:"unsubscribe:request",option:i}),Fe.info(Se.L_MLL_T,{option:i}),ot.post(i).then(function(t){je.log(X.LIVE_HANDLER,{msg:"unsubscribe:request:success",response:t}),Fe.info(Se.L_MLL_R,{response:t}),e.clearSubLiveUrl(),e.SubStreamCache=null},function(e){return je.log(X.LIVE_HANDLER,{msg:"unsubscribe:request:error",error:e}),Fe.error(Se.L_MLL_E,{error:e}),e})})},function(e){return je.log(X.LIVE_HANDLER,{msg:"getrtctoken:error",error:e}),e})}},{key:"setSubLiveUrl",value:function(e){this.SubLiveUrlsCache=e}},{key:"getSubLiveUrl",value:function(){return this.SubLiveUrlsCache}},{key:"clearSubLiveUrl",value:function(){this.SubLiveUrlsCache=null}},{key:"isSubscribed",value:function(){return!!this.SubLiveUrlsCache}},{key:"reconnect",value:function(){var e=this,t=e.getSubLiveUrl();e.clearSubLiveUrl(),e.subscribe({liveUrl:t})}},{key:"destroy",value:function(){var e=this,t=e.pc,r=e.im;t&&(t.close(),r.emit(We.PEERCONN_DESTROYED))}}]),e}(),mt=function(e){var t=e.RongIMLib;return t.SDK_VERSION;// im v3 可通过 SDK_VERSION 获取版本号
},lt=function(e){var t=e.RongIMLib.RongIMClient,r=e.RongIMLib,a=t.getInstance(),n=function(e){var r=t.getInstance();return!!r[e]||(je.warn(X.IM,{msg:"Low version IM SDK is not supported, please update IM SDK"}),!1)},o=function(e,a){var n=new r.MessageTag(!1,!1),o=a.content,s=w.map(w.toArray(o),function(e){return e[0]});t.registerMessageType(e,e,n,s)},s=function(){var e=-1;try{e=t.getInstance().getCurrentConnectionStatus()}catch(e){je.error(X.IM,{content:e,pos:"new RongRTC"})}return e};return{CONNECTION_STATUS:r.ConnectionStatus,isConnected:function(){var e=s();return w.isEqual(e,r.ConnectionStatus.CONNECTED)},statusWatch:t.statusWatch,messageWatch:function(e){e=e||w.noop,t.messageWatch(function(r){var a=r.messageType,n=w.isEqual(t.MessageType.UnknownMessage,a),o=w.parse(w.toJSON(r)),s={};if(n){var i=o.content;s=i.message.content}else s=o.content;w.extend(o,{content:s}),o={name:o.objectName,uId:o.messageUId,senderId:o.senderUserId,content:o.content},e(o)})},joinRTCRoom:function(e){return w.deferred(function(t,r){a.joinRTCRoom(e,{onSuccess:t,onError:r})})},quitRTCRoom:function(e){return w.deferred(function(t,r){a.quitRTCRoom(e,{onSuccess:t,onError:r})})},getRTCRoomInfo:function(e){return w.deferred(function(t,r){a.getRTCRoomInfo(e,{onSuccess:t,onError:r})})},getRTCUserInfoList:function(e){return w.deferred(function(t,r){a.getRTCUserInfoList(e,{onSuccess:t,onError:r})})},getRTCToken:function(e){return w.deferred(function(t,r){a.getRTCToken(e,{onSuccess:t,onError:r})})},getNavi:function(){return a.getNavi()},getCurrentUserId:function(){return a.getCurrentUserId()},getCurrentConnectionStatus:s,setRTCUserInfo:function(e,t){return w.deferred(function(r,n){a.setRTCUserInfo(e,t,{onSuccess:r,onError:n})})},removeRTCUserInfo:function(e,t){return w.deferred(function(r,n){a.removeRTCUserInfo(e,t,{onSuccess:r,onError:n})})},/**
       * 发布资源 / 取消发布
       */setRTCUserData:function(e,t,r,n,o){return w.deferred(function(s,i){a.setRTCUserData(e,t,r,n,{onSuccess:s,onError:i},o)})},/**
       * 全量 URI 资源发布
       * @param {string} roomId 房间 ID
       * @param {{ name: string, content: string }} message 旧版本消息，含消息名及消息内容
       * @param {string} valueInfo 全量消息数据
       * @param {string} objectName 全量 URI 消息名
       */setRTCUserTotalRes:function(e,t,r,n){return w.deferred(function(o,s){a.setRTCUserTotalRes(e,t,r,n,{onSuccess:o,onError:s})})},getRTCUserData:function(e,t,r){return w.deferred(function(n,o){a.getRTCUserData(e,t,r,{onSuccess:n,onError:o})})},removeRTCUserData:function(e,t,r,n){return w.deferred(function(o,s){a.removeRTCUserData(e,t,r,{onSuccess:o,onError:s},n)})},setRTCRoomData:function(e,t,r,n,o){return w.deferred(function(s,i){a.setRTCRoomData(e,t,r,n,{onSuccess:s,onError:i},o)})},getRTCRoomData:function(e,t,r){return w.deferred(function(n,o){a.getRTCRoomData(e,t,r,{onSuccess:n,onError:o})})},removeRTCRoomData:function(e,t,r,n){return w.deferred(function(n,o){a.removeRTCRoomData(e,t,r,{onSuccess:n,onError:o})},n)},setRTCState:function(e,t){return n("setRTCState")?w.deferred(function(r,n){a.setRTCState(e,t,{onSuccess:r,onError:n})}):""},getRTCUserList:function(e){return w.deferred(function(t,r){a.getRTCUserList(e,{onSuccess:t,onError:r})})},getAppInfo:function(){var e=a.getAppInfo();return{appKey:e.appKey}},RTCPing:function(e){return w.deferred(function(t,r){a.RTCPing(e,{onSuccess:t,onError:r})})},getIMVersion:function(){if(!n("getSDKInfo"))return"";var e=t.getInstance().getSDKInfo();return e.version||""},isSupportRTC:function(){var e=!1;return w.isFunction(t.prototype.RTCPing)&&(e=!0),e},sendMessage:function(e,r){var n=e.name,s=e.content,i=t.RegisterMessage[n];i||o(n,e);var d=new t.RegisterMessage[n](s);return w.deferred(function(e,t){a.sendMessage(12,r,d,{onSuccess:e,onError:t})})}}},gt=function(e){var t=e.RongIMLib,r=t.RongIMClient?t.RongIMClient.getIMv3():t.getInstance(),a=t.CONNECTION_STATUS;if(!(r.rtcInnerUnwatch&&r.rtcInnerWatch))throw new Error("Please upgrade RongIMLib version");return{CONNECTION_STATUS:a,isConnected:function(){var e=r.getConnectionStatus();return w.isEqual(e,a.CONNECTED)},statusWatch:function(e){r.rtcInnerWatch({status:function(t){var r=t.status;e(r)}})},messageWatch:function(e){e=e||w.noop,r.rtcInnerWatch({message:function(r){var a=r.message,n=a.messageType,o=a.type,s=w.isEqual(o,t.CONVERSATION_TYPE.RTC_ROOM);s&&e({name:n,uId:a.messageUId,senderId:a.senderUserId,content:a.content})}})},joinRTCRoom:function(e){var t=new r.RTC(e);return t.join()},quitRTCRoom:function(e){var t=new r.RTC(e);return t.quit()},getRTCRoomInfo:function(e){var t=new r.RTC(e);return t.getRoomInfo()},getRTCUserInfoList:function(e){var t=new r.RTC(e);return t.getUserInfoList()},getRTCToken:function(e){var t=new r.RTC(e);return t.getToken()},getNavi:function(){var e=r.getAppInfo();return e.navi},getCurrentUserId:function(){return r.getConnectionUserId()},getCurrentConnectionStatus:function(){return r.getConnectionStatus()},setRTCUserInfo:function(e,t){var a=new r.RTC(e);return a.setUserInfo(t)},removeRTCUserInfo:function(e,t){var a=new r.RTC(e);return a.removeUserInfo(t)},setRTCUserData:function(e,t,a,n,o){var s=new r.RTC({id:e});return s.setUserData(t,a,n,o)},/**
       * 全量 URI 资源发布
       * @param {string} roomId 房间 ID
       * @param {{ name: string, content: string }} message 旧版本消息，含消息名及消息内容
       * @param {string} valueInfo 全量消息数据
       * @param {string} objectName 全量 URI 消息名
       */setRTCUserTotalRes:function(e,t,a,n){var o=new r.RTC({id:e});return o.setRTCUserData(t,a,n)},getRTCUserData:function(e,t,a){var n=new r.RTC({id:e});return n.getUserData(t,a)},removeRTCUserData:function(e,t,a,n){var o=new r.RTC({id:e});return o.removeUserData(t,a,n)},setRTCRoomData:function(e,t,a,n,o){var s=new r.RTC({id:e});return s.setRoomData(t,a,n,o)},getRTCRoomData:function(e,t,a){var n=new r.RTC({id:e});return n.getRoomData(t,a)},removeRTCRoomData:function(e,t,a,n){var o=new r.RTC({id:e});return o.removeRoomData(t,a,n)},setRTCState:function(e,t){var a=new r.RTC(e);return a.setState(t)},getRTCUserList:function(e){var t=new r.RTC(e);return t.getUserList()},getAppInfo:function(){var e=r.getAppInfo();return{appKey:e.appkey}},RTCPing:function(e){var t=new r.RTC(e);return t.ping()},getIMVersion:function(){return t.SDK_VERSION},isSupportRTC:function(){var e=!1;return r.RTC&&(e=!0),e},sendMessage:function(e,t){var a=e.name,n=e.content,o=new r.RTC({id:t});return o.send({messageType:a,content:n})}}},ut={get:function(e){return mt(e)?gt(e):lt(e)}},Et={PUBLISH:"RTCPublishResourceMessage",UNPUBLISH:"RTCUnpublishResourceMessage",MODIFY:"RTCModifyResourceMessage",STATE:"RTCUserChangeMessage",ROOM_NOTIFY:"RTCRoomDataNotifyMessage",USER_NOTIFY:"RTCUserDataNotifyMessage",KICK:"RTCUserKickMessage",TOTAL_CONTENT_RESOURCE:"TotalContentResources"},Rt={PUBLISH:"RCRTC:PublishResource",UNPUBLISH:"RCRTC:UnpublishResource",MODIFY:"RCRTC:ModifyResource",STATE:"RCRTC:state",ROOM_NOTIFY:"RCRTC:RoomNtf",USER_NOTIFY:"RCRTC:UserNtf",KICK:"RCRTC:kick",TOTAL_CONTENT_RESOURCE:"RCRTC:TotalContentResources"},St={TIME:10000},Tt=function(e){var t=q[e]||{code:e};return t},_t=function(e){return e===Et.PUBLISH?Rt.PUBLISH:e===Et.UNPUBLISH?Rt.UNPUBLISH:e===Et.MODIFY?Rt.MODIFY:e===Et.STATE?Rt.STATE:e===Et.ROOM_NOTIFY?Rt.ROOM_NOTIFY:e===Et.USER_NOTIFY?Rt.USER_NOTIFY:e===Et.KICK?Rt.KICK:e===Et.TOTAL_CONTENT_RESOURCE?Rt.TOTAL_CONTENT_RESOURCE:void 0},ht=function(e,t){return e.filter(function(e){return t.every(function(t){var r=t.msid,a=t.mediaType;return r!==e.msid||a!==e.mediaType})})},yt=function(e,t){return t.forEach(function(t){var r=t.msid,a=t.mediaType;e.some(function(e){return e.msid===r&&a===e.mediaType})||e.push(t)}),e},ft=function(e,t){return t.forEach(function(t){for(var r=t.msid,a=t.mediaType,n=t.state,o=e.length-1,s;0<=o;o-=1)if(s=e[o],r===s.msid&&a===s.mediaType){s.state=n;break}}),e},Ct=function(e){function t(e){m(this,t);// 己方已已发布的全量资源清单
var r=u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));r.uris=[],r.otherUris={};var a=new w.Timer({timeout:St.TIME}),n=w.Cache(),o=r;w.extend(o,{timer:a,isJoinRoom:!1,clientSessionId:"",v2Users:n,option:e});var s=ut.get(e),i=s.CONNECTION_STATUS,d=function(){o.isJoinRoom&&o.rePing();var e=o.getMSUrl(),t=o.getRequestTimeout();ot.isUrlsExisted(e)||ot.addUrls(e),ot.setOption({timeout:t})},c=s.getCurrentConnectionStatus();w.extend(o,{connectState:c,im:s}),s.isConnected()&&d(),s.statusWatch=s.statusWatch||w.noop,s.statusWatch(function(e){e===i.CONNECTED?(d(),o.emit(We.CONNECTED)):void 0,w.extend(o,{connectState:e})});var p=function(e){w.forEach(e,function(e){var t=e.userId,a=e.state;switch(+a){case z.JOINED:o.emit(B.ROOM_USER_JOINED,{id:t});break;case z.LEFT:case z.OFFLINE:je.log(X.ROOM,{msg:"room:member:left",user:e}),delete r.otherUris[t],o.emit(B.ROOM_USER_LEFT,{id:t});break;default:je.warn("UserState: unkown state "+a);}})};s.messageWatch=s.messageWatch||w.noop;return s.messageWatch(function e(t){/*
          新版本 RTC SDK 通过 TotalContentResource 消息处理资源订阅，
          通过记录的资源与 TotalContentResource 内的 uris 数据比对来定义用户是增加发布或取消发布
          PublishResource、UnpublishResource、ModifyResource 消息内增加 ignore 属性，用于通知新版 SDK 略过处理
         */var a=t.name,s=t.senderId,i=t.content,d=i.uris,c=i.users,m=i.ignore,l=t.uId;if(!0===m)return void je.log(X.IM,{msg:"receive:message",ignore:m,message:t});if(a===Rt.TOTAL_CONTENT_RESOURCE){je.log(X.IM,{msg:"receive:message",message:t});var g=r.otherUris[s]||(r.otherUris[s]=[]);// 没有资源记录，资源为新发布，模拟 PublishResource 消息进行递归，以复用原业务代码
if(0===g.length)return r.otherUris[s]=d,void e({name:Rt.PUBLISH,senderId:s,content:{uris:d},uId:l});// 已有资源记录，比对资源
var u=/**
           * @param {Array} before
           * @param {Array} now
           */function(e,t){var r=[],a=[],n=[];return t.forEach(function(t){// 新资源数据
// 遍历旧版资源
for(var n=t.mediaType,o=t.msid,s=t.state,d=t.uri,c=e.length-1;0<=c;c-=1){var p=e[c],m=p.mediaType,l=p.msid,g=p.state,u=p.uri;if(m===n&&l===o)return d===u?g!==s&&a.push(t):r.push(t),void e.splice(c,1)}// 剩余新增资源
r.push(t)}),n.push.apply(n,R(e)),{published:r,modified:a,unpublished:n}}(g.slice(),d.slice()),E=u.published,S=u.modified,T=u.unpublished;// 重新备份记录
return r.otherUris[s]=d,0<E.length&&e({name:Rt.PUBLISH,senderId:s,content:{uris:E},uId:l}),0<T.length&&e({name:Rt.UNPUBLISH,senderId:s,content:{uris:T},uId:l}),void(0<S.length&&e({name:Rt.MODIFY,senderId:s,content:{uris:S},uId:l}))}var _={id:s};w.isArray(d)&&(d=w.map(d,function(e){var t=e.tag;return Ue(t)&&w.extend(e,{tag:pe}),e})),a===Rt.STATE?p(c):a===Rt.KICK?o.emit(B.ROOM_USER_KICK,{msg:q.Inner.ROOM_USER_KICK}):a===Rt.PUBLISH?(_={id:s,uris:d},w.isInclude(s,"_")&&n.set(s,!0),Me(_,function(e){o.emit(B.STREAM_PUBLISHED,e)})):a===Rt.UNPUBLISH?(_={id:s,uris:d},Me(_,function(e){o.emit(B.STREAM_UNPUBLISHED,e)})):a===Rt.MODIFY?(_={id:s,uris:d},Me(_,function(e){be(e,function(e,t){o.emit(e,t)})})):o.emit(B.MESSAGE_RECEIVED,t)}),r}return g(t,e),l(t,[{key:"isConnected",value:function(){return this.im.isConnected()}},{key:"joinRoom",value:function(e){var t=this,r=t.im;return w.extend(t,{room:e,isJoinRoom:!0,clientSessionId:w.getUUID()}),Fe.info(Se.P_JRAGD_T,{room:e}),r.joinRTCRoom(e).then(function(r){var a=r.users,n=r.token,o=r.sessionId;t.rtcPing(e);var s=t.getUser(),i=s.id,d=t.otherUris={},c=w.clone(a);// 更新 uris
return je.log(X.IM,{msg:"join:room:inner:success",users:c}),w.forEach(c,function(e,r){// 过滤自己 utils.isEmpty(tUser) ||
if(e=e||{},w.isEqual(i,r))delete a[r];else{var n=a[r],o=n.uris;t.v2Users.set(r,!0),w.isUndefined(o)||(o=w.isString(o)?w.parse(o):o,w.extend(n,{uris:o})),d[r]=o}}),w.extend(e,{rtcToken:n,users:a,sessionId:o}),t.emit(We.JOINED,e),Fe.info(Se.P_JRAGD_R,{roomId:e.id,users:a,rtcToken:n,sessionId:o}),a}).catch(function(t){return Fe.warn(Se.P_JRAGD_E,{roomId:e.id,code:t}),w.Defer.reject(Tt(t))})}},{key:"leaveRoom",value:function(){var e=this;// 清除全量 URI 相关缓存数据
this.otherUris={},this.uris.length=[];var t=e.im,r=e.room,a=e.timer;return a.pause(),w.extend(e,{isJoinRoom:!1,clientSessionId:""}),e.emit(We.LEFT,r),t.quitRTCRoom(r).catch(function(e){return w.Defer.reject(Tt(e))})}},{key:"getRoom",value:function(){var e=this.im,t=this.room;return e.getRTCRoomInfo(t).catch(function(e){return w.Defer.reject(Tt(e))})}},{key:"getUsers",value:function(){var e=this.im,t=this.room;return e.getRTCUserInfoList(t).catch(function(e){return w.Defer.reject(Tt(e))})}},{key:"getRTCToken",value:function(){var e=this.room.rtcToken;return e}},{key:"getRTCTokenAsyn",value:function(e){var t=this.im,r=this.option,a=r.mode,n=r.liveType;return t.getRTCToken({id:e,mode:a,broadcastType:n}).then(function(e){return Fe.info(Se.L_GRT_R,{result:e}),e}).catch(function(e){return Fe.info(Se.L_GRT_E,{error:e,desc:"get rtc token asyn"}),w.Defer.reject(e)})}},{key:"getRoomId",value:function(){var e=this.room.id;return e}},{key:"getClientSessionId",value:function(){return this.clientSessionId}},{key:"getSessionId",value:function(){var e=this.room.sessionId;return e}},{key:"getNaviRTCInfo",value:function(){var e=this.im,t=e.getNavi(),r=t.voipCallInfo;r=r||"{\"callEngine\": [{}]}",r=w.parse(r);var a=r.callEngine,n=w.filter(a,function(t){return 4===t.engineType})[0]||{};return n}},{key:"getRequestTimeout",value:function(){var e=this.getNaviRTCInfo(),t=e.timeOut;return t&&w.isNumber(t)?t*=1e3:t=ae,t}},{key:"getMSUrl",value:function(){var e=this.getNaviRTCInfo(),t=e.backupMediaServer,r=e.mediaServer;return w.isUndefined(t)&&(t=[]),w.isString(t)&&(t=t.split(",")),w.isUndefined(r)||t.unshift(r),t=w.filter(t,function(e){return Ge(e)}),t}},{key:"getUser",value:function(){var e=this.room.user;return e}},{key:"getUserId",value:function(){var e=this.im;return e.getCurrentUserId()}},{key:"setUserInfo",value:function(e,t){var r=this.room,a=this.im;t=w.toJSON(t);var n={key:e,value:t};return a.setRTCUserInfo(r,n)}},{key:"removeUserInfo",value:function(e){var t=this.room,r=this.im;return r.removeRTCUserInfo(t,{keys:e})}},{key:"setUserData",value:function(e,t,r,a){var n=this.room.id,o=this.im;t=w.toJSON(t),je.log(X.STREAM_HANDLER,{msg:"setUserData:before",roomId:n,value:t,message:a});var s=a.name,i=JSON.parse(a.content);i.ignore=!0,a.content=JSON.stringify(i),s===Rt.UNPUBLISH?this.uris=ht(this.uris,i.uris):a.name===Rt.PUBLISH?this.uris=yt(this.uris,i.uris):a.name===Rt.MODIFY&&(this.uris=ft(this.uris,i.uris));var d=JSON.stringify(this.uris),c=o.setRTCUserTotalRes(n,a,d,Rt.TOTAL_CONTENT_RESOURCE);// 发布全量 URI 资源
// 2020-07-15: 服务会代发旧版本 SDK 无需再发送
// ~~旧版本信令需照常发送，以适配老版本 SDK~~
// im.setRTCUserData(id, key, value, isInner, message).then(() => {
//   Logger.log(LogTag.STREAM_HANDLER, {
//     msg: 'setUserData:after',
//     roomId: id,
//     value,
//     message
//   });
// });
return c}},{key:"getUserData",value:function(e,t){var r=this.room.id,a=this.im;return w.isArray(e)||(e=[e]),a.getRTCUserData(r,e,t)}},{key:"removeUserData",value:function(e,t,r){var a=this.room.id,n=this.im;return w.isArray(e)||(e=[e]),n.removeRTCUserData(a,e,t,r)}},{key:"setRoomData",value:function(e,t,r,a){var n=this.room.id,o=this.im;return o.setRTCRoomData(n,e,t,r,a)}},{key:"getRoomData",value:function(e,t){var r=this.room.id,a=this.im;return w.isArray(e)||(e=[e]),a.getRTCRoomData(r,e,t)}},{key:"removeRoomData",value:function(e,t,r){var a=this.room.id,n=this.im;return w.isArray(e)||(e=[e]),n.removeRTCRoomData(a,e,t,r)}},{key:"getExistUsers",value:function(){var e=this.im,t=this.room;return e.getRTCUserList(t).catch(function(e){return w.Defer.reject(Tt(e))})}},{key:"sendMessage",value:function(e){var t=this.im,r=this.room;return je.log(X.IM,{msg:"send:before",message:e}),t.sendMessage(e,r.id).then(function(){return je.log(X.IM,{msg:"send:after",message:e}),r}).catch(function(e){return je.log(X.IM,{msg:"send:after",error:e}),w.Defer.reject(e)})}},{key:"getMessage",value:function(e,t){var r=_t(e);return t=w.toJSON(t),{name:r,content:t}}},{key:"isIMReady",value:function(){var e=this,t=e.im;return e.connectState===t.CONNECTION_STATUS.CONNECTED}},{key:"getAppInfo",value:function(){var e=this,t=e.im;return t.getAppInfo()}},{key:"isJoined",value:function(){var e=this;return e.isJoinRoom}},{key:"isSupportRTC",value:function(){var e=this,t=e.im;return t.isSupportRTC()}},{key:"rePing",value:function(){var e=this,t=e.timer,r=e.getRoomId();w.isUndefined(r)||(t.pause(),e.rtcPing({id:r}))}},{key:"rtcPing",value:function(e){var t=this,r=t.im,a=t.timer,n=0,o=!1,s={reset:function(){n=0,o=!1},sum:function(){n+=1}},i=q.Inner;a.resume(function(){return n>4?(a.pause(),w.extend(t,{isJoinRoom:!1,clientSessionId:""}),r.isJoinedRTCRoom=!1,t.emit(We.LEFT),t.emit(We.ERROR,i.SOCKET_UNAVAILABLE)):void(o&&s.sum(),o=!0,r.RTCPing(e).then(function(){s.reset()}).catch(function(e){je.error(X.IM,{msg:"RTC Ping Error"+e})}));// 如果上次 Ping 没有结束，累计 Ping 次数
},!0)}},{key:"getIMVersion",value:function(){return this.im.getIMVersion()}},{key:"setRTCState",value:function(e){var t=this.im,r=this.room;return t.setRTCState(r,e)}}]),t}(qe),vt={USERS:"room_users",// 全部通知后一次性交换 SDP
IS_NOTIFY_READY:"is_notify_ready"},It=function(e){return{SET_USERINFO:"uris",set:function(t,r,a,n){return e.setUserData(t,r,a,n)}}},At=function(e){return navigator.mediaDevices.getUserMedia(e).then(function(e){return{mediaStream:e}})},Dt=function(e){var t=e,r=t.desktopStreamId;if(!r){var a=q.Inner;return w.Defer.reject(a.STREAM_DESKTOPID_ILLEGAL)}return e={video:{getDisplayMedia:{chromeMediaSource:"desktop",chromeMediaSourceId:r}}},At(e)},Ot=function(e){w.isEmpty(e)&&(e={video:!0,audio:!0});var t=e,r=t.video;if(w.isObject(r)){var a=!w.isEmpty(r.resolution)&&w.isObject(he[r.resolution]);r=a?w.extend(r,he[r.resolution]):w.extend(r,ee)}return w.isBoolean(r)&&r&&(r=ee),w.extend(e,{video:r}),At(e)},Lt={switchCahce:{},set:function(e,t){switch(e){case J.AUDIO:this.switchCahce.audio=t;break;case J.VIDEO:this.switchCahce.video=t;break;default:}},get:function(){return this.switchCahce},clear:function(){this.switchCahce={}}},Mt=function(){function e(t,r){m(this,e);var a=this;a.StreamCache=w.Cache(),a.DataCache=w.Cache(),a.SubPromiseCache=w.Cache(),a.PubResourceCache=w.Cache(),a.PublishStreamCache=w.Cache(),a.subCache=w.Cache();// 缓存订阅关系，每次修改需同步全量数据. userId: [{ streamId: '', uri: '', type: 1, tag: ''}]
var n=r.detect;w.extend(a,{option:r,im:t}),a.network=new ze(n),a.User=It(t),a.SubscribeCache={get:function(e){return a.subCache.get(e)},set:function(e,t){return a.subCache.set(e,t)},getKeys:function(){return a.subCache.getKeys()},remove:function(e){var t=a.pc,r=e.id,n=e.stream||{},o=w.isUndefined(n.type),s=o?J.AUDIO_AND_VIDEO:n.type,i=t.getStreamId(e),d=a.subCache.get(r)||[];d=w.filter(d,function(e){var t=e.msid,r=e.type,a=w.isEqual(i,t),n=w.isEqual(r,s)||w.isEqual(s,J.AUDIO_AND_VIDEO);return!(a&&n)}),a.subCache.set(r,d)},clear:function(){a.subCache.clear()},setState:function(e,t){t=t||{};var r=t,n=r.type,o=r.state,s=a.SubscribeCache.get(e);w.forEach(s,function(e,t){var r=e.type;w.isEqual(n,r)&&(s[t].state=o)})}},a.setPC(),t.on(We.CONNECTED,function(){var e=a.DataCache,t=e.get(vt.USERS);t&&a.compare()}),t.on(B.STREAM_PUBLISHED,function(e,r){if(e)throw e;// 缓存 URIs 上报数据
var n=r.stream;t.emit(We.SET_URIS,n.uris),a.dispatchStreamEvent(r,function(e,t){a.DataCache.set(e,t)})}),t.on(We.LEFT,function(){var e=a.StreamCache,t=a.pc,r=e.getKeys();w.forEach(r,function(t){var r=e.get(t),a=r.getTracks();w.forEach(a,function(e){e.stop()})}),a.clear(),t&&t.close()}),t.on(We.JOINED,function(e,t){if(e)throw e;a.setPC();var r=t.users;a.usersHandler(r),je.log(X.ROOM,{msg:"join successfully",room:t})}),t.on(B.ROOM_USER_LEFT,function(e,t){if(e)throw e;var r=a.getUsersById(t);w.forEach(r,function(e){a.unsubscribe(e)})}),t.on(B.STREAM_UNPUBLISHED,function(e,t){if(e)throw e;a.dispatchStreamEvent(t,function(e){a.DataCache.remove(e)}),a.unsubscribe(t)}),t.on(B.STREAM_DISABLED,function(e,t){var r=a.pc,n=a.StreamCache,o=r.getStreamId(t),s=n.get(o);if(a.SubscribeCache.setState(t.id,{type:J.VIDEO,state:W.DISBALE}),!!s){var i=s.getVideoTracks();w.forEach(i,function(e){e.enabled=!1})}}),t.on(B.STREAM_ENABLED,function(e,t){var r=a.pc,n=a.StreamCache,o=r.getStreamId(t),s=n.get(o);if(a.SubscribeCache.setState(t.id,{type:J.VIDEO,state:W.ENABLE}),!!s){var i=s.getVideoTracks();w.forEach(i,function(e){e.enabled=!0})}}),t.on(B.STREAM_MUTED,function(e,t){a.SubscribeCache.setState(t.id,{type:J.AUDIO,state:W.DISABLE})}),t.on(B.STREAM_UNMUTED,function(e,t){a.SubscribeCache.setState(t.id,{type:J.AUDIO,state:W.ENABLE})})}return l(e,[{key:"setPC",value:function(){var e=this;// 如果已创建 peerconnection, 则不再处理
if(!e.pc||e.pc.isClosed()){e.pc=new ct(e.option),e.im.emit(We.PEERCONN_CREATED,e.pc);var t=e.pc,r=e.im,a=e.network,n=e.StreamCache,o=e.SubscribeCache,s=e.SubPromiseCache,i=function(t){var a=t.id;n.set(a,t);var i=e.getStreamUser(t),d=o.get(i.id)||[];w.forEach(d,function(e){var r=e.state,a=e.type,n=w.isEqual(J.VIDEO,a),o=w.isEqual(r,W.DISBALE),s=w.isEqual(t.id,e.msid);if(n&&o&&s){// if (isVideo && isDisabled) {
var i=t.getVideoTracks();w.forEach(i,function(e){e.enabled=!1})}}),r.emit(We.PUBLISHED_STREAM,{mediaStream:t,user:i});var c=e.getSubPromiseUId(i),p=s.get(c);return w.isUndefined(p)?je.log(X.STREAM,{msg:"stream added-part",user:i,tracks:t.getTracks()}):void(je.log(X.STREAM,{msg:"stream added",user:i,tracks:t.getTracks()}),p.resolve(i))};t.on(Je.ADDED,function(e,t){if(e)throw e;i(t)}),t.on(Je.REMOVED,function(e,t){if(e)throw e;var r=t.id;n.remove(r)}),t.on(Je.TRACK_RECEIVED,function(e,t){if(e)throw e;w.isArray(t)&&w.forEach(t,i)}),t.on(Je.SIGNAL_STATE_CHANGE,function(e,t){// 当订阅对方音视频后, 取消订阅视频或音频, 再重新订阅时, ontrack、onaddstream 都不会触发. 因取消订阅不会移除 track, 只会使其失效
// 所以在此增加监听, 避免上述情况 subscribe 无回调
if(e)throw e;w.isArray(t)&&w.forEach(t,i)}),t.on(Je.CHANGED,function(){t.isNegotiate()&&r.isJoined()&&a.detect(function(t){if(t)e.reconnect();else{var a=q.Inner;r.emit(We.ERROR,a.NETWORK_UNAVAILABLE)}})})}}/* 清空缓存数据 */},{key:"clear",value:function(){var e=this;e.DataCache.clear(),e.SubPromiseCache.clear(),e.PubResourceCache.clear(),e.StreamCache.clear(),e.SubscribeCache.clear(),e.PublishStreamCache.clear()}},{key:"getUsersById",value:function(e){var t=this.SubscribeCache,r=e.id,a=t.get(r),n={},o={};w.forEach(a,function(e){var t=e.msid,r=e.tag,a=e.type;n[t]=r;var s=o[t]||[];s.push(a),o[t]=s});var s=[];return w.forEach(n,function(e,t){var a=o[t]||[],n=o[0];n=w.isEqual(a.length,2)?J.AUDIO_AND_VIDEO:n,s.push({id:r,stream:{tag:e,type:n}})}),s}},{key:"getStreamUser",value:function(e){var t=this.im,r=this.pc,a=this.DataCache,n=e.id,o=t.v2Users.get(n),s=J.NODE,i=void 0,d=void 0;if(o)i=n,d=pe;else{var c=r.getStreamSymbolById(n),p=E(c,2);i=p[0],d=p[1],Ue(d)&&(d=pe)}var m=e.getVideoTracks(),l=e.getAudioTracks(),g=w.isEmpty(m),u=w.isEmpty(l),R="{id}_{type}",S=w.tplEngine(R,{id:n,type:J.VIDEO}),T=w.tplEngine(R,{id:n,type:J.AUDIO}),_=a.get(S),h=a.get(T);g=g||w.isEmpty(_),u=u||w.isEmpty(h),g&&(s=J.AUDIO),u&&(s=J.VIDEO);var y=!0,f=!0;return u||g||(s=J.AUDIO_AND_VIDEO,w.isEqual(_.state,W.DISBALE)?y=!1:w.isEqual(h.state,W.DISBALE)&&(f=!1)),{id:i,stream:{tag:d,type:s,mediaStream:e,enable:{video:y,audio:f}}}}/* 获取缓存的 Promise 唯一标识, 可共用 */},{key:"getSubPromiseUId",value:function(e){var t=e.id,r=e.stream.tag;// 不同 type, 都为一道流, 可只根据 tag、id 辨别
return w.tplEngine("{id}_{tag}",{id:t,tag:r})}/* 可共用 */},{key:"getUId",value:function(e,t){t=t||"{userId}_{tag}_{type}";var r=e.id,a=e.stream,n=a.tag,o=a.type;return w.isEmpty(n)&&(t="{userId}_{type}"),w.tplEngine(t,{userId:r,tag:n,type:o})}/* 获取缓存的所有 subs */},{key:"getSubs",value:function(){var e=this,t=e.SubscribeCache,r=[],a=t.getKeys();return w.forEach(a,function(e){var a=t.get(e);w.forEach(a,function(e){r.push(e)})}),r}/* 获取请求 body 体 */},{key:"getBody",value:function(e){var t=this,r=t.pc,a=t.PublishStreamCache,n=t.getSubs(),o=[],s=a.getKeys();o=w.map(s,function(e){var t=a.get(e);return{id:e,mediaStream:t}});var i=r.getStreamRatio(o),d=function(e){var t=[];for(var r in e){var a={trackId:e[r][0].videoTrackId};delete a.videoTrackId,delete e[r][0].videoTrackId,w.extend(a,e[r][0]),t.push(a)}return JSON.stringify({resolutionInfo:t})}(i),c={subscribeList:n,resolutionInfo:i,extend:d};return e?(w.extend(c,{sdp:e}),w.Defer.resolve(c)):r.getOffer().then(function(e){return w.extend(c,{sdp:e}),c})}/* 设置远端 anwser, 本地 offer */},{key:"negotiate",value:function(e,t){var r=this.pc;r.setOffer(e);var a=t.sdp;r.setAnwser(a)}},{key:"getDeviceSwitchState",value:function(e,t){var r=Lt.get(),a=W.ENABLE;return /RongCloudRTC/.test(e)&&(t===J.AUDIO?a=r.audio:t===J.VIDEO&&(a=r.video)),a}},{key:"getUris",value:function(e){var t=this,r=this.pc;return w.map(e,function(e){var a=e.msid,n=e.mediaType,o=r.getTagByStreamId(a);return w.extend(e,{tag:o,state:t.getDeviceSwitchState(o,n)}),e})}/* 获取流 track 的可用状态, 格式为: { video: false, audio: true }. 可共用 */},{key:"getTrackState",value:function(e){w.isArray(e)||(e=[e]);var t={};return w.forEach(e,function(e){var r=e.mediaStream,a=r.streamId,n=r.getVideoTracks(),o=r.getAudioTracks(),s=function(e){return w.isEqual(e.enabled,!1)},i=W.ENABLE;w.some(n,s)&&(i=W.DISBALE);var d=W.ENABLE;w.some(o,s)&&(d=W.DISBALE),t[a]={video:i,audio:d}}),t}},{key:"dispatchStreamEvent",value:function(e,t){var r=this,a=e.id,n=e.stream.uris;w.forEach(n,function(e){var n=e.tag,o=e.mediaType,s=r.getUId({id:a,stream:{tag:n,type:o}});t(s,e)})}},{key:"updateTrackState",value:function(e,t,r){var a=this,n=e.stream,o=a.getTrackState(n),s=function(e){w.forEach(o,function(t,r){var a=t.audio,n=t.video;w.map(e,function(e){var t=w.isEqual(e.msid,r);return t&&w.isEqual(e.mediaType,J.VIDEO)&&w.extend(e,{state:n}),t&&w.isEqual(e.mediaType,J.AUDIO)&&w.extend(e,{state:a}),e})})};return s(t),s(r),{sendUris:t,uris:r}}},{key:"appendStreamId",value:function(e){var t=this.pc,r=e.id,a=e.stream;w.isArray(a)||(a=[a]),w.map(a,function(e){var a=t.getStreamId({id:r,stream:e}),n=e.mediaStream;w.extend(n,{streamId:a})})}},{key:"usersHandler",value:function(e){var t=this,r=t.DataCache,a=t.im;r.set(vt.USERS,e);var n=a.getUser(),o=n.id;w.forEach(e,function(e,n){var s=e.uris;if(w.isUndefined(s))return void je.log(X.STREAM_HANDLER,{msg:"user exist, uris is empty",user:{id:n}});if(w.isEqual(o,n)){var i=E(s,1),d=i[0];if(w.isUndefined(d))return;var c=d.mediaType,p=d.tag;c=w.isEqual(s.length,1)?c:J.AUDIO_AND_VIDEO;var m={id:n,stream:{tag:p,type:c}};return t.unpublish(m);// 会议内已有自己, 先 unpublish
}w.forEach(s,function(e){var a=e.mediaType,o=e.tag,s=t.getUId({id:n,stream:{type:a,tag:o}});r.set(s,e)});var l=w.uniq(s,function(e){var t=e.tag,r=e.msid||e.streamId;return Ue(t)&&(t=pe),{key:[r].join("_"),value:{tag:t}}});w.forEach(l,function(e){var t=e.tag,r=w.filter(s,function(e){var r=e.msid;return w.isInclude(r,t)});setTimeout(function(){a.emit(B.STREAM_PUBLISHED,{id:n,stream:{tag:t,uris:r}})})})})}},{key:"setOptionBitrate",value:function(e,t){var r=this.option.bitrate;r.max+=e,r.min+=t,r.start=.7*r.max,r.max=r.max>he.RESOLUTION_176_132.maxBitRate?r.max:he.RESOLUTION_176_132.maxBitRate,r.min=r.min>he.RESOLUTION_176_132.minBitRate?r.min:he.RESOLUTION_176_132.minBitRate,r.start=r.start>.7*r.max?r.start:.7*r.max}},{key:"setBitrate",value:function(e,t){var r=this,a=e.stream;// let { option: { bitrate } } = context;
w.isArray(a)||(a=[a]),w.forEach(a,function(e){var a=e.bitrate,n=e.mediaStream,o={},s=0,i=0;w.isEmpty(n.getVideoTracks())||(o=n.getVideoTracks()[0].getConstraints());var d="RESOLUTION_"+o.width+"_"+o.height,c=he[d];if(w.isEmpty(c)&&(c=he.RESOLUTION_640_480),!w.isEmpty(a))return s=a.max||c.maxBitRate,i=a.min||c.minBitRate,void r.setOptionBitrate(s,i);if(!w.isEmpty(c)&&w.isObject(c)){var p=ye[o.frameRate]||1;s=c.maxBitRate*p*t,i=c.minBitRate*p*t,r.setOptionBitrate(s,i)}})}},{key:"exchangeHandler",value:function(e,t,r,a){var n=this,o=n.pc,s=n.im,i=n.PubResourceCache,d=n.User,c=e.publishList,p=e.sdp;o.setOffer(a),o.setAnwser(p),je.log(X.STREAM_HANDLER,{msg:"exchangeHandler set sdp"});var m=n.getUris(c);n.appendStreamId(t);var l=function(e){var r=t.id,a=i.get(r)||[],n=w.isEqual(e,Et.PUBLISH);n&&(a=m);var s=o.getStreamId(t),d=function(e){var t=e.msid;return w.isEqual(t,s)},c=w.filter(a,function(e){return d(e)});// 第一次 publish 过滤后 tempUris 为空，使用默认值
return w.isEmpty(c)?m:c}(r);n.updateTrackState(t,l,m);var g=s.getMessage(r,{uris:l});return d.set(d.SET_USERINFO,m,!0,g),i.set(t.id,m)}},{key:"compare",value:function(){var e=this.im,t=this.pc,r=this.DataCache,a=function(e){var t={};return w.forEach(e,function(e){var r=e.uris;w.forEach(r,function(e){var r=e.msid,a=t[r]||[];a.push(e),t[r]=a})}),t},n=function(t,r,a,n){Me({id:r,uris:a},function(r){return w.isFunction(n)?n(r):void e.emit(t,r)})},o=function(r,o){r=a(r),o=a(o);var s=w.clone(r);w.forEach(o,function(a,o){/** 
             * 包含本地资源说明流没有变化，删除 tempLocalUsers，且需比对 track 变化，state 有差异，以 remoteUsers 为准
             * 未包含说明是新发布资源，触发 published 事件 
             * 遍历后 tempLocalUsers 还有数据认为是取消发布
             */var i=(o in r),d=t.getStreamSymbolById(o),c=E(d,1),p=c[0],m=e.getUser(),l=m.id,g=w.isEqual(l,p);if(i){delete s[o];var u=w.toJSON(a),R=r[o],S=w.toJSON(R);w.isEqual(u,S)||n("",p,a,function(t){be(t,function(t,r){e.emit(t,r)})})}else g||n(B.STREAM_PUBLISHED,p,a)}),w.forEach(s,function(e,r){var a=t.getStreamSymbolById(r),o=E(a,1),s=o[0];n(B.STREAM_UNPUBLISHED,s,e)})},s=function(t,r){var a=w.clone(t),n=w.toArray(r),o=e.getUser(),s=o.id;w.forEach(n,function(r){var n=E(r,1),o=n[0],i=(o in t),d=w.isEqual(s,o);je.log(X.STREAM_HANDLER,{msg:"stream:compareuser",currentUserId:s,remoteUserId:o,isInclude:i,localUsers:t}),i?delete a[o]:!d&&e.emit(B.ROOM_USER_JOINED,{id:o})}),a=w.toArray(a),w.forEach(a,function(t){var r=E(t,1),a=r[0];e.emit(B.ROOM_USER_LEFT,{id:a})})};e.getUsers().then(function(e){w.forEach(e,function(e){var t=e.uris;t=w.parse(t),w.extend(e,{uris:t})});var t=r.get(vt.USERS);s(t,e),o(t,e),r.set(vt.USERS,e)})}},{key:"reconnect",value:function(){var e=this,t=e.im,r=e.option,a=t.getRoomId();e.getBody().then(function(n){var o=w.tplEngine(Xe.SUBSCRIBE,{roomId:a});je.log(X.STREAM_HANDLER,{msg:"publish:reconnect:request",roomId:a,body:n});var s=De(t,r),i=n.sdp;return ot.post({path:o,body:n,headers:s}).then(function(t){je.log(X.STREAM_HANDLER,{msg:"publish:reconnect:response",roomId:a,response:t}),e.negotiate(i,t)},function(e){return je.log(X.STREAM_HANDLER,{msg:"publish:reconnect:response",roomId:a,error:e}),e})})}},{key:"isTrackExist",value:function(e,t){var r=this,a=r.DataCache,n=e.id,o=e.stream.tag,s=!1;return w.forEach(t,function(e){var t=r.getUId({id:n,stream:{tag:o,type:e}}),i=a.get(t)||{},d=i.uri;w.isUndefined(d)&&(s=!0)}),s}},{key:"publish",value:function(e){var t=this,r=t.pc,a=t.im,n=t.PublishStreamCache,o=t.StreamCache,s=t.option,i=e.stream;w.isArray(i)||(i=[i]);var d=e.id;w.forEach(i,function(t){var s=t.mediaStream,i=t.size,c=r.getStreamId({id:d,stream:t},i);o.set(c,s),n.set(c,s),w.isUndefined(s)||a.emit(We.PUBLISHED_STREAM,{mediaStream:s,user:e})});var c=we(e);a.emit(We.SEND_REPORT,{type:le.R2,name:V.STREAM_PUBLISH,content:{trackIds:c}}),r.addStream(e);var p=a.getRoomId();return w.deferred(function(n,o){r.createOffer(e).then(function(r){return t.getBody(r).then(function(i){var d=w.tplEngine(Xe.PUBLISH,{roomId:p});je.log(X.STREAM_HANDLER,{msg:"publish:request",roomId:p,user:e,body:i});var c=De(a,s);return Fe.info(Se.L_MSE_T,{url:d,roomId:p,body:i}),ot.post({path:d,body:i,headers:c}).then(function(o){var s=o.publishList,i=o.urls,d=o.clusterId;t.setBitrate(e,1);var c={};i=i||{},w.isArray(s)&&a.emit(We.SET_URIS,s),je.log(X.STREAM_HANDLER,{msg:"publish:response",roomId:p,user:e,response:o}),Fe.info(Se.L_MSE_R,{roomId:p,response:o}),t.exchangeHandler(o,e,Et.PUBLISH,r),c=w.extend(c,i),d&&ot.addClusterIdUrl(d),i.configUrl&&ot.setOption({mcuUrls:[Be(i.configUrl)]// 目前 server 要求加入 8080
}),n(c)},function(t){je.log(X.STREAM_HANDLER,{msg:"publish:response:error",roomId:p,user:e,error:t}),Fe.error(Se.L_MSE_E,{roomId:p,error:t}),o(t)})})})})}},{key:"unpublish",value:function(e){var t=this,r=t.im,a=t.pc,n=t.option,o=t.StreamCache,s=t.PublishStreamCache;e=w.clone(e);var i=a.getStreamId(e),d=o.get(i);d||(d=new MediaStream);var c=[],p=e,m=p.stream,l=w.clone(m),g=e,u=g.id;m=w.extend(m,{mediaStream:d}),c.push(m);var E=a.getStreamId({id:u,stream:l},Y.MIN),R=o.get(E);R&&(l=w.extend(l,{mediaStream:R}),c.push(l)),w.extend(e,{stream:c});var S=r.getRoomId();je.log(X.STREAM_HANDLER,{msg:"unpublish:start",roomId:S,user:e}),w.forEach(c,function(e){var t=e.mediaStream,r=t.getTracks();w.forEach(r,function(e){e.stop()});var a=t.id;s.remove(a)}),o.remove(i);var T=we(e);return r.emit(We.SEND_REPORT,{type:le.R2,name:V.STREAM_UNPUBLISH,content:{trackIds:T}}),a.removeStream(e).then(function(a){return t.getBody().then(function(o){var s=w.tplEngine(Xe.UNPUBLISH,{roomId:S});je.log(X.STREAM_HANDLER,{msg:"unpublish:request",roomId:S,user:e,body:o});var i=De(r,n);return Fe.info(Se.L_MSE_T,{url:s,roomId:S,body:o}),ot.post({path:s,body:o,headers:i}).then(function(r){je.log(X.STREAM_HANDLER,{msg:"unpublish:response",roomId:S,user:e,response:r}),Fe.info(Se.L_MSE_R,{roomId:S,response:r}),t.setBitrate(e,-1),t.exchangeHandler(r,e,Et.UNPUBLISH,a)},function(t){je.log(X.STREAM_HANDLER,{msg:"unpublish:response",roomId:S,user:e,error:t}),Fe.error(Se.L_MSE_E,{roomId:S,error:t})})})})}},{key:"publishDefault",value:function(e){var t=this;return Ot(e).then(function(r){var a=r.mediaStream,n={id:e.userId,stream:{tag:"RongCloudRTC",type:e.type,mediaStream:a}};return t.publish(n).then(function(){return w.Defer.resolve({mediaStream:a})})},function(t){return je.log(X.STREAM_HANDLER,{msg:"publishDefault:error",constraints:e,error:t}),w.Defer.reject(t)})}},{key:"subscribe",value:function(e,t){var r=this,a=r.pc,n=r.im,o=r.option,s=r.SubscribeCache,i=r.SubPromiseCache,d=r.DataCache,c=e.id,p=e.stream,m=p.tag,l=p.type,g=s.get(c)||[],u=[J.VIDEO,J.AUDIO];if(w.isEqual(l,J.AUDIO_AND_VIDEO)||(u=[l]),r.isTrackExist(e,u)){var E=q.Inner;return w.Defer.reject(E.STREAM_TRACK_NOT_EXIST)}// let isTypeEnabled = (type) => {
//   return types.indexOf(type) !== -1;
// };
w.forEach(u,function(e){var t={id:c,stream:{tag:m,type:e}},a=r.getUId(t),n=d.get(a),o=!0;w.forEach(g,function(t){var r=t.type,a=t.tag;Ue(a)&&(m=pe);var n=w.isEqual(e,r)&&w.isEqual(m,a);n&&(o=!1)}),o&&!w.isUndefined(n)&&(n=w.clone(n),n=w.rename(n,{mediaType:"type"}),n.type==J.VIDEO&&(n.simulcast=Y.MIN),n.state=W.ENABLE,g.push(n))});var R=n.getRoomId(),S=w.tplEngine(Xe.SUBSCRIBE,{roomId:R}),T=!1;(0<s.getKeys().length||0<r.PublishStreamCache.getKeys().length)&&(S=w.tplEngine(Xe.ONLY_SUBSCRIBE,{roomId:R}),T=!0),s.set(c,g);var _=we(e);return n.emit(We.SEND_REPORT,{type:le.R2,name:V.STREAM_SUBSCRIBE,content:{trackIds:_}}),w.deferred(function(s,d){var c=r.getSubPromiseUId(e);i.set(c,{resolve:s,reject:d,type:l}),r.getBody().then(function(s){var d=s.sdp,c=De(n,o),p={path:S,body:s,headers:c};// let url = utils.tplEngine(Path.SUBSCRIBE, {
//   roomId
// });
je.log(X.STREAM_HANDLER,{msg:"subscribe:request",roomId:R,reqOption:p}),Fe.info(Se.L_MSS_T,{url:S,roomId:R,reqOption:p}),ot.post(p).then(function(r){// pc.setOffer(offer);
var n=r.sdp,o=r.clusterId;o&&ot.addClusterIdUrl(o),T?a.setRemoteAnwser(n).then(t).catch(t):(a.setOffer(d),a.setAnwser(n).then(t).catch(t)),je.log(X.STREAM_HANDLER,{msg:"subscribe:response:stream:not:arrive",roomId:R,user:e,response:r}),Fe.info(Se.L_MSS_R,{roomId:R,response:r})},function(t){je.log(X.STREAM_HANDLER,{msg:"subscribe:response:error",roomId:R,user:e,error:t}),Fe.error(Se.L_MSS_E,{roomId:R,error:t});var a=r.getSubPromiseUId(e),n=i.get(a);w.isUndefined(n)||n.reject(t)})})})}},{key:"unsubscribe",value:function(e){var t=this,r=t.pc,a=t.im,n=t.option,o=t.SubscribeCache;if(w.isNull(r)||!o.get(e.id))return w.Defer.resolve();o.remove(e);var s=a.getRoomId();je.log(X.STREAM_HANDLER,{msg:"unsubscribe:start",roomId:s,user:e});var i=we(e);return a.emit(We.SEND_REPORT,{type:le.R2,name:V.STREAM_UNSUBSCRIBE,content:{trackIds:i}}),t.getBody().then(function(t){var o=w.tplEngine(Xe.UNSUBSCRIBE,{roomId:s});je.log(X.STREAM_HANDLER,{msg:"unsubscribe:request",roomId:s,user:e,body:t}),Fe.info(Se.L_MSS_T,{url:o,roomId:s,body:t});var i=De(a,n);// let { sdp: offer } = body;
return ot.post({path:o,body:t,headers:i}).then(function(t){je.log(X.STREAM_HANDLER,{msg:"unsubscribe:response",roomId:s,user:e,response:t}),Fe.info(Se.L_MSS_R,{roomId:s,response:t});// self.negotiate(offer, response);
var a=t.sdp;return r.setRemoteAnwser(a)},function(t){je.error(X.STREAM_HANDLER,{msg:"unsubscribe:response:error",roomId:s,user:e,error:t}),Fe.error(Se.L_MSS_E,{roomId:s,error:t})}).catch(function(t){je.error(X.STREAM_HANDLER,{msg:"unsubscribe:response:error",roomId:s,user:e,error:t})})})}},{key:"resize",value:function(e){var t=this,r=t.im,a=t.pc,n=t.option,o=t.SubscribeCache,s=e.stream.size,i=e.id,d=o.get(i);if(w.isUndefined(d))return w.Defer.reject(q.Inner.STREAM_NOT_EXIST);var c=r.getRoomId();return je.log(X.STREAM_HANDLER,{msg:"resize:start",roomId:c,user:e}),t.getBody().then(function(t){var o=a.getStreamId(e),i=w.filter(d,function(e){var t=e.msid;return w.isEqual(o,t)})[0];if(!i){var p=q.Inner.STREAM_NOT_EXIST;return je.log(X.STREAM_HANDLER,{msg:"resize:response",roomId:c,user:e,error:p}),w.Defer.reject(p)}var m=i.msid;w.forEach(t.subscribeList,function(e){w.isEqual(e.msid,m)&&w.extend(e,{simulcast:s})});var l=w.tplEngine(Xe.RESIZE,{roomId:c});je.log(X.STREAM_HANDLER,{msg:"resize:request",roomId:c,user:e,body:t});var g=De(r,n);return ot.post({path:l,body:t,headers:g}).then(function(t){je.log(X.STREAM_HANDLER,{msg:"resize:response",roomId:c,user:e,response:t})},function(t){je.log(X.STREAM_HANDLER,{msg:"resize:response",roomId:c,user:e,error:t})})})}},{key:"get",value:function(e){e=e||{};var t=e,r=t.screen;return r?Dt(e):Ot(e)}/**
       * 设置混流
       * @param {Object} config 混流配置
       * @param {Array} publishUrls 直接推流地址配置
       */},{key:"setMixConfig",value:function(e,t){var r=this.im,a=this.option,n=ot.getOption().mcuUrls||[];if(w.isEmpty(n))return w.Defer.reject(q.Inner.MUST_PUBLISHED_BEFORE_SETMIXCONFIG);var o=Xe.LIVE_CONFIG,s=r.getSessionId(),i=De(r,a,{SessionId:s});i.AppKey=i["App-Key"],delete i["App-Key"];var d=Le(e,t);return je.log(X.STREAM_HANDLER,{msg:"setMixConfig:request",headers:i,body:d}),Fe.info(Se.A_SMC_T,{url:o,body:d}),ot.post({urls:n,path:o,body:d,headers:i}).then(function(e){return je.log(X.STREAM_HANDLER,{msg:"setMixConfig:response",headers:i,body:d,response:e}),Fe.info(Se.A_SMC_R,{response:e}),e},function(e){return je.log(X.STREAM_HANDLER,{msg:"setMixConfig:error",headers:i,body:d,error:e}),Fe.error(Se.A_SMC_E,{error:e}),e})}},{key:"trackHandler",value:function(e,t,r){var a=this,n=e.stream;n=n||{};var o=a.pc,s=a.im,i=a.StreamCache,d=o.getStreamId(e,n.size),c=i.get(d);if(c){var p=w.isEqual(t,J.AUDIO);t=p?"Audio":"Video";t=w.tplEngine("get{type}Tracks",{type:t});var m=c[t]();w.forEach(m,function(e){s.emit(We.TRACK_MODIFY,{id:e.id,isEnable:r}),e.enabled=r})}}},{key:"getFitUris",value:function(e,t,r){var a=this,n=a.PubResourceCache,o=a.pc,s=e.id,i=n.get(s)||[],d=o.getStreamId(e);return i=w.filter(i,function(e){var a=e.msid,n=e.mediaType,o=w.isEqual(d,a),s=w.isEqual(n,t),i=o&&s;return i&&w.extend(e,{state:r}),i}),i}},{key:"saveModify",value:function(e,t,r){var a=this,n=a.im,o=a.PubResourceCache,s=a.User,i=a.getFitUris(e,t,r);// uris 为空表示没有发布资源，不需要修改
if(!w.isEmpty(i)){var d=e.id,c=o.get(d),p=n.getMessage(Et.MODIFY,{uris:i});s.set(s.SET_USERINFO,c,!0,p)}return w.Defer.resolve()}},{key:"isCurrentUser",value:function(e){var t=this.im,r=t.getUser(),a=r.id;return w.isEqual(e.id,a)}},{key:"modifyTrack",value:function(e,t,r,a){var n=this;return n.trackHandler(e,t,a),n.isCurrentUser(e)&&(Lt.set(t,r),n.saveModify(e,t,r)),w.Defer.resolve()}},{key:"mute",value:function(e){return this.modifyTrack(e,J.AUDIO,W.DISBALE,!1)}},{key:"unmute",value:function(e){return this.modifyTrack(e,J.AUDIO,W.ENABLE,!0)}},{key:"enable",value:function(e){return this.modifyTrack(e,J.VIDEO,W.ENABLE,!0)}},{key:"disable",value:function(e){return this.modifyTrack(e,J.VIDEO,W.DISBALE,!1)}},{key:"destroy",value:function(){var e=this,t=e.pc,r=e.im;e.clear(),t&&(t.close(),r.emit(We.PEERCONN_DESTROYED))}}]),e}(),bt={init:function(){window.adapter=d()}},kt=function(e){/* 
      let option = {
        url: 'mediaServer path',
        RongIMLib
      };
    */function t(e,d){m(this,t);var p=u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));bt.init();var l=p,g=new Ct(e),E={room:a(g,e),stream:r(g,e,d),storage:n(g),message:o(g),device:s(g),report:c(g)};i(g,e);var R=e.RongIMLib;w.extend(l,{RongIMLib:R,option:e,destroyed:!1,im:g,RequestHandler:E,rongRTC:d});var S=function(){w.forEach(G,function(e){var t=e.name;l.off(t)})};// 离开房间时, 需将 client 绑定的 RoomEvents 事件取消, 否则重新加入房间会重复触发前后多次的监听
w.forEach(G,function(e){var t=e.name;g.on(t,function(e,r){l.emit(t,r,e)})}),g.on(We.JOINED,function(){var t=g.getMSUrl(),r=e.url;if(w.isEmpty(r)||ot.addUrl(r),w.isEmpty(t)){var a=q.Inner,n=a.ENGINE_ERROR;return l.emit(B.RTC_ERROR,n)}ot.isUrlsExisted(t)||ot.addUrls(t),l.emit(B.RTC_MOUNTED)}),g.on(We.LEFT,function(){S(),l.emit(B.RTC_UNMOUNTED)}),g.on(We.ERROR,function(e,t){l.emit(B.RTC_ERROR,t,e)}),g.on(B.MESSAGE_RECEIVED,function(e,t){l.emit(B.MESSAGE_RECEIVED,t,e)}),g.on(B.REPORT_SPOKE,function(e,t){l.emit(B.REPORT_SPOKE,t,e)}),g.on(B.MONITOR_STATS,function(e,t){l.emit(B.MONITOR_STATS,t,e)});var T=function(e){var t=function(t){return w.some(e,function(e){var r=e.mediaType;// return utils.isEqual(msType, mediaType) && utils.isEqual(state, StreamState.ENABLE);
// 只区分 track 不区分
return w.isEqual(t,r)})},r=J.NODE,a=t(J.AUDIO),n=t(J.VIDEO);return a&&(r=J.AUDIO),n&&(r=J.VIDEO),n&&a&&(r=J.AUDIO_AND_VIDEO),r},_=function(e,t,r){var a=t.id,n=t.stream,o=n.tag,s=n.uris,i=T(s);l.emit(e,{id:a,stream:{tag:o,type:i}},r)};return g.on(B.STREAM_PUBLISHED,function(e,t){_(B.STREAM_PUBLISHED,t,e)}),g.on(B.STREAM_UNPUBLISHED,function(e,t){_(B.STREAM_UNPUBLISHED,t,e)}),g.on(B.STREAM_DISABLED,function(e,t){_(B.STREAM_DISABLED,t,e)}),g.on(B.STREAM_ENABLED,function(e,t){_(B.STREAM_ENABLED,t,e)}),g.on(B.STREAM_MUTED,function(e,t){_(B.STREAM_MUTED,t,e)}),g.on(B.STREAM_UNMUTED,function(e,t){_(B.STREAM_UNMUTED,t,e)}),p}return g(t,e),l(t,[{key:"exec",value:function(e){var t=this,r=t.im,a=t.rongRTC,n=Ne(a);if(t.isDestroyed())return w.Defer.reject(q.Inner.INSTANCE_IS_DESTROYED);if(!r.isSupportRTC())return w.Defer.reject(q.Inner.IM_SDK_VER_NOT_MATCH);var o=e.type,s=e.args,i=e.event,d=[V.ROOM_JOIN,V.DEVICE_GET,V.STREAM_GET],c=!w.isInclude(d,i),p=[V.STREAM_SUBSCRIBE,V.STREAM_UNSUBSCRIBE],m=w.isInclude(p,i);// 判断是否链接 IM
if(!r.isIMReady()&&c)return w.Defer.reject(q.Inner.IM_NOT_CONNECTED);// 判断是否加入房间
if(c&&!r.isJoined()&&!n)return w.Defer.reject(q.Inner.RTC_NOT_JOIN_ROOM);// 判断观众端是否非法调用
if(n&&!m)return w.Defer.reject(q.Inner.WRONG_AUDIENCE_EVENT);var l=this.RequestHandler;je.log(o,{func:i,type:Q.REQUEST,args:s});var g=l[o].dispatch(i,s);return w.isPromise(g)?g.then(function(e){return je.log(o,{func:i,type:Q.RESPONSE,result:e}),e},function(e){throw je.error(o,{func:i,type:Q.RESPONSE,error:e}),e=w.rename(e,{resultCode:"code"}),e}):g}},{key:"isDestroyed",value:function(){return this.destroyed}},{key:"extendOption",value:function(e){var t=this;w.extend(t.option,e)}},{key:"destroy",value:function(){var e=this;w.extend(e,{destroyed:!0}),e.teardown(),e.im.teardown()}}]),t}(qe),Ut=function(){function e(t){m(this,e),t=t||{};var r=this,a=r.getClient(),n={type:$.ROOM};w.extend(n,t),w.extend(r,{option:n,client:a})}return l(e,[{key:"set",value:function(e,t,r){var a=Ie({key:e,value:t},["key","value"]),n=a.isIllegal,o=a.name;if(n){var s=Ae(o);return w.Defer.reject(s)}var i=this,d=i.client,c=i.option.type;return d.exec({event:V.STORAGE_SET,type:"storage",args:[c,e,t,r]})}},{key:"get",value:function(e){var t=Ie({key:e},["key"]),r=t.isIllegal,a=t.name;if(r){var n=Ae(a);return w.Defer.reject(n)}var o=this,s=o.client,i=o.option.type;return s.exec({event:V.STORAGE_GET,type:"storage",args:[i,e]})}},{key:"remove",value:function(e,t){var r=Ie({key:e},["key"]),a=r.isIllegal,n=r.name;if(a){var o=Ae(n);return w.Defer.reject(o)}var s=this,i=s.client,d=s.option.type;return i.exec({event:V.STORAGE_REMOVE,type:"storage",args:[d,e,t]})}}]),e}(),Pt=function(){function e(t){m(this,e);var r=this,a=r.getClient(),n={received:function(){}};w.extend(n,t),w.extend(r,{client:a,option:n}),w.forEach(F,function(e){var t=e,r=t.name,o=t.type;a.on(r,function(t,r){e=n[o]||w.noop,e(r,t),je.log(X.MESSAGE,{event:o,message:r})})})}return l(e,[{key:"send",value:function(e){var t=Ie(e,["name","content"]),r=t.isIllegal,a=t.name;if(r){var n=Ae(a);return w.Defer.reject(n)}var o=this,s=o.client;return s.exec({event:V.MESSAGE_SEND,type:"message",args:[e]})}}]),e}(),Nt=function(){function e(){m(this,e);var t=this,r=t.getClient();w.extend(t,{client:r})}return l(e,[{key:"get",value:function(){var e=this.client;return e.exec({event:V.DEVICE_GET,type:"device",args:[]})}}]),e}(),xt=function(){function e(t){m(this,e);var r=this,a=r.getClient(),n={received:function(){}};w.extend(n,t),w.extend(r,{client:a,option:n}),w.forEach(H,function(e){var t=e,r=t.name,o=t.type;a.on(r,function(t,r){e=n[o]||w.noop,e(r,t)})})}return l(e,[{key:"start",value:function(e){var t=this.client;return t.exec({event:V.REPORT_START,type:"report",args:[e]})}},{key:"stop",value:function(){var e=this.client;return e.exec({event:V.REPORT_STOP,type:"report",args:[]})}}]),e}(),wt=function e(t){m(this,e);var r=this,a=r.getClient(),n={stats:function(){}};w.extend(n,t),w.extend(r,{client:a,option:n}),w.forEach(K,function(e){var t=e,r=t.name,o=t.type;a.on(r,function(t,r){e=n[o]||w.noop,e(r,t)})})},Bt=function(){function e(t){m(this,e);var r=this,a={url:"",debug:!1,bitrate:{max:0,min:0,start:0},mode:ne.RTC,liveRole:se.ANCHOR,liveType:oe.AUDIO_AND_VIDEO,setUserId:!0,created:function(){},mounted:function(){},unmounted:function(){},destroyed:function(){},error:function(){}};w.extend(a,t);var n=a.logger,o=a.debug,s=q.Outer;w.isFunction(n)&&je.watch(n,!0),o&&je.watch(function(e){w.Log.log(e)}),w.extend(r,{Room:He,Stream:Ke,Storage:Ut,StreamType:J,StreamSize:Y,StorageType:$,Mode:ne,ROLE:se,LiveType:oe,LayoutMode:ie,RenderMode:de,Resolution:_e,RongRTCVideoFps:fe,Message:Pt,Device:Nt,Report:xt,Monitor:wt,ErrorType:s,option:a}),Fe.init(t.RongIMLib);var i=new kt(a,r);w.forEach([He,Ke,Ut,Pt,Nt,xt,wt],function(e){e.prototype.getClient=function(){return i}}),w.extend(r,{client:i});var d=a.created,c=a.mounted,p=a.unmounted,l=a.error;d(),je.log(X.LIFECYCLE,{state:"created"}),i.on(B.RTC_MOUNTED,function(){c(),je.log(X.LIFECYCLE,{state:"mounted"})}),i.on(B.RTC_UNMOUNTED,function(){p(),je.log(X.LIFECYCLE,{state:"unmounted"})}),i.on(B.RTC_ERROR,function(t,e){if(t)throw new Error(t);l(e)})}return l(e,[{key:"changeLiveRole",value:function(e){var t=this,r=t.option.liveRole,a=t.client.im;return xe(e,r)?(t.option.liveRole=e,a.emit(We.CHANGE_ROLE,{oldRole:r,newRole:e}),w.Defer.resolve()):w.Defer.reject(q.Inner.WRONG_ROLE_SETTING)}},{key:"getLiveRole",value:function(){var e=this.option.liveRole;return e}},{key:"getClientId",value:function(){return ve()}},{key:"destroy",value:function(){var e=this.option.destroyed,t=this.client;e(),t.destroy(),je.log(X.LIFECYCLE,{state:"destroyed"})}}]),e}();return w.extend(Bt,{StreamType:J,StreamSize:Y,StorageType:$,Mode:ne,ROLE:se,LiveType:oe,LayoutMode:ie,RenderMode:de,Resolution:_e,RongRTCVideoFps:fe}),Bt});
